/*Volume Price Analysis AFL - VPA Version 5.0 - 22-8-2021 
Edit by binhnt.tamviet@gmail.com
 Revision Details
 V-2.0 AFL - fully re written for clarity, Minor bugs removed
 V-2.1 support AND resistance line added
 V-2.2 Commentary for support AND resistance line breaks Added.
 V-2.3 Revision detail- High Volume Lines added
 V-2.4 Toggle switch for plotting S/R, High Volume AND Trend lines added
 V-2.5 Bar coloring option included - VSA based OR Trend Based
 V-3.0 Trend detection Method changed to "Random Walk"
 V-3.1 exploration AddedClosePos
 V-3.2 Bug in Exploration fixed
 V-4.0 Revamped the formulas for all signals - Especially the No Demand Bar Defn. 
       Reduced unnecessary signals
       Low volume Test signals formula improved
       New signal discription for daily signals added like  "Move indicates Strength or weakness".
       Effort up or down failure also added
       Up and Down Arrows included to indicate change of sentiment.
 V-5.0 Removed some coding issues
       Added Two Bar reversals
       Added Strength Bar
       Added Dash Board for Buy and Sell Pressure
       Added Vwap 
       Added 3 pema and 200 ma plotting  options
       Adde additiona; options for plotting Candle sticks and other options for color
       Added Ribbons for Trend  
 V-5.1 Them cac chi bao (Edit by Binhnt.tamviet@gmail.com)
       1. Hien thi Full thong tin ve Gia va Khoi luong
       2. Phan tich xu huong hien tai
       3. Chon che do Bar/Candle (chon che do hien thi cac tin hieu canh bao VSA)
       4. Them tu dong ve cac duong trung binh dong EMA5,10,20,30 MA50,100,150,200
       5. Them tu dong ve duong Ho tro, Khang cu gan nhat
       6. Them tuy chinh cac muc Ho tro, Khang cu
       7. Them tu dong ve Hop Darvas 
       8. Them tu dong ve Auto Trendline - duong xu huong gan nhat
       9. Dashboard Bang do thi ap luc Cung Cau
       10. Ichimoku Kinko Hyo (tu hien thi tin hieu Mua Ban theo Ichimoku)
       11. Them tu dong ve duong Fibonacci Internal + External Retracements theo click chuot
       12. Them chi bao Volume
       13. Them chi bao Volume High Line
       14. Them chi bao Volume At Price
       15. Them chi bao  VWAP
       16. Bands
       17. Them tu dong ve duong Bollinger Bands
       18. Them tu dong ve dai bang Keltner Bands system 
       19. Them chi bao Center of Gravity - Trung tam trong luc
       20. He thong mua ban Con Rua - Turtle trading System
       21. Them chi bao Psar
       22. Them chi bao Zig zag
       23. Them chi bao  GAP
       24. Tin hieu Mua Ban luot song ngan han
       25. Tin hieu mua ban theo dieu kien Buy4 Sell4 (dung cho ngan han) 
       26. Tin hieu mua ban theo dieu kien Buy4 Sell8 (dung cho ngan han)
       27. Tin hieu mua ban theo dieu kien Buy8 Sell8 (dung cho ngan han)  
       28. Tin hieu mua ban theo ATR
      
  
       
       
//===================Version V.5.1 ======================
*/
       

//====================================================================================|
//                      Begin                                                         |
//====================================================================================|
SetChartOptions(0,chartShowArrows|chartShowDates);
GraphXSpace=Param("GraphXSpace - Zoom Chart",30,5,300,5);   //Chon che do Zoom

/*
//====================================================================================|
//                      Color of outer border (Chon mau phong nen mau Den)                           
//====================================================================================|

SetChartBkColor(ParamColor("Outer panel",colorBlack)); // color of outer border 
SetChartBkGradientFill( ParamColor("Inner panel upper",colorBlack),ParamColor("Inner panel lower",colorBlack));

//End chon phong nen 
*/     


//|============================================================================================|
//|                        1. Hien thi gia thi truong  
//|============================================================================================|   

//|Hien thi ten co phieu va gia dong cua|

_SECTION_BEGIN("Thong tin Gia");

YC       = TimeFrameGetPrice("C",inDaily,-1);
DD       = Prec(C-YC,2);
xx       = Prec((DD/YC)*100,2);



if (ParamToggle( "* Hien thi Thong tin Gia",  "OFF|ON", 0 ))
{

fos      = Param("Font Size",25,1,100,1);
nus      = Param("Number Size",10,1,100,1);
cclor    = ParamColor("Color",colorCustom9);
Hor      = Param("Horizontal Position",50,1,1000,1);  // Vi tri ngang
Ver      = Param("Vertical Position",1,1,1000,1);    // Vi tri doc

GfxSelectFont("Times New Roman", fos, 700, italic = True, underline = False, True ); //chon Fonts
GfxSetBkMode( colorWhite );  // Chon mau nen
GfxSetTextColor( cclor);  // Hien thi mau chu
GfxTextOut( Name(), Hor+700,Ver -10 );  //|Hien thi ten co phieu
GfxTextOut(""+C,Hor+785 , Ver-10 ); //|Hien thi gia dong cua

//|Hien thi % thay doi gia
GfxSelectFont("Times New Roman", nus, 700, italic =True, underline = False, True );
GfxTextOut(""+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+" ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)", Hor+785, Ver+30 ); //|Hien thi thay doi gia dong cua


}


_SECTION_END();

//|    END Hien thi gia thi truong  



//=========================================================================|
//                    2. Trend Analysis Module - Random Walk Method  
//                        Phan tich Xu huong                               |
//=========================================================================|

_SECTION_BEGIN("2. Phan tich Trend xu huong");



//=========================================================================|
//                    Slope Calculation                                    |
//=========================================================================|
 sma5                 =  MA(C,5);
 trendLongTerm     =  LinRegSlope(sma5,50) ; //lts      = linreg(src, 40, 0)
 trendMediumTerm   =  LinRegSlope(sma5,20) ; //mts      = linreg(src, 20, 0)
 trendShortTerm    =  LinRegSlope(sma5,10)  ;//sts      = linreg(src, 3, 0)
 tls               =  LinRegSlope(sma5,5);
 

 //========================Trend Estimation ================================


 minperiodsRWIst = Param ( "Chon Min vung dao dong ngan", 5 , 1 , 30 , 1); 
 maxperiodsRWIst = Param ( "Chon Max vung dao dong ngan", 10 , 1 , 50 , 1); 
 
 k      = RWI(minperiodsRWIst, maxperiodsRWIst);    //k      = RWIHi-RWILo
 Ground = RWIHi (minperiodsRWIst, maxperiodsRWIst); //Vuot dinh ngan han - Xu huong ngan han tang - upimd       = IIf(ground > 1, 1,0); //Xu huong ngan han: TANG - UP    OK
 Sky    = RWILo (minperiodsRWIst, maxperiodsRWIst); //Pha day ngan han - xu huong ngan han giam  - dnimd       = IIf(sky > 1, 1, 0);   //Xu huong ngan han: GIAM - DOWN  OK




 minperiodsRWIlt = Param ( "Chon Min vung dao dong dai", 11 , 1 , 200 , 1); 
 maxperiodsRWIlt = Param ( "Chon Max vung dao dong dai", 50 , 1 , 200 , 1);  

 j      = RWI(minperiodsRWIlt, maxperiodsRWIlt);  //j      = RWILHi-RWILLo

 j2     = RWIHi (minperiodsRWIlt, maxperiodsRWIlt); //Vuot dinh trung han - Xu huong trung han tang - upminor     = IIf(j2>1,1,-1); //Xu huong trung han: TANG - UP     OK
 k2     = RWILo (minperiodsRWIlt, maxperiodsRWIlt); //Pha day trung han   - xu huong trung han giam - dnminor     = IIf(k2>1,1,-1); //Xu huong trung han:     GIAM - DOWN
 


 // The followign section check the diffeent condition of the RWi above and below zero. In oder to check which trend is doing what
 ja     = Cross(j,1); //Giao cat j vuot len dinh tren ngan han
 jb     = Cross(1,j); //Giao cat j giam xuong dinh tren ngan han
 jc     = Cross(-1,j); //Giao cat j voi day ngan han                bao muon hon k2a
 jd     = Cross(j,-1); //Giao cat j quay lai day ngan han
 j2a    = Cross(j2,1); //vuot dinh trung han
 j2b    = Cross(1,j2); // quay tro lai dinh trung han
 k2a    = Cross(k2,1); //pha dinh trung han             ok bao som hown jc
 k2b    = Cross(1,k2); //quay tro lai day trung han
 


//Define the Major, Minor and Immediate trend Sttatus

upmajoron   = j > 1 AND Ref(ja,-1);
dnmajoron   = j < -1 AND Ref(jc,-1);
upminoroff  = j < 1 AND Ref(jb,-1); //Xu huong TANG trung han truoc do co the ket thuc   OK
dnminoroff  = j > -1 AND Ref(jd,-1); //Xu huong GIAM trung han truoc do co the ket thuc  OK 

upminoron   = j2 > 1 AND Ref(j2a,-1); 
dnminoron   = k2 > 1 AND Ref(k2a,-1); 
upmajoroff  = j2 < 1 AND Ref(k2a,-1); //Xu huong TANG dai han truoc do co the ket thuc   
dnmajoroff  = k2 < 1 AND Ref(k2b,-1); //Xu huong GIAM dai han truoc do co the ket thuc   

//Ngan han
upimd       = IIf(ground > 1, 1,0); //Xu huong ngan han: TANG - UP    OK
dnimd       = IIf(sky > 1, 1, 0);   //Xu huong ngan han: GIAM - DOWN  OK

//Trung han
upminor     = IIf(j2>1,1,-1); //Xu huong trung han: TANG - UP     OK
dnminor     = IIf(k2>1,1,-1); //Xu huong trung han:     GIAM - DOWN

//Dai han
upmajor     = IIf(j>1,1,IIf(j<(-1),-1,0));  
updaihan    = upminor AND  C > MA(C,100) AND C > MA(C,150) AND C > MA(C,200) AND   MA(C,10) > MA(C,200);
downdaihan  = dnminor AND C < MA(C,100) AND C < MA(C,150) AND C < MA(C,200)  AND   MA(C,10) < MA(C,200);
trenddaihan = IIf(updaihan,1,IIf(downdaihan,-1,0));  





_SECTION_END();

//=========================================================================|
// END Analysis Module - Random Walk Method           |
//=========================================================================|


//=========================================================================|
//                    VPA Basic Module                                     |
//=========================================================================|
_SECTION_BEGIN("VPA Basic Module");

    
//===================== Basic Definitions =======================================
volAvg			=	MA(V,30);
volMean 		= 	StDev(volAvg,30); 
volUpBand3 		= 	volAvg + 3*volMean; 
volUpband2 		= 	volAvg + 2*volMean;; 
volUpBand1 		= 	volAvg + 1*volMean;; 
volDnBand1 		= 	volAvg -1*volMean; 
volDnBand2 		= 	volAvg -2*volMean; 
midprice		=	(H+L)/2;
spread			=	(H-L);
avgSpread		=	EMA(spread,40);
AvgSpreadBar    =  spread > Avgspread;//REVIEW
wideRangeBar	=	spread>(1.5*avgSpread);
narrowRangeBar	=	spread<(0.7*avgSpread);
lowVolume		=	V<Ref(V,-1) AND V<Ref(V,-2) AND V < VolAvg;// Third condition added
upBar		    =	C>Ref(C,-1); 
downBar			=	C<Ref(C,-1); 
highVolume		=	V>Ref(V,-1) AND Ref(V,-1)>Ref(V,-2);//REVIEW
closeFactor		=	C-L;
clsPosition		=	spread/(closeFactor+ 1e-9 );
closePosition	=	IIf(closeFactor==0,avgSpread,clsPosition);//????
Vb				=	V>volAvg OR V>Ref(V,-1);
upClose		    =	C>=((spread*0.7)+L);// close is above 70% of the Bar
downClose		=	C<=((spread*0.3)+L);// close is below the 30% of the bar
aboveClose		=	C>((spread*0.5)+L) ;// close is between 50% and 70% of the bar
belowClose		=	C<((spread*0.5)+L);// close is between 50% and 30% of the bar
midClose		=	C>((spread*0.3)+L) AND C<((spread*0.7)+L);// close is between 30% and 70% of the bar
veryLowClose	=	closePosition>4;//close is below 25% of the bar
veryHighClose	=	closePosition<1.35;// Close is above 80% of the bar
ClosePos		= 	IIf(C<=((spread*0.2)+L),1,IIf(C<=((spread*0.4)+L),2,IIf(C<=((spread*0.6)+L),3,IIf(C<=((spread*0.8)+L),4,5))));
                    // 1 = downclose, 2 = belowclose, 3 = MidClose, 4 = aboveClose, 5 = Upclose
Volpos			=  	IIf(V>volAvg*2,1,IIf(V>volAvg*1.3,2,IIf(V>= volAvg,3,IIf(V<volAvg AND V>volAvg*0.7,4,5))));
                    //// 1 = Very High, 2 = High, 3 = Above Average, 4 = Less than Average, 5 = Low
freshGndHi      =  IIf(H == HHV(H,5),1,0);
freshGndLo      =  IIf(L == LLV(L,5),1,0);
//=================New code - FOM =========================
//---------------No Movement Bar --------------------
//- Thanh gia ko di chuyen khi co su thay doi Volume cao
pm       = abs(Close-Open); // price move
pma      = EMA(pm,40); // avg price move
Lpm	     = pm<(0.5*pma); // small price move
bw       =  IIf(C >O, H-C,H-O); // wick
bwh      =  bw >= 2*pm; // big wick
fom1     =  (Volume > 1.5 * volAvg)  AND Lpm; // high volume not able to move the price - Volume cao nhung gia ko di chuyen nhieu - Diem yeu

//---------------Two Bar Revrsal  Dowm side - 2 thanh gia dao chieu trong xu huong giam --------------------
//*******************Diem Manh***************************************
tbcd    =  Ref(C,-1) <  Ref(C,-5) AND Ref(C,-1) <  Ref(C,-4) AND Ref(C,-1) <  Ref(C,-3) AND Ref(C,-1) <  Ref(C,-2); //yesterday bar lower than last 4 bars -Gia dong cua hom qua thap hon 4 ngay truoc no (Ðang giam gia)
tbc1    =  L < Ref(L,-1)  AND H > Ref(H,-1);// today bar shadoes yesterday bar - Nen nhan chim
tbc1a   = L < Ref(L,-1)  AND C > Ref(C,-1); // Nen xuyen thau
tbc2    = tbcd ==1 AND tbc1 ==1  AND V>  1.2 * volAvg AND upClose;
tbc2a   = tbcd ==1 AND tbc1a ==1  AND V>  1.2 * volAvg AND upClose AND NOT tbc1;
tbc3    = tbcd ==1 AND tbc1 ==1  AND upClose AND V<= 1.2 *VolAvg;


//---------------- Two bar reversal Up side - 2 thanh gia dao chieu trong xu huong tang --------------------
//*******************Diem Yeu***************************************
tbcu   =  Ref(C,-1) >  Ref(C,-5) AND Ref(C,-1) >  Ref(C,-4) AND Ref(C,-1) >  Ref(C,-3) AND Ref(C,-1) >   Ref(C,-2); //Gia dong cua hom qua cao hon 4 ngay truoc do (Ðang tang gia)
tbc4   =  tbcu ==1 AND tbc1 ==1  AND V>  1.2 * volAvg AND downClose;
tbc5   =  tbcu ==1 AND tbc1 ==1  AND downClose AND V<= 1.2 * VolAvg;

_SECTION_END();


//======================================================================|
//                      VSA Signal generation                           |
//======================================================================| 
_SECTION_BEGIN("Signal Generation");
upThrustBar		=	wideRangeBar AND downClose  AND upimd==1 AND H>Ref(H,-1);//WRB and UHS and 
nut             =   wideRangeBar AND downClose  AND freshGndHi AND HighVolume;// NEW SIGNAL Upthrsut after a short up move
bc              =   wideRangeBar AND aboveclose AND V == HHV(V,60) AND upmajor==1;// NEW SIGNAL Nuying Climax
upThrustBarA	=	wideRangeBar AND (ClosePos==1 OR ClosePos==2) AND upminor>0 AND H>Ref(H,-1)AND (upimd>0 OR upmajor>0)AND VolPos <4;// after minor up trend
upThrustBartrue	=	wideRangeBar AND ClosePos==1 AND upmajor>0 AND H>Ref(H,-1)AND VolPos <4;//occurs after a major uptrend
upThrustCond1	=	Ref(upThrustBar,-1) AND downBar AND NOT narrowRangeBar ;
upThrustCond2	=	Ref(upThrustBar,-1) AND downBar AND VolPos == 2;
upThrustCond3	=	upThrustBar AND VolPos ==1;
topRevBar		=	Ref(V,-1)>volAvg  AND Ref(upBar,-1) AND Ref(wideRangeBar,-1) AND downBar AND downClose AND wideRangeBar AND upmajor>0 AND H==HHV(H,10);
PseudoUpThrust	=	Ref(upBar,-1) AND H>Ref(H,-1) AND Ref(V,-1)>1.5*volAvg AND downBar AND downClose AND  NOT upThrustBar;
pseudoUtCond	=	Ref(PseudoUpThrust,-1) AND downBar AND downClose AND NOT upThrustBar;
trendChange		=	Ref(upBar,-1) AND H==HHV(H,5)AND downBar AND (downClose OR midClose) AND V>volAvg AND upmajor>0 AND upimd>0 AND NOT wideRangeBar AND NOT PseudoUpThrust ;
noDemandBarUt	=	upBar AND narrowRangeBar AND lowVolume AND ClosePos> 3 AND ((upminor ==1 AND upimd ==1) OR (upminor ==1 AND upmajor == 1));//in a up market
noDemandBarDt	=	upBar AND narrowRangeBar AND lowVolume AND ClosePos> 3 AND (upminor == -1 OR upimd == -1);// in a down or sidewayss market
noSupplyBar		=	downBar AND narrowRangeBar AND lowVolume  AND ClosePos<3 AND ((upminor<1 AND upimd<1) OR (upminor>0 AND upimd<1));
lowVolTest		=   L==LLV(L,5) AND upClose AND lowVolume;//lowVolume AND L<Ref(L,-1) AND upClose;
lowVolTest1		= 	L==LLV(L,5) AND V<volAvg AND L<Ref(L,-1) AND upClose AND upminor>0 AND upmajor>0;// AND wideRangeBar;
lowVolTest2		= 	Ref(lowVolTest,-1) AND upBar AND upClose;
sellCond1		=	(upThrustCond1 OR upThrustCond2 OR upThrustCond3) ;
sellCond2		=	Ref(sellCond1,-1)==0;
sellCond		=	sellCond1 AND sellCond2;
strengthDown0	= 	upmajor<0 AND VolPos<4 AND Ref(downBar,-1) AND upBar AND ClosePos>3 AND upminor<0 AND upimd<=0;// strength after a long down trend
strengthDown	= 	VolPos<4 AND Ref(downBar,-1) AND upBar AND ClosePos>3 AND upimd<=00 AND upminor<0;// Strength after a down trend
strengthDown1	= 	upmajor<0 AND V>(volAvg*1.5) AND Ref(downBar,-1) AND upBar AND ClosePos>3 AND upminor<0 AND upimd<=0;//Strength after downtrend . High volume
strengthDown2	=	upimd<=0 AND Ref(V,-1)<volAvg  AND upBar AND veryHighClose AND VolPos<4;
buyCond1		= 	strengthDown OR strengthDown1;
buyCond			= 	upBar  AND Ref(buyCond1,-1);
stopVolume		= 	L==LLV(L,5)  AND (upClose OR midClose) AND V>1.5*volAvg AND upmajor<0;
revUpThrust		=	upmajor<0 AND upBar AND upClose AND V>Ref(V,-1) AND V>volAvg AND  wideRangeBar AND Ref(downBar,-1) AND Ref(downClose,-1) AND upminor<0;
effortUp		=	H>Ref(H,-1) AND L>Ref(L,-1) AND C>Ref(C,-1) AND C>=((H-L)*0.7+L) AND spread>avgSpread AND VolPos<4;//AND O<=((H-L)*0.3+L) 
effortUpfail	=	Ref(effortUp,-1) AND (upThrustBar OR upThrustCond1 OR upThrustCond2 OR upThrustCond3 OR (downbar AND AvgSpreadBar));
effortDown		=	H<Ref(H,-1) AND L<Ref(L,-1) AND C<Ref(C,-1) AND  C<=((H-L)*0.25+L) AND wideRangeBar AND VolPos<4;//O>=((H-L)*0.75+
effortDownFail  =    Ref(effortDown,-1) AND ((upbar AND AvgSpreadBar) OR revUpThrust OR Buycond1);
upflag          =    (Sellcond OR Buycond OR effortup OR effortupfail OR stopvolume OR effortdown OR effortdownfail OR revupthrust OR
                                    noDemandBarDt OR noDemandBarUt OR nosupplyBar OR lowVolTest	OR lowVolTest1 OR lowVolTest2 OR bc);
bullBar		   	=	(V>volAvg OR V>Ref(V,-1)) AND closePosition <2 AND upBar AND NOT upflag;
bearBar			=	vb  AND downClose AND downBar AND spread>avgSpread AND NOT upflag ;
sc              =      wideRangeBar AND belowClose AND V == HHV(V,60) AND upmajor== -1;// NEW SIGNAL Nuying Climax


//**************************************************************
//-------------------------- Strength - Weakness ----------------------------------------------------

 // Diem Manh
strength	= sc OR tbc2a OR tbc2 or effortDownfail OR 	strengthDown OR strengthDown1 OR strengthDown2 OR strengthDown0 OR effortUp   OR revUpThrust ;
// Diem Yeu
weakness	= bc or upThrustBartrue OR  upThrustBar OR upThrustCond1 OR upThrustCond2 OR upThrustCond3 OR PseudoUpThrust OR pseudoUtCond or effortUpfail or Sellcond OR  effortDown  OR tbc4  ;
//Dau hieu canh bao thay doi xu huong
vsachange   = trendChange or topRevBar or noDemandBarDt OR noDemandBarUt OR Fom1 OR tbc3 OR tbc5 or buyCond OR noSupplyBar  OR lowVolTest or lowVolTest1 or lowVolTest2  or stopVolume ; 
            
//**************************************************************

_SECTION_END();


//====================================================================================|
//              3. Plotting Module  -  Hien thi chon Chart: Bar | Candle                                         |
//====================================================================================|

_SECTION_BEGIN("3. Chon che do Chart: Bar | Candle | Line");

//VSA Bar 
//Bar coloring formula 1 _ Preferred - Based on VSA Strength
Vscolor=IIf(lowVolTest,colorTurquoise,IIf(lowVolTest2,colorPink,IIf(bc,colorDarkRed ,IIf(upThrustBar,colorYellow ,IIf(bullbar,colorLime ,
IIf(bearbar,colorRed,IIf(noDemandBarUT OR noDemandBarDt,colorWhite ,IIf(noSupplyBar,colorCustom12,IIf(upbar,colorGreen,IIf(downbar,colorOrange,colorBlue))))))))));

//Bar coloring formula 2 _  Based on Trend 
Trcolor=IIf(trendShortTerm>0 AND trendMediumTerm>0 AND trendLongTerm>0,colorLime,IIf(trendShortTerm>0 AND trendMediumTerm>0 AND trendLongTerm<0,colorGreen,
IIf(trendShortTerm>0 AND trendMediumTerm<0 AND trendLongTerm<0,colorPaleGreen,IIf(trendShortTerm<0 AND trendMediumTerm<0 AND trendLongTerm<0,colorRed,IIf(trendShortTerm<0 AND trendMediumTerm>0 AND trendLongTerm>0,colorPaleGreen,
IIf(trendShortTerm<0 AND trendMediumTerm<0 AND trendLongTerm>0,colorOrange,colorBlue))))));

//Bar coloring formula 3 _  Marar Histogram 
Vlp=Param("Khoang thoi gian xem lai Volume Bar Chart",150,20,300,10);
Vrg=MA(V,Vlp);// average volume
rg=(H-L);
arg=Wilders(rg,30);
Vh=V>Ref(V,-1) AND Ref(V,-1)>Ref(V,-2);
Cloc=C-L;
x=(H-L)/(Cloc+ 1e-9);
x1=IIf(Cloc == 0,arg,x);
Vb1 =V>Vrg OR V>Ref(V,-1);
ucls=x1<2;
dcls=x1>2;
mcls=x1<2.2 AND x1>1.8 ;
Vlcls=x1>4;
Vhcls=x1<1.35;
//upbar=C>Ref(C,-1); 
dnbar=C<Ref(C,-1); 
CloseUp =  C>Ref(C,-1);
Closedn =  C<Ref(C,-1);
VolUp   =  V>Ref(V,-1);
VolDn   =  V<Ref(V,-1);
bb1 = upbar AND CloseUp AND ucls AND L>Ref(L,-1);
bb2 = upbar AND VolUp;
bb3 = dnbar AND CloseDn AND VolDn;
bb4 = dnbar AND CloseDn AND C>Ref(L,-1);
db1 = dnbar AND CloseDn AND dcls;
db2 = dnbar AND VolUp  ;
db3 = upbar AND CloseDn AND VolUp;
db4 = upbar AND CloseDn AND C<Ref(L,-1) AND dcls;
db5 = upbar AND CloseUp AND ucls AND L<Ref(L,-1);
db6 = upbar AND CloseUp AND dcls;
bb=(bb1 OR bb2 OR bb3 OR bb4);
db=(db1 OR db2 OR db3 OR db4 OR db5 OR db6);
Mcolor = IIf(bb AND tls>0, colorLime,IIf(db AND tls<0,colorRed,colorWhite)) ; 

bubar = (upbar AND Close > Open AND spread > 0.3 * Avgspread);
bebar = (downbar AND Close < Open AND spread > 0.3 * Avgspread);
rngbar = (abs(C-O) < 0.2*(H-L)) OR (narrowRangeBar AND abs(C-O) < 0.5*(H-L)) ;

//Bar coloring formula 4 _ Price Action with Candle 
pacolor = IIf(rngbar, colorWhite,IIf(bubar, colorLime, IIf(bebar, colorRed,colorBlue)));

//Bar coloring formula 5 _  Back ground Strength
//-------------------------- Strength band ----------------------------------------------------
strengthbar	= 	strengthDown OR strengthDown1 OR strengthDown2 OR strengthDown0 OR bullBar OR effortUp OR upBar OR lowVolTest OR lowVolTest1 OR lowVolTest2 OR revUpThrust OR stopVolume;

weaknessbar	= 	upThrustBar OR upThrustCond1 OR upThrustCond2 OR upThrustCond3 OR PseudoUpThrust OR pseudoUtCond OR effortDown OR trendChange OR noDemandBarDt OR bearBar OR downBar OR noSupplyBar;

strength6	=	IIf(Ref(strengthbar,-5),1,IIf(Ref(weaknessbar,-5),-1,0));
strength5	=	IIf(Ref(strengthbar,-4),1,IIf(Ref(weaknessbar,-4),-1,0));
strength4	=	IIf(Ref(strengthbar,-3),1,IIf(Ref(weaknessbar,-3),-1,0));
strength3	=	IIf(Ref(strengthbar,-2),1,IIf(Ref(weaknessbar,-2),-1,0));
strength2	=	IIf(Ref(strengthbar,-1),1,IIf(Ref(weaknessbar,-1),-1,0));
strength1	=	IIf(strengthbar,1,IIf(weaknessbar,-1,0));

ConsolStrength = strength1+strength2+strength3+strength4+strength5+strength6;

//STrength Bar color
stmcolor=IIf(ConsolStrength==6,ColorRGB(0,80,0),IIf(ConsolStrength==5,ColorRGB(0,100,0),IIf(ConsolStrength==4,ColorRGB(0,140,0),
IIf(ConsolStrength==3,ColorRGB(0,180,0),IIf(ConsolStrength==2,ColorRGB(0,220,0),IIf(ConsolStrength==1,ColorRGB(0,245,0),
IIf(ConsolStrength==0 AND Ref(ConsolStrength,-1)>=0,ColorRGB(0,290,0),IIf(ConsolStrength==0 AND Ref(ConsolStrength,-1)<=0,ColorRGB(260,0,0),
IIf(ConsolStrength==-6,ColorRGB(60,0,0), IIf(ConsolStrength==-5,ColorRGB(100,0,0),IIf(ConsolStrength==-4,ColorRGB(140,0,0), 
IIf(ConsolStrength==-3,ColorRGB(180,0,0),IIf(ConsolStrength==-2,ColorRGB(220,0,0),IIf(ConsolStrength==-1,ColorRGB(245,0,0),colorBlack))))))))))))));

//Bar coloring formula 6 _ Price Action with Bar
 pabar = IIf(C>Ref(C,-1),colorLime,colorRed);
 

//***************Lua chon kieu hien thi Chart Candle - Line - Bar Close*************
//Chon mau sac thanh Bar

Colorup      = ParamColor( "UpColor Bar", colorBrightGreen );
Colordown    = ParamColor( "DownColor Bar", colorRed );
Colorsideway = ParamColor( "SidewayColor Bar", colorYellow );
//Change Color theo Gia so voi hom qua
Pcolor       = IIf(C>Ref(C,-1),Colorup,IIf(C<Ref(C,-1),Colordown,Colorsideway));
//Change Color theo bien dong Gia trong ngay
ColorPriceintraday      = ParamColor( "ColorPriceintraday", colorSeaGreen );
ChangePcolor = IIf(xx>=6,colorViolet,
//Gia san<6%
IIf(xx<=-6,colorTurquoise,
//Tang gia
IIf(xx>0 AND xx<6,colorLime,
//Giam gia
IIf(xx<0 AND xx>-6,colorRed,
//Tham chieu
colorGold))));

//Mau Line Color
LineColor    = ParamColor("Color - Mau chu CP", colorGold );
PStyle       = ParamStyle("Chart Style", styleThick );

//Xac dinh xu huong
UpTrend = C > ( LLV( L, 20 ) + 2 * ATR( 10 ) ) AND EMA( Close, 20 ) > EMA( Close, 40 );
DnTrend = C < ( HHV( H, 20 ) - 2 * ATR( 10 ) ) AND EMA( Close, 20 ) < EMA( Close, 40 );

//Change Color theo xu huong Gia - Neu Uptrend mau Xanh, Downtrend mau Cam, sideway mau trang
Colortrend = IIf( UpTrend, colorBlue, IIf( DnTrend, colorOrange, colorCustom11 ) ); 




//***************Lua chon kieu hien thi Chart*************
//Plot( Muc can ve, "Dat ten cho muc can ve", Chon mau sac, Chon kieu hien thi);

//------------------------------------------------------------------------------------------

SelectedChartCP = ParamList( "* Chon che do hien thi Bar | Candle", "Candle - Nen Nhat|Close Bar|Based Bar|Uptrend - Downtrend Bar|VSA Based Bar|Trend Based Bar|Marar Trend Based Bar|Strength Bars|PA Bars|Line", 0 );
                                                                      
                                                                      
switch ( SelectedChartCP )
{

//Nen Nhat
case "Candle - Nen Nhat":
//PlotOHLC( Open,  High,  Low,  Close, "", Pcolor, styleCandle | styleThick );
Plot(C, "Close", Pcolor , styleCandle | PStyle );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Bar Close
case "Close Bar":
PlotOHLC(Close,  High,  Low,  Close, "",  Pcolor, styleBar | PStyle);
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Bar Based
case "Based Bar":
PlotOHLC(Open,  High,  Low,  Close, "", Pcolor, styleBar | PStyle  );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Bar Uptrend - Downtrend
case "Uptrend - Downtrend Bar":
Plot(C, "Price",  Colortrend , styleBar | PStyle  );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Bar VSA Based
case "VSA Based Bar":
PlotOHLC(Open,  High,  Low,  Close, "", VScolor, styleCandle  | PStyle   );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Bar VSA Trend Based
case "Trend Based Bar":
PlotOHLC(Open,  High,  Low,  Close, "", Trcolor, styleCandle | PStyle );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Bar Marar Trend Based
case "Marar Trend Based Bar":
PlotOHLC(Open,  High,  Low,  Close, "", Mcolor, styleCandle | PStyle  );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Strength Bars
case "Strength Bars":
PlotOHLC(Open,  High,  Low,  Close, "", stmcolor, styleCandle   | PStyle  );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//PA Bars
case "PA Bars":
PlotOHLC(Open,  High,  Low,  Close, "", pabar, styleCandle | PStyle  );
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;

//Line
case "Line":
//Ve duong gia CP hien tai
PlotOHLC(Open,High,Low,Close,"",  LineColor, styleLine  | PStyle ); 
y = LastValue( C ); PlotText(  "           " + Name() +  ":  " +WriteVal(C,1.2)+ "  =  "+DD+"  ("+xx+"%)", BarCount+ 3 , y,ColorPriceintraday);
break;


}





_SECTION_END();

//END Plotting Module  -  Hien thi chon Chart: Bar | Candle 

//==========================================================================|
//                   So sanh RS voi Ticker                                          |
//==========================================================================|


_SECTION_BEGIN("So sanh RS voi Ticker");

//CP can so sanh
Ticker            = ParamStr  ("So sanh RS voi Ticker", "VNINDEX" );
ColorForeign      = ParamColor("Color Ticker", colorAqua );
StyleForeign      =  ParamStyle("Style Ticker",styleThick);
  
if (RSticker = ParamToggle( "*. Hien thi So sanh RS voi Ticker",  "OFF|ON", 0 ))
{

//Ve duong gia Ma so sanh
PlotOHLC(Foreign(Ticker,"Open"), Foreign(Ticker,"High"), Foreign(Ticker,"Low"), Foreign(Ticker,"Close"),Ticker, ColorForeign, styleLine |  StyleForeign| styleOwnScale);
y = LastValue( Foreign(Ticker,"Close") ); PlotText(  "_ " + Ticker +  ":  " +WriteVal(Foreign(Ticker,"Close"),1.2), BarCount+ 3 , y,ColorPriceintraday);


}


_SECTION_END();
//END So sanh RS voi Ticker 



//==========================================================================|
//                    4. Cac duong trung binh dong                  |
//==========================================================================|

_SECTION_BEGIN("4. Cac duong Trung binh dong");




//Chon muc gia Dong cua
tye  =   ParamList("1. Lua chon muc Gia","Close|Pivot = (H+L+C)/3" ,0);
pe = IIf(tye == "Close" , Close, (H+L+C)/3);

//Cac duong EMAs MAs
ema5  =  Param(" - EMA5",  5,   1, 500, 1);
ema10  = Param(" - EMA10", 10,  1, 500, 1);
ema20  = Param(" - EMA20", 20,  1, 500, 1);
ema30  = Param(" - EMA30", 30,  1, 500, 1);
ma50  =  Param(" - MA50",  50,  1, 500, 1);
ma100  = Param(" - MA100", 100, 1, 500, 1);
ma150  = Param(" - MA150", 150, 1, 500, 1);
ma200  = Param(" - MA200", 200, 1, 500, 1);

//Ve cac duong EMAs MAs

pema5  = EMA(pe,ema5);
pema10 = EMA(pe,ema10);
pema20 = EMA(pe,ema20);
pema30 = EMA(pe,ema30);
mma50  = MA (pe,ma50);
mma100 = MA (pe,ma100);
mma150 = MA (pe,ma150);
mma200 = MA (pe,ma200);





//                    //EMA va MA                         |
//==========================================================================|

//Ve EMA 5,10,20
if (plotema5_10_20  =   ParamToggle("1. EMAs 5,10,20","OFF|ON" , 0 ))
{
// Hien thi cac duong EMA ngan han EMA5,10,20
Plot(IIf(plotema5_10_20 ==1, pema5 ,Null), "ema5",  colorDarkOliveGreen,styleLine|styleNoLabel|styleThick|styleNoRescale);
Plot(IIf(plotema5_10_20 ==1, pema10 ,Null),"ema10", colorLightOrange,   styleLine|styleThick|styleNoRescale);
Plot(IIf(plotema5_10_20 ==1, pema20 ,Null),"ema20", colorBlue,          styleLine|styleThick|styleNoRescale);

//**********************************************************************************
maupcolor   = ParamColor(" - MA Up Color",      colorSeaGreen );  
madncolor   = ParamColor(" - MA Down Color",    colorGrey40 );

bullColor = ColorBlend( maupcolor,   GetChartBkColor(), 0.75 );  
bearColor = ColorBlend( madncolor,   GetChartBkColor(), 0.45 );


//Ve may EMA 10 va 20
PlotOHLC( pema10, pema20, pema10, pema20, "", IIf(pema10>pema20, bullColor , bearColor),  styleCloud |styleNoLabel|styleNoRescale);

}



// Ve duong MA 30,50,100,150,200
// Hien thi cac duong EMA30
Plot(IIf(ParamToggle("2. EMA30","OFF|ON" , 0 )  ==1, pema30 ,Null),"ema30", colorRed,styleLine|styleThick|styleNoRescale);

// Hien thi cac duong MA50
Plot(IIf(ParamToggle("3. MA50", "OFF|ON" , 0 ) ==1, mma50 ,Null),"MA50",    colorGold,styleLine|styleThick|styleNoRescale);

// Hien thi cac duong MA100
Plot(IIf(ParamToggle("4. MA100","OFF|ON" , 0 ) ==1, mma100 ,Null),"MA100", colorLightBlue,styleLine|styleThick|styleNoRescale);

// Hien thi cac duong MA150
Plot(IIf(ParamToggle("5. MA150","OFF|ON" , 0 ) ==1, mma150 ,Null),"MA150", colorGreen,styleLine|styleThick|styleNoRescale);

// Hien thi cac duong MA200
Plot(IIf(ParamToggle("6. MA200","OFF|ON" , 0 )  ==1, mma200 ,Null),"MA200", colorViolet,styleLine|styleThick|styleNoRescale);



_SECTION_END();


//====================================================================================|
//                    5.Muc HO TRO | KHANG CU gan nhat                          |
//====================================================================================|
// START SCRIPT UNTUK SUPPORT / RESISTANT

_SECTION_BEGIN("5. Muc HO TRO - KHANG CU gan nhat");

/*
Plot(IIf(BarIndex() >= R1x,LastValue(R1),Null),"R1",WarnaResistant ,SRStyle);
PlotText("R1 : " + R1, BarCount + 1, LastValue(R1), WarnaResistant);
*/			
 
WarnaResistant = ParamColor("Chon mau Resistant - Khang cu",colorRed);
WarnaSupport   = ParamColor("Chon mau Support - Ho tro",    colorBlue);
SRStyle        = ParamStyle("S/R Style",styleNoLabel);

R1_show = 0;
S1_show = 0;
 
 
if (ParamToggle("* Hien thi muc HO TRO - KHANG CU gan nhat", "OFF|ON" , 0 ))
{
	// RESISTANT
	LastHighestValue = LastVisibleValue(Ref(H,-1));
	if (LastVisibleValue(H) == H[LastValue(BarIndex())])
		LastHighestValue = LastVisibleValue(H);
 
	i = 1;
	
	if (LastHighestValue < HighestVisibleValue(H))
	{
			while (LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1),Ref(H, -1), i)) < LastHighestValue)
				i++;
 
	    	R1 = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1),Ref(H, -1), i));
 
			R1x = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1),Ref(BarIndex(), -1), i));
			Plot(IIf(BarIndex() >= R1x,LastValue(R1),Null),"R1",WarnaResistant ,SRStyle );
			PlotText("R1 : " + R1, BarCount + 10, LastValue(R1), WarnaResistant);
			R1_show = 1;
 
			i++;
 
			if (HighestVisibleValue( H ) > R1)
			{
				while (LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1), Ref(H,-1), i)) <= R1)
					i++;
 
				R2 = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1), Ref(H,-1), i));
				R2x = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1),Ref(BarIndex(), -1), i));
	
				Plot(IIf(BarIndex() >= R2x,LastValue(R2),Null),"R2",WarnaResistant ,SRStyle);
				PlotText("R2 : " + R2, BarCount + 10, LastValue(R2), WarnaResistant);
				i++;
				if (HighestVisibleValue( H )> R2)
				{ 		
					while (LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1), Ref(H,-1), i)) <= R2)
						i++;
					R3 = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1), Ref(H,-1), i));
					R3x = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1),Ref(BarIndex(), -1), i));	
 
					Plot(IIf(BarIndex() >= R3x,LastValue(R3),Null),"R3",WarnaResistant ,SRStyle);
					PlotText("R3 : " + R3, BarCount + 10, LastValue(R3), WarnaResistant);
				}
			}
	}
	else if (LastHighestValue == HighestVisibleValue(H))
	{
	   	R1 = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1),Ref(H, -1), i));
		R1x = LastVisibleValue(ValueWhen(H <= Ref(H,-1) AND Ref(H,-2) <= Ref(H, -1),Ref(BarIndex(), -1), i));
		if (R1 == LastHighestValue)
		{
			Plot(IIf(BarIndex() >= R1x,LastValue(R1),Null),"R1",WarnaResistant ,SRStyle);
			PlotText("R1 : " + R1, BarCount + 10, LastValue(R1), WarnaResistant);
			R1_show = 1;
		}
	}
 
	// SUPPORT
	LastLowestValue = LastVisibleValue(Ref(L,-1));
	if (LastVisibleValue(L) == L[LastValue(BarIndex())])
		LastLowestValue = LastVisibleValue(L);
 
	i = 1;
 
	if (LastLowestValue > LowestVisibleValue(L))
	{	
			while (LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1),Ref(L, -1), i)) > LastLowestValue)
				i++;
 
			S1 = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1),Ref(L, -1), i));
			S1x = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1),Ref(BarIndex(), -1), i));
			Plot(IIf(BarIndex() >= S1x,LastValue(S1),Null),"S1",WarnaSupport ,SRStyle);
			PlotText("S1 : " + S1, BarCount + 10, LastValue(S1), WarnaSupport);
			S1_show = 1;
			i++;
 
			if (LowestVisibleValue( L ) < S1)
			{
				while (LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1), Ref(L,-1), i)) >= S1)
					i++;
 
				S2 = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1), Ref(L,-1), i));
				S2x = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1), Ref(BarIndex(),-1), i));	
 
				Plot(IIf(BarIndex() >= S2x,LastValue(S2),Null),"S2",WarnaSupport ,SRStyle);
				PlotText("S2 : " + S2, BarCount + 10, LastValue(S2), WarnaSupport);
				i++;
				if (LowestVisibleValue( L )< S2)
				{ 		
					while (LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1), Ref(L,-1), i)) >= S2)
						i++;
					S3 = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1), Ref(L,-1), i));
					S3x = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1), Ref(BarIndex(),-1), i));
					Plot(IIf(BarIndex() >= S3x,LastValue(S3),Null),"S3",WarnaSupport ,SRStyle);
					PlotText("S3 : " + S3, BarCount + 10, LastValue(S3), WarnaSupport);
				}
			}
	}
	else if (LastLowestValue == LowestVisibleValue(L))
	{
	   	S1 = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1),Ref(L, -1), i));
		S1x = LastVisibleValue(ValueWhen(L >= Ref(L,-1) AND Ref(L,-2) >= Ref(L, -1),Ref(BarIndex(), -1), i));
		if (S1 == LastLowestValue)
		{
			Plot(IIf(BarIndex() >= S1x,LastValue(S1),Null),"S1",WarnaSupport ,SRStyle);
			PlotText("S1 : " + S1, BarCount + 10, LastValue(S1), WarnaSupport);
			S1_show = 1;
		}
	}
 
	if (S1_show AND R1_show)
	{
		SR = Prec((1-(S1/R1))*100,2);
	}
}
 

_SECTION_END();
// END SCRIPT UNTUK SUPPORT / RESISTANT






//====================================================================================|
//                       PLOT SHAPES SECTION   - Hien thi dau hieu canh bao VSA            |
//====================================================================================|


 
if (vsasignal = ParamToggle( "* Hien thi dau hieu canh bao VSA",  "OFF|ON", 0 ))
{





PlotShapes(shapeSmallDownTriangle*(upThrustBar OR upThrustBartrue ) , colorDarkRed, 0, H, -10 );
PlotShapes(shapeHollowSmallDownTriangle*(upThrustBarA OR upThrustBartrue ) , colorRed, 0, H, -10 );
PlotShapes(shapeSmallDownTriangle*(upThrustcond1 OR upThrustcond2 ) , colorRed, 0, H, -20 );
PlotShapes(shapeHollowSmallDownTriangle*(upThrustcond1 OR upThrustcond2 ) , colorWhite, 0, H, -20 );
PlotShapes(shapeSmallCircle*topRevBar, colorBlue, 0, H, 20 );
PlotShapes(shapeSmallSquare*(PseudoUpThrust) , colorBlue, 0, H, 10 );
PlotShapes(shapeSmallDownTriangle*(pseudoUtCond) , colorBlue, 0, H, -20 );
PlotShapes(shapeSmallDownTriangle*trendChange , colorYellow, 0, H, -20 );
PlotShapes(shapeHollowSmallDownTriangle*trendChange , colorRed, 0, H, -20 );
PlotShapes(shapeSmallSquare*noDemandBarUt, colorOrange, 0, H, 15);
PlotShapes(shapeHollowSmallSquare*noDemandBarUt, colorYellow, 0, H, 15);
PlotShapes(shapeSmallSquare*(noDemandBarDt) , colorOrange, 0, H, 15 );
PlotShapes(shapeHollowSmallSquare*noDemandBarDt, colorYellow, 0, H, 15);
PlotShapes(shapeSmallSquare*noSupplyBar, colorBlue, 0, L, -20 );
PlotShapes(shapeHollowSmallSquare*noSupplyBar, colorLightBlue, 0, L, -20 );
PlotShapes(shapeSmallSquare*lowVolTest, colorCustom12, 0, L, -20);
PlotShapes(shapeSmallUpTriangle*lowVolTest2, colorYellow, 0, L, -10 );
PlotShapes(shapeSmallUpTriangle*strengthDown, colorDarkGreen, 0, L, -20 );
PlotShapes(shapeHollowSmallUpTriangle*strengthDown, colorLime, 0, L, -20 );
PlotShapes(shapeSmallUpTriangle*strengthDown2, colorViolet, 0, L, -30 );
PlotShapes(shapeHollowSmallUpTriangle*strengthDown2, colorCustom12, 0, L, -30 );
PlotShapes(shapeSmallCircle*stopVolume, colorGreen,0, L, -10 );
PlotShapes(shapeHollowSmallCircle*stopVolume, colorYellow, 0, L, -10 );
PlotShapes(shapeSmallSquare*revUpThrust, colorYellow, 0, L, -20 );
PlotShapes(shapeSmallUpTriangle*sc, colorViolet, 0, L, -30 );
PlotShapes(shapeSmallCircle*effortUp, colorLime, 0, midprice, 0 );
PlotShapes(shapeSmallCircle*effortUpFail, colorRed, 0, H, 10 );
PlotShapes(shapeHollowSmallCircle*effortUpFail, colorWhite, 0, H, 10 );
PlotShapes(shapeSmallCircle*effortDown, colorOrange, 0, midprice, 0 );
PlotShapes(shapeSmallCircle*effortDownFail, colorRed, 0, L, -10 );
PlotShapes(shapeHollowSmallCircle*effortDownFail, colorWhite, 0, L, -10 );
PlotShapes(shapeUpArrow*buyCond, colorGreen, 0, L, -20 );
PlotShapes(shapeDownArrow*Sellcond, colorOrange, 0, H, -40 );
PlotShapes(shapeSmallDownTriangle*(nut) , colorLime, 0, H, -40 );
PlotShapes(shapeSmallDownTriangle*(bc ) , colorDarkRed, 0, H, -20 );
PlotShapes(shapeSmallCircle*(fom1 ) , colorWhite, 0, L, -50 );
//PlotShapes(shapeSmallCircle*(fom2 ) , colorRed, 0, L, -50 );
PlotShapes(shapeHollowCircle*(tbc3 ) , colorYellow ,0, L, -40 );
PlotShapes(shapeHollowCircle*(tbc2a ) , colorBlue ,0, L, -40 );
PlotShapes(shapeHollowCircle*(tbc2 ) , colorLime ,0, L, -40 );
PlotShapes(shapeHollowCircle*(tbc5 ) , colorYellow ,0, H, 40 );
PlotShapes(shapeHollowCircle*(tbc4 ) , colorRed ,0, H, 40 );

}



// END Hien thi dau hieu canh bao VSA









//====================================================================================|
//                       6. Muc HO TRO - KHANG CU tuy chinh                           |
//====================================================================================|
// AFL By Karthikmarar
// RESISTANCE AND SUPPORT LINES AFL VERSION 2.00
// Provids upto total 20 lines. Two Adjustable Parameters. 1) Sensitivity and 2) Number of lines
// Depending on the Share Volatility, the Sensitivity Factor can be adjusted
// Support Lines are colored Blue and Resistance Line are colored Red.


_SECTION_BEGIN("6. Muc HO TRO - KHANG CU tuy chinh");

Rcolor=ParamColor( "Resistance Color", colorRed );
Scolor=ParamColor( "Support Color", colorBlue );
Per=Param("Chon do nhay",5,1,100,1);
g=Param("Chon so duong",5,1,20,1);
sr=ParamToggle("* Hien thi Muc HO TRO - KHANG CU tuy chinh","OFF|ON" ,0);

x=Cum(1);
Pk1=PeakBars(H,per,1)== 0;
Tk1=TroughBars(L,per,1)== 0;
//peak detection
px1=LastValue(ValueWhen(pk1,x,1));
px2=LastValue(ValueWhen(Pk1,x,2));
px3=LastValue(ValueWhen(Pk1,x,3));
px4=LastValue(ValueWhen(pk1,x,4));
px5=LastValue(ValueWhen(Pk1,x,5));
px6=LastValue(ValueWhen(Pk1,x,6));
px7=LastValue(ValueWhen(pk1,x,7));
px8=LastValue(ValueWhen(Pk1,x,8));
px9=LastValue(ValueWhen(Pk1,x,9));
px10=LastValue(ValueWhen(Pk1,x,10));
//Trough  Detection
tx1=LastValue(ValueWhen(Tk1,x,1));
tx2=LastValue(ValueWhen(Tk1,x,2));
tx3=LastValue(ValueWhen(Tk1,x,3));
tx4=LastValue(ValueWhen(Tk1,x,4));
tx5=LastValue(ValueWhen(Tk1,x,5));
tx6=LastValue(ValueWhen(Tk1,x,6));
tx7=LastValue(ValueWhen(Tk1,x,7));
tx8=LastValue(ValueWhen(Tk1,x,8));
tx9=LastValue(ValueWhen(Tk1,x,9));
tx10=LastValue(ValueWhen(Pk1,x,10));
//values when Peaks occured
XT1 =LastValue(ValueWhen(pk1,H,1));
XT2 =LastValue(ValueWhen(Pk1,H,2));
XT3 =LastValue(ValueWhen(Pk1,H,3));
XT4 =LastValue(ValueWhen(pk1,H,4));
XT5 =LastValue(ValueWhen(Pk1,H,5));
XT6 =LastValue(ValueWhen(Pk1,H,6));
XT7 =LastValue(ValueWhen(pk1,H,7));
XT8 =LastValue(ValueWhen(Pk1,H,8));
XT9 =LastValue(ValueWhen(Pk1,H,10));
XT10 =LastValue(ValueWhen(Pk1,H,10));
//Value when troughs occured
YT1 =LastValue(ValueWhen(tk1,L,1));
YT2 =LastValue(ValueWhen(tk1,L,2));
YT3 =LastValue(ValueWhen(tk1,L,3));
YT4 =LastValue(ValueWhen(tk1,L,4));
YT5 =LastValue(ValueWhen(tk1,L,5));
YT6 =LastValue(ValueWhen(tk1,L,6));
YT7 =LastValue(ValueWhen(tk1,L,7));
YT8 =LastValue(ValueWhen(tk1,L,8));
YT9 =LastValue(ValueWhen(tk1,L,10));
YT10 =LastValue(ValueWhen(tk1,L,10));
LastBar = Cum(1) == LastValue(Cum(1));
//plot peak lines
Plot(IIf(x>px1 AND g>=1 AND sr,XT1,Null),"P1",IIf( LastValue(C)>XT1, Scolor, Rcolor ));
Plot(IIf(x>px2 AND g>=2 AND sr,XT2,Null),"P2",IIf( LastValue(C)>XT2, Scolor, Rcolor ));
Plot(IIf(x>px3 AND g>=3 AND sr,XT3,Null),"P3",IIf( LastValue(C)>XT3, Scolor, Rcolor ));
Plot(IIf(x>px4 AND g>=4 AND sr,XT4,Null),"P4",IIf( LastValue(C)>XT4, Scolor, Rcolor ));
Plot(IIf(x>px5 AND g>=5 AND sr,XT5,Null),"P5",IIf( LastValue(C)>XT5, Scolor, Rcolor ));
Plot(IIf(x>px6 AND g>=6 AND sr,XT6,Null),"P6",IIf( LastValue(C)>XT6, Scolor, Rcolor ));
Plot(IIf(x>px7 AND g>=7 AND sr,XT7,Null),"P7",IIf( LastValue(C)>XT7, Scolor, Rcolor ));
Plot(IIf(x>px8 AND g>=8 AND sr,XT8,Null),"P8",IIf( LastValue(C)>XT8, Scolor, Rcolor ));
Plot(IIf(x>px9 AND g>=9 AND sr,XT9,Null),"P9",IIf( LastValue(C)>XT9, Scolor, Rcolor ));
Plot(IIf(x>px10 AND g>=10 AND sr,XT10,Null),"P10",IIf( LastValue(C)>XT10, Scolor, Rcolor ));
//plot Trough lines
Plot(IIf(x>tx1 AND g>=1 AND sr,YT1,Null),"T1",IIf( LastValue(C)>YT1, Scolor, Rcolor ));
Plot(IIf(x>tx2 AND g>=2 AND sr,YT2,Null),"T2",IIf( LastValue(C)>YT2, Scolor, Rcolor ));
Plot(IIf(x>tx3 AND g>=3 AND sr,YT3,Null),"T3",IIf( LastValue(C)>YT3, Scolor, Rcolor ));
Plot(IIf(x>tx4 AND g>=4 AND sr,YT4,Null),"T4",IIf( LastValue(C)>YT4, Scolor, Rcolor ));
Plot(IIf(x>tx5 AND g>=5 AND sr,YT5,Null),"T5",IIf( LastValue(C)>YT5, Scolor, Rcolor ));
Plot(IIf(x>tx6 AND g>=6 AND sr,YT6,Null),"T6",IIf( LastValue(C)>YT6, Scolor, Rcolor ));
Plot(IIf(x>tx7 AND g>=7 AND sr,YT7,Null),"T7",IIf( LastValue(C)>YT7, Scolor, Rcolor ));
Plot(IIf(x>tx8 AND g>=8 AND sr,YT8,Null),"T8",IIf( LastValue(C)>YT8, Scolor, Rcolor ));
Plot(IIf(x>tx9 AND g>=9 AND sr,YT9,Null),"T9",IIf( LastValue(C)>YT9, Scolor, Rcolor ));
Plot(IIf(x>tx10 AND g>=10 AND sr,YT10,Null),"T10",IIf( LastValue(C)>YT10, Scolor, Rcolor ));
//Crossing Resistance Lines
xt1c=Cross(C,xt1);
xt2c=Cross(C,xt2);
xt3c=Cross(C,xt3);
xt4c=Cross(C,xt4);
xt5c=Cross(C,xt5);
xt6c=Cross(C,xt6);
xt7c=Cross(C,xt7);
xt8c=Cross(C,xt8);
xt9c=Cross(C,xt9);
xt10c=Cross(C,xt10);
//Breaking support Lines
yt1c=Cross(yt1,C);
yt2c=Cross(yt2,C);
yt3c=Cross(yt3,C);
yt4c=Cross(yt4,C);
yt5c=Cross(yt5,C);
yt6c=Cross(yt6,C);
yt7c=Cross(yt7,C);
yt8c=Cross(yt8,C);
yt9c=Cross(yt9,C);
yt10c=Cross(yt10,C);
//Resistance approaching 
ax1=C<xt1 AND C>xt1*0.97;
ax2=C<xt2 AND C>xt2*0.97;
ax3=C<xt3 AND C>xt3*0.97;
ax4=C<xt4 AND C>xt4*0.97;
ax5=C<xt5 AND C>xt5*0.97;
ax6=C<xt6 AND C>xt6*0.97;
ax7=C<xt7 AND C>xt7*0.97;
ax8=C<xt8 AND C>xt8*0.97;
ax9=C<xt9 AND C>xt9*0.97;
ax10=C<xt10 AND C>xt10*0.97;
//Support approaching
ay1=C>yt1 AND C<yt1*1.03;
ay2=C>yt2 AND C<yt2*1.03;
ay3=C>yt3 AND C<yt3*1.03;
ay4=C>yt4 AND C<yt4*1.03;
ay5=C>yt5 AND C<yt5*1.03;
ay6=C>yt6 AND C<yt6*1.03;
ay7=C>yt7 AND C<yt7*1.03;
ay8=C>yt8 AND C<yt8*1.03;
ay9=C>yt9 AND C<yt9*1.03;
ay10=C>yt10 AND C<yt10*1.03;
//Resistance lines commentary
src1=xt1c OR xt2c OR xt3c OR xt4c OR xt5c OR xt6c OR xt7c OR xt8c OR xt9c OR xt10c OR yt1c OR yt2c OR yt3c OR yt4c OR yt5c OR yt6c OR yt7c OR yt8c OR yt9c OR yt10c;
src2=ax1 OR ax2 OR ax3 OR ax4 OR ax5 OR ax6 OR ax7 OR ax8 OR ax9 OR ax10 OR ay1 OR ay2 OR ay3 OR ay4 OR ay5 OR ay6 OR ay7 OR ay8 OR ay9 OR ay10;
WriteIf(src1 OR src2,"------------------------------------------","");
WriteIf(src1 OR src2,"Mo ta Ho tro / Khang cu: \n","");
WriteIf(xt1c AND V>volAvg,"Khang cu tai: "+xt1+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt1c AND V<volAvg,"Khang cu tai: "+xt1+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt2c AND V>volAvg,"Khang cu tai: "+xt2+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt2c AND V<volAvg,"Khang cu tai:"+xt2+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt3c AND V>volAvg,"Khang cu tai: "+xt3+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt3c AND V<volAvg,"Khang cu tai: "+xt3+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt4c AND V>volAvg,"Khang cu tai: "+xt4+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt4c AND V<volAvg,"Khang cu tai: "+xt4+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt5c AND V>volAvg,"Khang cu tai: "+xt5+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt5c AND V<volAvg,"Khang cu tai: "+xt5+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt6c AND V>volAvg,"Khang cu tai: "+xt6+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt6c AND V<volAvg,"Khang cu tai: "+xt6+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt7c AND V>volAvg,"Khang cu tai: "+xt7+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt7c AND V<volAvg,"Khang cu tai: "+xt7+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt8c AND V>volAvg,"Khang cu tai: "+xt8+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt8c AND V<volAvg,"Khang cu tai: "+xt8+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt9c AND V>volAvg,"Khang cu tai: "+xt9+"  Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt9c AND V<volAvg,"Khang cu tai: "+xt9+"  Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(xt10c AND V>volAvg,"Khang cu tai: "+xt10+" Vuot qua voi khoi luong cao.Tang gia.",
WriteIf(xt10c AND V<volAvg,"Khang cu tai: "+xt10+" Vuot qua, nhung voi khoi luong thap hon. Hay can trong."," "));
//Support line breaks Commentary
WriteIf(yt1c AND V>volAvg,"Ho tro tai: "+yt1+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt1c AND V<volAvg,"Ho tro tai:"+yt1+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt2c AND V>volAvg,"Ho tro tai: "+yt2+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt2c AND V<volAvg,"Ho tro tai: "+yt2+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt3c AND V>volAvg,"Ho tro tai: "+yt3+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt3c AND V<volAvg,"Ho tro tai: "+yt3+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt4c AND V>volAvg,"Ho tro tai: "+yt4+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt4c AND V<volAvg,"Ho tro tai: "+yt4+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt5c AND V>volAvg,"Ho tro tai: "+yt5+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt5c AND V<volAvg,"Ho tro tai: "+yt5+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt6c AND V>volAvg,"Ho tro tai: "+yt6+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt6c AND V<volAvg,"Ho tro tai: "+yt6+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt7c AND V>volAvg,"Ho tro tai: "+yt7+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt7c AND V<volAvg,"Ho tro tai: "+yt7+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt8c AND V>volAvg,"Ho tro tai: "+yt8+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt8c AND V<volAvg,"Ho tro tai: "+yt8+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt9c AND V>volAvg,"Ho tro tai: "+yt9+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt9c AND V<volAvg,"Ho tro tai: "+yt9+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "))+
WriteIf(yt10c AND V>volAvg,"Ho tro tai: "+yt10+"  pha vo voi khoi luong cao. Giam gia.",
WriteIf(yt10c AND V<volAvg,"Ho tro tai: "+yt10+"  pha vo, nhung voi khoi luong thap hon. Hay can trong."," "));
//Resistance approaching Commentary
WriteIf(ax1 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt1+  ". ","")+
WriteIf(ax2 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt2+  ". ","")+
WriteIf(ax3 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt3+  ". ","")+
WriteIf(ax4 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt4+  ". ","")+
WriteIf(ax5 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt5+  ". ","")+
WriteIf(ax6 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt6+  ". ","")+
WriteIf(ax7 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt7+  ". ","")+
WriteIf(ax8 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt8+  ". ","")+
WriteIf(ax9 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt9+  ". ","")+
WriteIf(ax10 AND tls>0, "Gia dang tiep can muc khang cu tai "+xt10+ ". ","");
WriteIf(ay1 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt1+  ". ","")+
WriteIf(ay2 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt2+  ". ","")+
WriteIf(ay3 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt3+  ". ","")+
WriteIf(ay4 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt4+  ". ","")+
WriteIf(ay5 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt5+  ". ","")+
WriteIf(ay6 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt6+  ". ","")+
WriteIf(ay7 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt7+  ". ","")+
WriteIf(ay8 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt8+  ". ","")+
WriteIf(ay9 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt9+  ". ","")+
WriteIf(ay10 AND tls<0, "Gia dang tiep can muc khang cu tai "+yt10+  ". ","");
_SECTION_END();

//END Ho tro Khang cu tuy chinh



//|============================================================================================|
//|                7. Breakout vuot vung Khang cu                                   |
//|============================================================================================|


_SECTION_BEGIN("7. Breakout Support - Breakout vuot vung khang cu");

sophien = Param( "Time so phien tinh toan", 10, 0, 260, 1 );  // So phien tinh vung sideway
chenhlech_loc = Param( "% Bien dong vung Sideway", 0.05, 0.01, 0.3, 0.01 ); //Bien dong gia trong vung sideway
caonhat = Ref( HHV( High, sophien ), -1 );
thapnhat = Ref( LLV( Low, sophien ), -1 );
chenhlech = ( caonhat - thapnhat ) / thapnhat <= chenhlech_loc;
butpha = 
(chenhlech AND Volume > 0.7*EMA( Volume, 20 ) AND Close > caonhat AND volume > 50000 
AND C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 AND Ref(C,-5)*Ref(V,-5) >= 3000000 
AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,20) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) AND MA(C,50) >= MA(C,150) 
AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) AND MA(C,200) > Ref(MA(C,200),-20) 
) 
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 
AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20)      
)
 OR 
 (chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) 
 AND C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 AND Ref(C,-5)*Ref(V,-5) >= 3000000 
AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50)
 AND C >= MA(C,150) AND C >= MA(C,200) AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) AND MA(C,200) > Ref(MA(C,200),-20)       
)

OR
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 
AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,5) >= EMA(C,21)      
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 
AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,5) >= MA(C,50)      
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 
AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,10) >= EMA(C,21)    
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 
AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,10) >= MA(C,50)    
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50)
 AND C >= MA(C,150) AND C >= MA(C,200) AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,5) >= EMA(C,10) AND EMA(C,10) >= EMA(C,21) AND EMA(C,21) >= MA(C,50)   
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 
AND C >= EMA(C,10) AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,5) >= EMA(C,10)  AND EMA(C,5) >= EMA(C,21) AND EMA(C,5) >= MA(C,50) AND EMA(C,5) >= MA(C,150) AND EMA(C,5) >= MA(C,200)
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,10) >= EMA(C,21) AND EMA(C,10) >= MA(C,50) AND EMA(C,10) >= MA(C,150) AND EMA(C,10) >= MA(C,200)
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,21) >= MA(C,50) AND EMA(C,21) >= MA(C,150) AND EMA(C,21) >= MA(C,200)
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,5) >= EMA(C,10)  AND EMA(C,5) >= EMA(C,21) AND EMA(C,5) >= MA(C,50) AND EMA(C,5) >= MA(C,150) AND EMA(C,5) >= MA(C,200)
AND EMA(C,10) >= EMA(C,21) AND EMA(C,10) >= MA(C,50) AND EMA(C,10) >= MA(C,150) AND EMA(C,10) >= MA(C,200)
AND EMA(C,21) >= MA(C,50) AND EMA(C,21) >= MA(C,150) AND EMA(C,21) >= MA(C,200)
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,5) >= EMA(C,21) 
AND C >= 1.3*LLV(C,260) AND C >= 0.7*HHV(C,260) 
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,5) >= MA(C,50) 
AND C >= 1.3*LLV(C,260) AND C >= 0.7*HHV(C,260) 
)
OR 
(chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 
AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) 
AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,10) >= EMA(C,21)
AND C >= 1.3*LLV(C,260) AND C >= 0.7*HHV(C,260) 
)
OR 
(
chenhlech AND Volume >= 0.7*EMA( Volume, 30 ) AND Close > caonhat AND volume > 50000 AND C > Ref(C,-1) AND 
C >= 5 AND C >= 1.01*Ref(C,-1) AND C*V >= 1000000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 3000000 AND Ref(C,-10)*Ref(V,-10) >= 3000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 AND C >= EMA(C,10) 
AND C >= EMA(C,21) AND C >= MA(C,50) AND C >= MA(C,150) AND C >= MA(C,200) AND MA(C,50) >= MA(C,150) AND MA(C,50) >= MA(C,200) AND MA(C,150) >= MA(C,200) 
AND MA(C,200) > Ref(MA(C,200),-20) AND EMA(C,10) >= MA(C,50)AND C >= 1.3*LLV(C,260) AND C >= 0.7*HHV(C,260)
);

//Plot Breakout vuot vung Khang cu  

if (BreakoutSupport = ParamToggle( "* BreakoutSupport - Vuot vung khang cu",  "OFF|ON", 0 ))
{

//Plot vung sideway
duongtren = ValueWhen( butpha, caonhat, 0 );
duongduoi = ValueWhen( butpha, thapnhat, 0 );
Plot( duongtren, "", colorRed, styleNoLine + styleDots );
Plot( duongduoi, "", colorBlue, styleNoLine + styleDots );
butpha_moi[0] = 0;
butpha_moi[1] = 0;
 
for( i = 0; i <= BarCount - 1; i++ )
{
    if( butpha[i] == 1 AND( butpha[i - 1] == 1 OR butpha[i - 2] == 1 OR butpha[i - 3] == 1 ) )
    {
        butpha_moi[i] = 0;
    }
    else
        if( butpha[i] == 0 )
        {
            butpha_moi[i] = 0;
        }
        else
        {
            butpha_moi[i] = 1;
        }
 
    if( butpha_moi[i] == 1 )
    {
        PlotText( "Breakout", i, thapnhat[i], colorBlack, colorBrightGreen,Offset=-33 );
    }
}
 
PlotShapes(IIf(butpha_moi, shapeUpArrow, shapeNone),colorBlue, 0,thapnhat, Offset=-12);
 
//PlotShapes( butpha_moi*shapeUpArrow, colorBlue, 0, thapnhat );

}

/*
//Chay bo loc 

Filter = butpha_moi;
AddColumn( Close, "Dong Cua" );
AddColumn( butpha_moi, "Breakout" );
Buy = butpha_moi;
Sell = Cross( EMA( Close, 10 ), Close );
*/
_SECTION_END();

//|============================================================================================|
//|             END     7. Breakout vuot vung Khang cu                                   |
//|============================================================================================|



//==========================================================================|
//                     8. Darvas Box    |
//==========================================================================|


_SECTION_BEGIN("8. Darvas Box");

Periods= Param("Darvas Periods",5,1,260); 

boxHigh = Ref(H,-3)>=Ref(HHV(H,Periods),-4) AND 
                  Ref(H,-3)>Ref(H,-2) AND Ref(H,-3)>Ref(H,-1) AND Ref(H,-3)>H;

Topbox=ValueWhen(boxHigh, Ref(H,-3)); 
Botbox=ValueWhen(boxHigh,LLV(L,4)); 
 
 
if (darvas = ParamToggle( "* Hien thi Darvas Box",  "OFF|ON", 0 ))
{

/*=========================
  - Allow color change
  - Style change 
 ==========================*/
Plot(TopBox, "Top", ParamColor("Box Top Color",  colorRed),    ParamStyle("Box Top Style"));
Plot(Botbox, "Bot", ParamColor("Box Bottom Color",colorBlue),  ParamStyle("Box Bottom Style"));

}


_SECTION_END();
// END Darvas Box 


//====================================================================================|
//                       9. Auto Trendline                                 |
//====================================================================================|



_SECTION_BEGIN("9. Auto Trendline - Tu dong ke duong Xu huong");

 
if (ParamToggle("* Hien thi Auto Trenline", "OFF|ON" ,0 ))
{


// Parallel lines defined by the automatic support and the HighestBetween point
x = Cum(1);per = 3;s1=L;s11=H;
pS = TroughBars( s1, per, 1 ) == 0;
endt= LastValue(ValueWhen( pS, x, 1 ));
startt=LastValue(ValueWhen( pS, x, 2 ));
dtS =endt-startt;
endS = LastValue(ValueWhen( pS, s1, 1 ) );
startS = LastValue( ValueWhen( pS, s1, 2 ));
aS = (endS-startS)/dtS;bS = endS;
trendlineS = aS * ( x -endt ) + bS;
Plot(IIf(x>startt-10,trendlineS,-1e10),"",colorBlue,1);
H1=LastValue(Highest((Cum(1)>startt AND Cum(1)<endt)*H));
tH1=LastValue(ValueWhen(H==H1,Cum(1)));
Color=IIf((Cum(1)==startt OR Cum(1)==endt),colorBlue,IIf(Cum(1)==tH1,colorOrange,colorBlack));
Plot(C,"Close",Color,64);
UpperParallel=aS*(x-tH1)+H1;Plot(IIf(x>startt-10,UpperParallel,-1e10),"UpperLine",colorOrange,1);

// Parallel lines defined by the automatic resistance and the LowestBetween point
x = Cum(1);per = 3;s1=L;s11=H;
pR = PeakBars( s11, per, 1 ) == 0;
endt1= LastValue(ValueWhen( pR, x, 1 ));
startt1=LastValue(ValueWhen( pR, x, 2 ));
dtR =endt1-startt1;
endR = LastValue(ValueWhen( pR, s11, 1 ) );
startR = LastValue( ValueWhen( pR, s11, 2 ));
aR = (endR-startR)/dtR;
bR = endR;
trendlineR = aR * ( x -endt1 ) + bR;
Plot(IIf(x>startt1-10,trendlineR,-1e10),"",colorBlue,1);
L1=LastValue(Lowest(IIf(Cum(1)>startt1 AND Cum(1)<endt1,L,10^10)));
tL1=LastValue(ValueWhen(L==L1,Cum(1)));
Color=IIf((Cum(1)==startt1 OR Cum(1)==endt1),colorBlue,IIf(Cum(1)==tL1,colorOrange,colorBlack));
Plot(C,"Close",Color,64);
LowerParallel=aR*(x-tL1)+L1;Plot(IIf(x>startt1-10,LowerParallel,-1e10),"LowerLine",colorOrange,1);



}
 
// END AUTO TRENDLINE


//==========================================================================|
//                   10. Dash Boar - Bang dieu khien                                 |
//==========================================================================|


_SECTION_BEGIN("10. Dash Board - Do thi Ap luc Cung Cau");


Vlb  = Param("Khoang thoi gian xem lai Volume",60,20,300,10);
xf=Param("Toa do X",-30,-150,1300,1);  //Ngang
yf=Param("Toa do Y", 160,-130,550,1); //Doc


if (ParamToggle( "* Hien thi Dash Board - Do thi Ap luc Cung Cau", "OFF|ON", 0 ))
{

sp 		= H-C;  //Bien dong tren close
bp 		= C-L;  //Bien dong duoi Close
bpavg 	= WMA(bp,10); //Trung binh 10 ngay cua bien dong duoi close
spavg 	= WMA(sp,10); //Trung binh 10 ngay cua bien dong tren close
nbp 	= bp/bpavg;  //ty le cua bien dong duoi so voi trung binh
nsp 	= sp/spavg;  //ty le cua bien dong tren so voi trung binh
diff 	= nbp-nsp;  //Hieu so giua 2 ty le
Varg = WMA(V,10);  //Trung binh Volume 10 ngay
nv = V/Varg;        //ty le volume so voi trung binh
nbfraw = nbp * nv;   //ty le volume so voi trung binh * ty le cua bien dong duoi so voi trung binh
nsfraw = nsp * nv;   //ty le volume so voi trung binh * ty le cua bien dong tren so voi trung binh
nbf = WMA(nbp * nv,20); // binh quan 20 ngay cua (ty le volume so voi trung binh * ty le cua bien dong duoi so voi trung binh)
nsf = WMA(nsp * nv,20);  //binh quan 20 ngay cua (ty le volume so voi trung binh * ty le cua bien dong tren so voi trung binh)
bfmax = HHV(nbfraw,Vlb);  //muc cao nhat cua ty le volume so voi trung binh * ty le cua bien dong duoi so voi trung binh trong ky xem (60)
bfmin = LLV(nbfraw,Vlb);  //muc thap nhat cua ty le volume so voi trung binh * ty le cua bien dong duoi so voi trung binh trong ky xem (60)
nfmax = HHV(nsfraw,Vlb); //muc cao nhat cua ty le volume so voi trung binh * ty le cua bien dong tren so voi trung binh            
nfmin = LLV(nsfraw,Vlb);//muc thap nhat cua ty le volume so voi trung binh * ty le cua bien dong tren so voi trung binh     
bfnor = ((nbfraw - bfMin)*100/((bfmax-bfmin)+ 1e-9)); //Luc Cau (Mua)
nfnor = (nsfraw - nfmin)*100/((nfmax-nfmin)+ 1e-9);  //Luc Cung (Ban)
x=Status("pxchartleft")+xf;
y=Status("pxcharttop")+yf;
GfxSetBkMode( colorWhite ); 

//================= Buying Pressure Bar graph ================
//Ap luc Cau (Mua)
//============================================================

x1 = SelectedValue(bfnor);
y1 = y + (100-x1);
z = SelectedValue(bfnor);
GfxSelectSolidBrush( colorLime ); //Phan thay doi mau
GfxSelectPen( colorPaleTurquoise );  //Vien ngoai
GfxRectangle( x+55,y+100, x+65,y);
GfxGradientRect(x+55,y1,x+65,y+100,colorGreen,colorDarkGreen);
//Mau chu Buy
GfxSelectFont("Times New Roman", 8, xf );
GfxSetTextColor( colorYellow ); 
GfxTextOut("Buy", x+55,y+105 );

//================= Selling Pressure Bar graph ================
//Ap luc Cung (Ban)
//=============================================================

x2 = SelectedValue(nfnor);
y2 = y + (100-x2);
z1 = SelectedValue(nfnor);
//--------------bargraph---------------------------------------
//Thanh bieu do
GfxSelectSolidBrush( colorOrange ); 
GfxSelectPen( colorRose );
GfxRectangle( x+75,y+100, x+85,y);
GfxGradientRect(x+75,y2,x+85,y+100,colorBrown,colorDarkRed);
//Mau chu Sell
GfxSelectFont("Times New Roman", 8, xf );
GfxSetTextColor( colorYellow ); 
GfxTextOut("Sell", x+75,y+105 );

//========================Effort & Result===============================
//======================================================================
//No luc ket qua
//=================
Vrg1  = WMA(V,40);// average volume
rg   = (H-L); //Spread
arg1  = Wilders(rg,40);//Average Spread
rs   = abs(C-Ref(C,-1));//Result - Ket qua -  Gia so voi hom truoc 
rsg  = Wilders(rs,40);//Average Result - Trung binh ket qua
sro  = rg/arg1;//ratio of spread to average - Ty le Spread trung binh
Vro  = V/Vrg1;//ratio of volume to average  - Ty le Volume trung binh
rso  = rs/rsg; //ratio of result to average - Ty le ket qua so voi trung binh
smax = HHV(sro,40); //High cua Ty le Spread trung binh
smin = LLV(sro,40); //Low cua Ty le Spread trung binh
Vmax = HHV(Vro,40); //High cua Ty le Volume trung binh
Vmin = LLV(Vro,40); //Low cua Ty le Volume trung binh
rmax = HHV(rso,40); //High cua Ty le ket qua so voi trung binh
RMIn = LLV(rso,40); //Low cua Ty le ket qua so voi trung binh
snor = (smax-sro )*100/(smax-Smin + 1e-9); //Tinh ty le cua Spread
Vnor = (Vmax-Vro )*100/(Vmax-Vmin + 1e-9); //Danh gia gia tri cua Volume hien tai
rnor = (rmax-rso )*100/(rmax-RMIn + 1e-9);  //Danh gia gia tri cua Ket qua 


//=======================================================
//================DashBoard=============================
//=======================================================

//========Spread===========
x3 = SelectedValue(snor);
y3 = y+(230-x3);
GfxSelectSolidBrush(colorTurquoise); 
GfxSelectPen(colorAqua);
GfxRectangle(x+55,y+230,x+65,y+130);
GfxGradientRect(x+55,y+130+x3,x+65,y+230,colorBlue,colorDarkBlue);
GfxSelectFont("Times New Roman", 8, xf );
GfxSetTextColor(colorYellow ); 
GfxTextOut("Sp", x+55,y+235 );

//------------------------------------------------
//========Result===========
x4 = SelectedValue(rnor);
y4 = y + (230-x4);
GfxSelectSolidBrush(colorLightOrange); 
GfxSelectPen(colorRose);
GfxRectangle(x+75,y+230,x+85,y+130);
GfxGradientRect(x+75,y+130+x4,x+85,y+230,colorDarkYellow,colorDarkRed) ;
GfxSelectFont("Times New Roman", 8, xf );
GfxSetTextColor( colorYellow ); 
GfxTextOut("Re", x+75,y+235 );

//--------------------------------------------------
//========Effort===========
x5 = SelectedValue(vnor);
y5 = y + (230-x5);
GfxSelectSolidBrush(colorLightBlue ); 
GfxSelectPen(colorLightYellow );
GfxRectangle( x+95,y+230, x+105,y+130);
GfxGradientRect(x+95,y+130+x5,x+105,y+230, colorViolet,colorIndigo);
GfxSelectFont("Times New Roman", 8, xf );
GfxSetTextColor( colorGold); 
GfxTextOut("Ef", x+95,y+235 );

//----------------------------------
//========Strenght RSI===========
RPeriod = 14;
Lb = Param("LookBack Period",60,40,120,1); // Vung theo doi tin hieu
mySig1 = RSI(14);  //Tin hieu RSI
Adev = StDev(mySig1, 3*RPeriod); //Suc manh RSI
jh = HHV(mySig1,Lb); //High cua muc RSI trong ky
jl = LLV(mySig1,Lb); //Low cua muc RSI trong ky
jc = (WMA((jh-jl),RPeriod)*0.60)+WMA(jl,RPeriod); //trung binh cua muc RSI trong ky
Hiline = jh-jc*0.2; //Vung gia tri tren
Loline = jl+jc*0.2; //Vung gia tri duoi
midline = (jh-jl)/2; //Vung gia tri giua

R =  ( 4 * mySig1 + 3 * Ref(mysig1,-1) + 2 * Ref(mysig1,-2) + Ref(mysig1,-3) ) / 10;;

Rx =IIf(R>HiLine,1,IIf(R<loLine,0,2));
PA=SelectedValue(Rx);
GfxSelectSolidBrush( colorBlack ); 
GfxSelectPen( colorWhite );
GfxCircle( x+135,y+200,12);//GfxCircle( fvb+480,fvb-475,  10);
GfxCircle(  x+135,y+200,15);
GfxSelectFont("Times New Roman", 8, 800 );
GfxSetTextColor( colorLime ); 
GfxTextOut("Strength", x+120,y+235 ); 

for(i = 10; i < BarCount; i++)


if (PA[i]==1)
{
GfxSelectSolidBrush( colorLime ); 
GfxSelectPen( colorLime );
GfxCircle(  x+135,y+200,12);//GfxCircle( fvb+480,fvb-475,  10);
}
	else if (PA[i] == 0)
{
GfxSelectSolidBrush( colorRed ); 
GfxSelectPen( colorRed );
GfxCircle( x+135,y+200,12);//GfxCircle( fvb+480,fvb-475,  10);
}
	else 
{
GfxSelectSolidBrush( colorYellow ); 
GfxSelectPen( colorYellow );
GfxCircle( x+135,y+200,12);//GfxCircle( fvb+480,fvb-475,  10);
}

 


}
 

//-------------------------------------------------------------------

_SECTION_END();

//END Dash Board








//====================================================================================|
//                      11. Ichimoku Kinko Hyo                             |
//====================================================================================|


_SECTION_BEGIN("11. Ichimoku Kinko Hyo");



//*********************************************
//Cac thong so Ichimoku co ban 
// Cac con so quan trong trong Ichimoku: 9 / 17 / 26 / 33 / 42 / 65 / 76 / 129 / 172 / 200 / 257
// Bo so Ichimoku kieu so 1 (cac thong so goc theo truyen thong): Taken Sen 9 / Kijun Sen 26 / Chikou Span 26 / Span B 52 + Chon Dao gam 129
// Bo so Ichimoku kieu so 1 (phu hop cho thi truong ngan han o Viet Nam): Taken Sen 9 / Kijun Sen 17 / Chikou Span 26 / Span B 26 + Chon Dao gam 65
//*********************************************
 


//****Chon hieu Ichimoku so 1 hoac so 2
/*
 
//Chon bo so Ichimoku kieu so 1
 cprds1=9;
 cturn1=26;
 cdelay1=26;
 cspan1=52;
 cDG1=129;
 ctimeKumo1=26;
 
 //Chonj bo so Ichimoku kieu so2
 cprds2=9;
 cturn2=17;
 cdelay2=26;
 cspan2=33;
 cDG2=65;
 ctimeKumo2=26;
 */


SelectedIchimoku = ParamList( "* Chon kieu Ichimoku", "Ichimoku truyen thong 9-26-26-52-DG129|Ichimoku kieu VN 9-17-26-33-DG65", 1 );

switch ( SelectedIchimoku )
{

//*************Truong hop chon Kieu Ichimoku truyen thong so 1

case "Ichimoku truyen thong 9-26-26-52-DG129":

 cprds1=9;
 cturn1=26;
 cdelay1=26;
 cspan1=52;
 cDG1=129;
 ctimeKumo1=26;


//Tuy chon so phien Duong Taken Sen (Kieu truyen thong la 9 phien) - Giong duong trung binh ngan han 9 phien
prds = Param( "- Tenkan Sen - Turning Line Periods", cprds1, 5, 65, 1 );  

//Tuy chon so phien Duong Kijun Sen (Kieu truyen thong la 26 phien) - Giong duong trung binh trung han 26 phien 
// Co the thay doi sang kieu Ichimoku so 2 (17 phien)

turn = Param( "- Kijun Sen - Standard Line Periods", cturn1, 10, 129, 1 ); // Tuy chon theo yeu cau


//Duong tre Chikou Span - Duong Gia hien tai duoc lui ve 26 phien qua khu (Kieu truyen thong la 26 phien)
//Chikou Span giong vung Ho tro, Khang cu cua 26 phien qua khu (vung Ho tro khang cu ngan han cua hon 1 thang)
//Dung de xac nhan cho xu huong gia co vuot khang cu hoac ho tro khong
delay = Param( "- Chikou Span - Delayed Line Periods", cdelay1, 10, 129, 1 ); 

//Tuy chon so phien Duong Span B (Kieu truyen thong la 52 phien) 
// Co the thay doi sang kieu Ichimoku so 2 (26 phien)
span = Param( "- Senkou Span B - Spans Periods", cspan1, 10, 129, 1 ); 


//Tuy chon Dao gam - Duong ho tro dai han - Giong duong trung binh dai han 
//Thay doi giua 65 va 129 - so 65 phu hop danh ngan han o Viet Nam (Kieu Ichimoku so 2)
DG = Param("- Dao Gam - Duong ho tro dai han",cDG1, 20, 260, 1 ); 

// Time cua 26 phien (Kieu truyen thong la 26) (Dung cho ve duong may Kumo (Gom 2 duong Span A va SpanB) duoc day ve phia truoc de du doan tuong lai)
timeKumo=Param( "* Time - So ngay ve May Kumo tuong lai", ctimeKumo1, 10, 130, 1 );  




break;


//*************Truong hop chon Kieu Ichimoku kieu moi so2



case "Ichimoku kieu VN 9-17-26-33-DG65":

 //Chon bo so Ichimoku kieu so 2
 cprds2=9;
 cturn2=17;
 cdelay2=26;
 cspan2=33;
 cDG2=65;
 ctimeKumo2=26;



//Tuy chon so phien Duong Taken Sen (Kieu truyen thong la 9 phien) - Giong duong trung binh ngan han 9 phien
prds = Param( "- Tenkan Sen - Turning Line Periods", cprds2, 5, 65, 1 );  

//Tuy chon so phien Duong Kijun Sen (Kieu truyen thong la 26 phien) - Giong duong trung binh trung han 26 phien 
// Co the thay doi sang kieu Ichimoku so 2 (17 phien)

turn = Param( "- Kijun Sen - Standard Line Periods", cturn2, 10, 129, 1 ); // Tuy chon theo yeu cau


//Duong tre Chikou Span - Duong Gia hien tai duoc lui ve 26 phien qua khu (Kieu truyen thong la 26 phien)
//Chikou Span giong vung Ho tro, Khang cu cua 26 phien qua khu (vung Ho tro khang cu ngan han cua hon 1 thang)
//Dung de xac nhan cho xu huong gia co vuot khang cu hoac ho tro khong
delay = Param( "- Chikou Span - Delayed Line Periods", cdelay2, 10, 129, 1 ); 

//Tuy chon so phien Duong Span B (Kieu truyen thong la 52 phien) 
// Co the thay doi sang kieu Ichimoku so 2 (26 phien)
span = Param( "- Senkou Span B - Spans Periods", cspan2, 10, 129, 1 ); 


//Tuy chon Dao gam - Duong ho tro dai han - Giong duong trung binh dai han 
//Thay doi giua 65 va 129 - so 65 phu hop danh ngan han o Viet Nam (Kieu Ichimoku so 2)
DG = Param("- Dao Gam - Duong ho tro dai han",cDG2, 20, 260, 1 ); 

// Time cua 26 phien (Kieu truyen thong la 26) (Dung cho ve duong may Kumo (Gom 2 duong Span A va SpanB) duoc day ve phia truoc de du doan tuong lai)
timeKumo=Param( "* Time - So ngay ve May Kumo tuong lai", cdelay2, 10, 130, 1 );  




break;


}
 
 
 



 

//*********************************************
//Cac duong Ichimoku co ban
//*********************************************
//I. Dai may Sen duoc hinh thanh boi 2 duong Taken Sen va Kijun Sen (Dung de danh gia xu huong Gia hien tai)

    //1. Tenkan-Sen = Conversion Line = Turning Line = TS = TK - Giong duong trung binh ngan han 
        //Duong Taken Sen (Kieu truyen thong la 9 phien)
        //Taken Sen la muc binh quan giua gia cao nhat va thap nhat cua so 9 phien qua khu duoc chon
        //Taken Sen la vung ho tro, khang cu cua Gia qua khu ngan han 
        //Taken Sen do luong xu huong ngan han
        //Taken Sen do luong bien dong gia ngan han

TL = ( HHV( H, prds ) + LLV( L, prds ) )/2;

    //2 Kijun-Sen = Base Line =  Standard Line = SL = TL = = KJ - Giong duong trung binh trung han 26 phien 
        //Duong Kijun Sen (Kieu truyen thong la 26 phien)
        // Co the thay doi sang kieu Ichimoku so 2 (17 phien) phu hop danh ngan han o Viet Nam 
        //Kijun Sen la muc binh quan giua gia cao nhat va thap nhat cua so phien qua khu duoc chon
        //Kijun Sen la vung ho tro, khang cu cua Gia qua khu trung han 
        //Kijun Sen do luong xu huong trung han
        //Kijun Sen do luong bien dong gia trung han

SL = ( HHV( H, turn ) + LLV( L, turn) )/2;

    //3. Dao gam - Duong ho tro dai han - Giong duong trung binh dai han 
        // Bo so Ichimoku kieu so 1 (Kieu truyen thong) (cac thong so goc theo truyen thong): Taken Sen 9 / Kijun Sen 26 / Chikou Span 26 / Span B 52 + Chon Dao gam 129
        // Bo so Ichimoku kieu so 2 (phu hop cho thi truong ngan han o Viet Nam): Taken Sen 9 / Kijun Sen 17 / Chikou Span 26 / Span B 26 + Chon Dao gam 65
        //Thay doi giua 65 va 129 - so 65 phu hop danh ngan han o Viet Nam (Kieu Ichimoku so 2)
        // Dao gam la muc gia trung binh cua muc cao nhat va thap nhat cua So phien qua khu duoc chon
        // Dao gam la vung ho tro, khang cu cua Gia qua khu dai han
        // Dao gam do luong xu huong trung han
        // Dao gam do luong bien dong gia trung han

DG = ( HHV( H, DG ) + LLV( L, DG) )/2;


//II. Chikou Span = Lagging Span 
        //Duong tre Chikou Span - Duong Gia hien tai duoc lui ve so phien qua khu (Kieu truyen thong la 26 phien)
        //Chikou Span la vung ho tro, khang cu cua Gia qua khu 26 phien gan day (Hon 1 thang)
        //Dung de xac nhan cho xu huong qua khu
        //Hoac dung de danh gia cho xu huong hien tai
        //Neu Chikou cat len duong Gia - Xac nhan cho xu huong hien tai tang
        //Neu Chikou cat xuong duong Gia - Xac nhan cho xu huong hien tai giam

Lagging = Ref( C, -delay );

//III. Dai may Kumo duoc hinh thanh boi 2 duong Span A va Span B (Dung de du doan xu huong tuong lai)

        //May Kumo duoc ve tien ve phia truoc (Kieu truyen thong la 26 phien) the hien vung Ho tro va khang cu tiem nang trong tuong lai
        //Cho cai nhin ve buc tranh toan canh cua xu huong thi truong trong tuong lai
        //Giup danh gia moi quan he cua Gia trong xu huong hien tai dc so sanh voi du doan tuong tai co phu hop ko?
        //May Kumo cung cap vung Ho tro va khang cu dang tin cay nhat so voi cac vung ho tro khang cu khac
        //Neu Gia nam tren May Kumo (Gia hien tai cao hon muc trung binh cua qua khu) - Xu huong tang hien tai duoc xac nhan
        //Neu Gia nam duoi May Kumo (Gia hien tai thap hon muc trung binh cua qua khu) - Xu huong giam hien tai duoc xac nhan
        //Neu Gia nam trong May Kumo  - Khong co Xu huong ro rang. Thi truong di ngang SideWay (khong giao dich trong TH nay)

    //1. Senkou Span A = Leading Span A = (Tenkan-Sen + Kijun-Sen)/2
        //Duong Span A la binh quan gia cua duong Taken Sen va Kijun Sen. 
        //Span A duoc ve tien ve phia truoc (Kieu truyen thong la 26 phien) 
        //Day la Vung ho tro va khang cu tiem nang ngan han cua tuong lai (- Vung ho tro cua 1 thang gan day nhin huong toi 26 phien phia truoc) 
Span1 = (( SL + TL )/2);

    //2. Senkou Span B = Leading Span B = (Highest High + Lowest Low)/2
        //Duong Span B la binh quan cua muc gia cao nhat va thap nhat cua so phien duoc chon trong qua khu (Kieu truyen thong la 52 phien) 
        //Span B co the Thay doi thanh 26 phu hop danh ngan han o Viet Nam (Kieu Ichimoku so 2)
        //Span B uoc ve tien ve phia truoc theo so phien da chon (Kieu truyen thong la 26 phien)  
        //Day la Vung ho tro va khang cu tiem nang trung han cua tuong lai (- Vung ho tro cua 2 thang gan day nhin huong toi 26 phien phia truoc) 

Span2 = (HHV( H, span) + LLV(L, span))/2;

    //Du doan tuong lai qua su giao cat giua 2 duong Span A va Span B
        //Neu Span A nam tren Span B hoac Span A cat len tren Span B: du doan cho xu huong tang tuong lai
        //Neu Span A nam duoi Span B hoac Span A cat xuong duoi Span B: du doan cho xu huong giam tuong lai
        //Neu Span A giao cat voi Span B: du doan xu huong co the thay doi
        
    //Du doan tuong lai qua Phan tich do Day Mong cua may Kumo
        //Neu may Kumo Day: Bien dong gia lon, dong thoi cho muc Ho tro va khang cu vung chac hon may Kumo mong
        //Neu may Kumo Mong: Bien dong gia thap, thi truong it bien dong, dong thoi cho muc Ho tro va khang cu kem hon may Day
        
    //Hien tuong May Kumo phang (nam ngang): 
        //Co the phang o phia tren hoac phia duoi Do viec tinh toan la muc cao nhat va thap nhat trong 52 Phien (tuong ung voi muc Fibonacci 50%) 
        //Viec Kumo Flat the hien Muc ho tro va Khang cu dang duoc duy tri trong so ky duoc chon
        //The hien suc manh cua vung Ho tro va khang cu. Gia co xu huong hut ve phia vung nay de tim trang thai can bang moi
        //Trong xu huong tang, Senkou Span B flat tao ra flat bottom Kumo phia duoi.
        //Trong xu huong giam, Senkou Span B flat tao ra flat top Kumo phia tren.
        //Vung Flat nay giup du doan tuong lai rang xu the gia sap toi co khung huong tien ve gap duong Flat




//************************************************
// Cac quy tac cua tin Hieu Mua Ban theo Ichimoku
//************************************************

//************Cac tin hieu Mua ban co ban*********

//1. Chien luoc giao cat giua Tenkan Sen ngan han va Kijun Sen trung han (Danh gia xu huong hien tai)

     //TenkanSen cat len Kijun Sen: Xu huong tang hien tai duoc xac nhan
     //TenkanSen cat xuong Kijun Sen: Xu huong giam hien tai duoc xac nhan
     
  //Luu y: tin hieu giao cat nay can co su xac nhan tu cac thanh phan khac cua he thong Ichimoku
  
  //Cuong do tin hieu giao cat nay duoc do luong khi so sanh vi tri cua no voi may Kumo

     //Tin hieu Manh: Buy khi TenkanSen cat len Kijun Sen va vi tri nam o phia tren may Kumo
     //Tin hieu Manh: Sell khi TenkanSen cat xuong Kijun Sen va vi tri nam o phia duoi may Kumo

     //Tin hieu Trung binh: Buy khi TenkanSen cat len Kijun Sen va vi tri nam ben trong may Kumo
     //Tin hieu Trung binh: Sell khi TenkanSen cat xuong Kijun Sen va vi tri nam ben trong may Kumo

     //Tin hieu Yeu: Buy khi TenkanSen cat len Kijun Sen va vi tri nam o phia duoi may Kumo
     //Tin hieu Yeu: Sell khi TenkanSen cat xuong Kijun Sen va vi tri nam o phia tren may Kumo

  //Cac tin hieu giao cat tren can co su Xac nhan them cua duong Chikou Span

     //Neu su giao cat la tang gia xay ra, dong thoi duong Chikou Span nam tren duong gia thi tin hieu tang cang Manh
     //Neu su giao cat la giam gia xay ra, dong thoi duong Chikou Span nam duoi duong gia thi tin hieu giam cang Manh
     //Neu  su giao cat do nam doi dien nguoc voi duong Chikou Span qua duong Gia thi tin hieu giao cat (Tang hoac giam) la Yeu

  //Vao lenh Mua Ban tai vi tri giao cat Tenkan Sen va Kijun Sen (can xem xet them muc ho tro va khang cu gan nhat). 
  //Vao lenh Mua khi gia nam tren moc ho tro va lenh Short khi gia nam duoi moc khang cu
  //Chot loi, Cutloss, dong giao dich khi Tenkan Sen cat Kijun Sen theo huong nguoc lai hoac cac quy tac quan ly von khac



//2. Chien luoc giao cat giua Span A va Span B (Du doan xu huong tuong lai)

     // Span A cat len Span B: Du doan Xu huong tuong lai tang 
     // Span A cat xuong Span B: Du doan Xu huong tuong lai giam 
     
  //Luu y: Su giao cat nay can co su xac nhan cua cac thanh phan khac cua he thong Ichimoku

  //Cuong do tin hieu giao cat Span A va B duoc phan thanh

     //Tin hieu Manh: Khi gia nam ben ngoai may Kumo va gia nam cung huong voi phia giao cat (so sanh vi tri voi voi Kumo)
     //Tin hieu Trung binh: Khi gia nam trong  may Kumo tai thoi diem giao cat xay ra
     //Tin hieu Yeu: Khi gia nam ben ngoai may Kumo va gia nguoc huong voi phia giao cat (so sanh vi tri voi voi Kumo)

//3. Chien luoc giao cat giua Gia va duong Chikou Span

     //Chikou Span duoc dung de danh gia cho xu huong qua khu, no co the duoc su dung doc lap rieng biet hoac ket hop voi cac thanh phan khac cua Ichimoku
     //Neu Chikou Span cat len tren duong Gia: Xu huong tang hien tai duoc xac nhan (Vuot khang cu)
     //Neu Chikou Span cat xuong duoi duong Gia: Xu huong giam hien tai duoc xac nhan (Pha ho tro)

  //Cuong do cua tin hieu giao cat duong Chikou Span voi duong Gia duoc chia thanh 3 cap do

     //*Tin hieu Manh
     //Buy: Chikou Span cat len tren duong Gia va Gia hien tai nam tren may Kumo
     //Sell: Chikou Span cat xuong duoi duong Gia va Gia hien tai nam duoi may Kumo

     //*Tin hieu Trung binh
     //Buy: Chikou Span cat len tren duong Gia va Gia hien tai nam trong may Kumo
     //Sell: Chikou Span cat xuong duoi duong Gia va Gia hien tai nam trong may Kumo

     //*Tin hieu Yeu
     //Buy: Chikou Span cat len tren duong Gia va Gia hien tai nam duoi may Kumo 
     //Sell: Chikou Span cat xuong duoi duong Gia va Gia hien tai nam tren may Kumo

//*Thoi diem mo lenh giao dich ngay tai vi tri giao cat Chikou Span va duong Gia
//*Ket thuc giao dich, chot loi, cat lo theo cac quy tac khac ngoai he thong Ichimoku hoac khi Chikou Span cat duong Gia o huong nguoc lai



//************************************************
//   Tin Hieu Mua Ban theo Ichimoku
//************************************************


//I. So sanh Gia voi May Kumo, May Sen va duong Chikou Span

   //1. So sanh Gia va May Kumo (2 duong Span A va Span B)
   //Dung de danh gia ve Xu huong trung han hien tai


      //A. Gia vuot tren may Kumo - Gia vuot ca 2 duong Span A va Span B 
      //Xu huong tang trung han duoc xac nhan
aboveKumo=IIf((C>=Ref(Span1,-timeKumo) AND C>=Ref(Span2,-timeKumo)),1,0);

      //B. Gia Nam trong vung may Kumo - nam giua Span A va Span B
      //Xu huong trung han khong ro rang
withinKumo=IIf((C>=Ref(Span2,-timeKumo) AND C<=Ref(Span1,-timeKumo)),1,0) OR IIf((C>=Ref(Span1,-timeKumo) AND C<=Ref(Span2,-timeKumo)),1,0);

      //C. Gia cat xuong may Kumo - Gia cat xuong ca 2 duong Span A va Span B
      //Xu huong giam trung han duoc xac nhan
belowKumo=IIf((C<=Ref(Span1,-timeKumo) AND C<=Ref(Span2,-timeKumo)),1,0);


   //2. So sanh Gia va May Sen (2 duong trung binh Taken Sen va Kijun Sen) 
   //Dung de danh gia ve Xu huong ngan han hien tai 


      //A. Gia vuot tren may Sen - Gia vuot ca 2 duong Taken Sen va Kijun Sen
      //Xu huong tang ngan han hien tai duoc xac nhan
aboveSenCloud = IIf ( (C > Ref(TL,-prds) AND  C > Ref(SL,-turn)),1,0); 

      //B. Gia Nam trong vung may Sen - nam giua duong Taken Sen va Kijun Sen
      //Xu huong ngan han hien tai khong ro rang
withinSenCloud = IIf ((C >=Ref(TL,-prds) AND C<=Ref(SL,-turn)),1,0) OR IIf((C>=Ref(SL,-turn) AND C<=Ref(TL,-prds)),1,0); 

      //C. Gia cat xuong may Sen - Gia cat xuong ca 2 duong Taken Sen va Kijun Sen
      // Xu huong giam ngan han hien tai duoc xac nhan
belowSenCloud = IIf ((C <=Ref(TL,-prds) AND C<=Ref(SL,-turn)),1,0)  ; 

//***************************Chon timeKumo (co the thay doi) hay chon t2=26 (co dinh)****************



   //3. So sanh gia voi duong tre Chikou Span
   //Price26 above Lagging, lag26 above C, Lag26 is rising 
   //Duong Chikou Span nam tren duong Gia cua 26 phien truoc, Duong Chikou Span dang tang len - Xu huong hien tai dang tang

      //dlUp - Xu huong hien tai Tang gia: 
      //Gia tang so voi hom qua va duong Chikou Span cat len duong Gia
      //Vuot vung khang cu ngan han (1 thang)
      //Xu huong tang ngan han hien tai duoc xac nhan
dlUp =   (Ref(C,-(delay+1)) > C ) AND  Ref(C,-delay) < C AND C > Ref(C,-1); 

      //dlDown - Xu huong hien tai Giam gia: 
      //Gia giam so voi hom qua va duong Chikou Span cat xuong duong Gia
      //Pha vung ho tro ngan han (1 thang)
      //Xu huong giam ngan han hien tai duoc xac nhan
      
dlDown = (Ref(C,-(delay+1)) < C ) AND  Ref(C,-delay) > C AND C < Ref(C,-1); 



//II. So sanh Gia voi cac duong trung binh Taken Sen, Kijun Sen va ca voi May Kumo va May Sen
//Phoi hop danh gia cac thanh phan cua he thong Ichimoku voi nhau

//1. Tenkan Sen / Kijun Sen Cross - Giao cat giua duong trung binh ngan han Taken Sen va trung han Kijun Sen

             //************** Tin hieu Mua ******************

        //Tin hieu xu huong tang ngan han hien tai khi duong ngan han Tenkan Sen cat len duong trung han Kujun Sen

        //Tin hieu Mua so 2 (Tinhieu2)
        //Duong ngan han Tenkan Sen cat len duong trung han Kijun Sen, Gia vuot may Kumo va Gia cat len duong ngan han Taken Sen 
        //Tinhieu2 Manh hon Tinhieu1

BuyStrongTKCross = Cross(TL,SL) AND aboveKumo AND C > TL  AND C > Ref(C,-1); //OK

        //Tin hieu Mua so 3 (Tinhieu3)
        //Kijun Sen Cross 
        //Gia cat len duong trung han Kijun Sen va Gia vuot tren duong ngan han Taken Sen va duong ngan han Taken Sen cat len duong trung han Kijun Sen va gia vuot tren may Kumo
        //Tinhieu3 manh hon Tinhieu2

BuyStrongPriceCross = (Cross(C,SL)  AND (C > TL)  and C > SL AND (TL > SL) AND aboveKumo  AND C > Ref(C,-1)) 
                   OR (Cross(C,TL)  AND (C > TL)  and C > SL AND (TL > SL) AND aboveKumo  AND C > Ref(C,-1)) ; //OK 

             //************** Tin hieu Ban ******************

        //Tin hieu Ban - Xuat hien khi Gia cat xuong duong Kijun Sen
        // A bearish signal occurs when the PRICE crosses from above to below the Kijun Sen

        //Tin hieu ban ngan han Yeu 
        //Tin hieu ban ngan han Yeu xuat hien khi Gia cat xuong duong trung han Kijun Sen va gia van nam tren may Kumo
SellWeakPriceCross = Cross(SL,C) AND aboveKumo;

        //Tin hieu ban ngan han Trung lap (Ko ro rang)
        //Tin hieu ban ngan han Trung lap (Ko ro rang) xuat hien khi Gia cat xuong duong trung han Kijun Sen va gia nam trong may Kumo
SellNeutralPriceCross = Cross(SL,C) AND withinKumo;

        //Tin hieu ban ngan han Manh
        //Tin hieu ban ngan han Manh xuat hien khi Gia cat xuong duong trung han Kijun Sen va gia nam duoi may Kumo
SellStrongPriceCross = Cross(SL,C) AND belowKumo;

             //*************** Tin hieu pha vo may Kumo - Kumo Breakout ***************
			
        //The Kumo Breakout signal occurs when the price leaves or crosses the Kumo (Cloud).

        //Tin hieu Mua so 1 (Tinhieu1)
        // Tin hieu Mua Kumo Breakout khi gia tu trong may vuot len tren May Kumo hoac tu duoi may vuot len tren may Kumo dong thoi gia vuot duong trung han Kujun Sen va vuot ngan han Tenkan Sen

BuyKumoBreakout = ((aboveKumo AND Ref(withinKumo,-1)) OR (aboveKumo AND Ref(belowKumo ,-1))) AND C > SL AND  C> TL  AND C > Ref(C,-1); //OK

        //Tin hieu Ban khi pha vo may Kumo
        //Ban khi Gia tu trong may cat xuong may Kumo hoac tu tren may cat xuong may Kumo
SellKumoBreakout = belowKumo AND Ref(withinKumo,-1)   OR (belowKumo AND Ref(aboveKumo ,-1));

        //Tin hieu mua khi Gia vuot may Sen
        //Mua khi gia tu trong may Sen vuot len tren may Sen hoac tu duoi May Sen vuot len tren may Sen
BuySenBreakout = ((aboveSenCloud AND Ref(withinSenCloud ,-1)) OR (aboveSenCloud AND Ref(belowSenCloud ,-1)))  AND C > Ref(C,-1); //OK


//2. Tin hieu giao cat cua 2 duong may Span A va B (Dung de du doan tuong lai)
     //Bao hieu dau hieu thay doi xu huong tiem nang co the xay ra trong tuong lai
     //Tin hieu dau tien duoc nhin thay khi duong Span A cat duong Span B o phia truoc
     //Do cac duong Span A va B duoc ve ve phia truoc 26 ngay nen khi tin hieu giao cat xuat hien o phia truoc 26 ngay
     //Thi ngay xuat hien tin hieu giao cat thuc su hien tai
     //Do Manh cua tin hieu duoc xac dinh boi moi quan he cua Gia voi may Kumo trong ngay xay ra tin hieu giao cat do (khong phai yeu to kich hoat lenh Mua Ban)
     //Xu huong tang xuat hien khi Senkou Span A cat tu duoi len Senkou Span B

             //************** Tin hieu Mua ******************


     //Tin hieu mua so 4 (Tinhieu4)
     //Gia nam tren May Kumo va Span A cat len Span B 
     //Tin hieu mua gia tang trong xu huong tang Trung han

BuyStongSenkouSpanCross = aboveKumo AND Cross(span1,span2)  AND C > Ref(C,-1); //OK

//3. Tin hieu giao cat voi duong tre Chikou Span
     //Xay ra khi duong tre giao cat voi duong Gia (Tang len hoac giam xuong duong Gia)
     //Xu huong tang khi Chikou Span tang len va cat len duong Gia
     //Xu huong giam khi Chikou Span giam xuong va cat xuong duong Gia
     //Luu y: Su giao cat giua duong Chikou Span va duong Gia khi dung 1 minh ko du manh cho cac tin hieu Mua - Ban (phai ket hop voi cac dieu kien khac)
     //Vi Chikou Span la gia dong cua hien tai duoc lui ve qua khu 26 ngay.
     //Do do trong ngay xuat hien tin hieu giao cat, do Manh cua tin hieu phai duoc xac nhan boi moi quan he giua Gia va may Kumo
     //Do do mot minh yeu to giao cat giua duong Chikou Span va duong Gia khong phai yeu to kich hoat lenh Mua Ban
     //Xu huong tang hien tai duoc xac nhan khi Chikou Span cat tu duoi len tren duong Gia


     //Tin hieu mua so 5 (Tinhieu5)
     //Gia nam tren may Kumo va tin hieu tang gia dlUp va Gia cat len duong ngan han Taken Sen
     
     //dlUp - Tang gia: Gia tang so voi hom qua va Gia giao cat voi duong Chikou Span
      //Gia tang vuot vung khang cu ngan han (1 thang)
      //Xu huong tang ngan han duoc xac nhan
    

BuyStrongChikouSpanCross = aboveKumo AND dlUp AND C > TL; //OK (da co DK  AND C > Ref(C,-1) trong dlUP)

//************************************************
//   Tong hop cac tin hieu Mua (Long) theo Ichimoku
//************************************************


//1. Tin hieu Mua so 1 (Tinhieu1)

//Tin hieu Mua Kumo Breakout khi gia tu trong may vuot len tren May Kumo hoac tu duoi may vuot len tren may Kumo dong thoi gia vuot duong trung han Kujun Sen
//Xu huong tang trung han duoc xac nhan

TinHieu1 = BuyKumoBreakout AND TL> SL ;

//BuyKumoBreakout = ((aboveKumo AND Ref(withinKumo,-1)) OR (aboveKumo AND Ref(belowKumo ,-1))) AND C > SL AND C > Ref(C,-1);

//2. Tin hieu Mua so 2 (Tinhieu2)

//Duong ngan han Tenkan Sen cat len duong trung han Kijun Sen, Gia vuot may Kumo va Gia cat len duong ngan han Taken Sen 
//Tinhieu2 Manh hon Tinhieu1

TinHieu2 = BuyStrongTKCross ;

//BuyStrongTKCross = Cross(TL,SL) AND aboveKumo AND C > TL AND C > Ref(C,-1);

//3. Tin hieu Mua so 3 (Tinhieu3)

//Gia cat len duong trung han Kijun Sen va Gia vuot tren duong ngan han Taken Sen va duong ngan han Taken Sen cat len duong trung han Kijun Sen va gia vuot tren may Kumo
//Tinhieu3 manh hon Tinhieu2

TinHieu3 = BuyStrongPriceCross ;

//BuyStrongPriceCross = Cross(C,SL) or Cross(C,TL) AND (C > TL) AND (TL > SL) AND aboveKumo AND C > Ref(C,-1);


//4. Tin hieu mua so 4 (Tinhieu4)

//Gia nam tren May Kumo va Span A cat len Span B 
//Tin hieu mua gia tang trong xu huong tang Trung han truoc do
//Tinhieu4 manh hon Tinhieu3

TinHieu4 = BuyStongSenkouSpanCross AND C > TL AND C > SL AND TL > SL;

//BuyStongSenkouSpanCross = aboveKumo AND Cross(span1,span2) AND C > Ref(C,-1);

//5. Tin hieu mua so 5 (Tinhieu5)

//Gia nam tren may Kumo va tin hieu tang gia dlUp va Gia cat len duong ngan han Taken Sen
      //dlUp - Tang gia: Gia tang so voi hom qua va Gia giao cat voi duong Chikou Span
                       //Gia tang vuot vung khang cu ngan han (1 thang)
                       //Xu huong tang ngan han duoc xac nhan
//Tinhieu5 manh hon Tinhieu4

TinHieu5 = BuyStrongChikouSpanCross and C > SL and TL > SL ;

//BuyStrongChikouSpanCross = aboveKumo AND dlUp AND C > TL; //OK (da co DK  AND C > Ref(C,-1) trong dlUP)


//6. Tin hieu Vuot May - Gia Vuot may Sen va duong Tenkan Sen va Kijun Sen

//Tin hieu mua khi Gia vuot may Sen (Mua khi gia tu trong may Sen vuot len tren may Sen hoac tu duoi May Sen vuot len tren may Sen) va Gia cat len duong ngan han Tenkan Sen va gia cat len duong trung han Kijunsen
//VuotMay manh hon Tinhieu5

VuotMay = BuySenBreakout AND C>TL AND C>SL AND  C > Ref(C,-1);

//BuySenBreakout = ((aboveSenCloud AND Ref(withinSenCloud ,-1)) OR (aboveSenCloud AND Ref(belowSenCloud ,-1)));

//7. Tin hieu Vuot May Sen va may Kumo

//Tin hieu mua khi Gia vuot may Sen (Mua khi gia tu trong may Sen vuot len tren may Sen hoac tu duoi May Sen vuot len tren may Sen)
//Va Tin hieu Mua Kumo Breakout khi gia tu trong may vuot len tren May Kumo hoac tu duoi may vuot len tren may Kumo dong thoi gia vuot duong trung han Kujun Sen
//VuotMaySenKumo manh hon VuotMay

VuotMaySenKumo = BuySenBreakout AND BuyKumoBreakout  AND C>TL AND C>SL AND  C > Ref(C,-1); 

//BuySenBreakout = ((aboveSenCloud AND Ref(withinSenCloud ,-1)) OR (aboveSenCloud AND Ref(belowSenCloud ,-1)));
//BuyKumoBreakout = ((aboveKumo AND Ref(withinKumo,-1)) OR (aboveKumo AND Ref(belowKumo ,-1))) AND C > SL;


//8. Tin hieu HopBich

//HopBich la tin hieu giao cat cua duong Tenkan Sen va Kijun Sen va va nam trong xu the tang dai han boi duong Dao Gam va duong Tenkan Sen van trong xu the tang va Gia van nam tren Tenkan Sen
//The hien Xu huong tang ngan han van duong giu vung
//Tin hieu mua gia tang trong xu the tang truoc do

HopBich = (Ref(TL,-1) == Ref(SL,-1)) AND ( (TL==SL) AND (SL>=DG) )  AND (TL > Ref(TL,-1)) AND (C>TL)  AND C>SL   AND C > Ref(C,-1) ; //OK


//********Tong hop hien thi cac tin hieu Mua Ichimoku*************

Muaichi  = TinHieu1 OR TinHieu2 OR TinHieu3 OR TinHieu4 OR TinHieu5 OR VuotMay OR VuotMaySenKumo OR HopBich  ;




//************************************************
//   Tong hop cac tin hieu Ban (Short) theo Ichimoku
//************************************************

/*





Them vao cac dieu kien Ban













*/



//***********************************************************************
//Bat tat tinh nang hien thi cac tin hieu Mua Ban va cac duong Ichimuko
//***********************************************************************


IchimokuOnOff = ParamToggle("* Hien thi Ichimoku Kinko Hyo ","OFF|ON",0);


if(IchimokuOnOff==1)
{

 
 

//************************************************
//    Ve cac tin hieu Mua Ban Ichimoku
//************************************************



dist = 2.5*ATR(10); 
dist1 = 1.5*ATR(10); 


for( i = 0; i < BarCount; i++ ) 
{ 
if ( VuotMay[i] ) 
	PlotText( "Sen", i , L[ i ]-dist[i], colorBlack, colorBrightGreen ) ;
if (VuotMaySenKumo[i] AND VuotMay[i]  AND (span1[i] > span2[i]) AND (TL[i]>SL[i]))
	PlotText( "Bom No", i , L[ i ] - dist1[i], colorBlack, colorYellow ); 
} 

//Tin hieu Mua so 1
PlotShapes( IIf( TinHieu1 , shapeUpArrow + shapeDigit1 , shapeNone ), colorBlue, 0, L, Offset =20 );
PlotShapes( IIf( TinHieu1 , shapeUpArrow , shapeNone ), colorBlue, 0, L, Offset =-35 );

//Tin hieu Mua so 2
PlotShapes( IIf( TinHieu2 , shapeUpArrow + shapeDigit2 , shapeNone ), colorBlue, 0, L, Offset =20 );
PlotShapes( IIf( TinHieu2 , shapeUpArrow , shapeNone ), colorBlue, 0, L, Offset =-35 );

//Tin hieu Mua so 3
PlotShapes( IIf( TinHieu3 , shapeUpArrow + shapeDigit3 , shapeNone ), colorBlue, 0, L, Offset =5 );
PlotShapes( IIf( TinHieu3 , shapeUpArrow , shapeNone ), colorBlue, 0, L, Offset =-35 );

//Tin hieu Mua so 4
PlotShapes( IIf( TinHieu4 , shapeUpArrow + shapeDigit4 , shapeNone ), colorBlue, 0, L, Offset =50 );
PlotShapes( IIf( TinHieu4 , shapeUpArrow , shapeNone ), colorBlue, 0, L, Offset =-35 );

//Tin hieu Mua so 5
PlotShapes( IIf( TinHieu5 , shapeUpArrow + shapeDigit5 , shapeNone ), colorBlue, 0, L, Offset =20 );
PlotShapes( IIf( TinHieu5 , shapeUpArrow , shapeNone ), colorBlue, 0, L, Offset =-35 );

//Tin hieu Mua Vuot May Sen
PlotShapes( IIf( VuotMay AND (Span1>Span2) , shapeUpArrow , shapeNone ), colorGreen, 0, L, Offset =-25 );

//Tin hieu Mua Vuot May Sen va May Kumo
PlotShapes( IIf( VuotMaySenKumo AND VuotMay AND Span1 > Span2 , shapeUpArrow + shapeCircle, shapeNone ), colorBrightGreen, 0, L, Offset =40 );

//Tin hieu Chu y: Dau hieu giao cat Tenkan Sen va Kijun Sen trong xu huong tang trung han
//Tin hieu Mua gia tang them vi then
PlotShapes( IIf( HopBich , shapeUpArrow + shapeStar, shapeNone ), colorYellow, 0, L, Offset = 60 );



//*********************************************************************************
//  Ve cac duong co ban cua Ichimoku
//*********************************************************************************

//Ve duong Tenkan Sen va Kijun Sen
  
Plot(TL ,"Tenkan Sen ",colorLightOrange,styleThick); //Duong TenkanSen
Plot(SL,"Kijun Sen",colorBlue,styleThick); // Duong Kijun Sen

//Ve May Sen va chon mau May Sen 
PlotOHLC( TL, SL, TL, SL, "", IIf(TL>SL,colorSkyblue, colorTeal),styleCloud );

// Ve duong Dao Gam

Plot(DG,"Dao Gam - Muc ho tro dai han",colorYellow,styleThick); //Duong ho tro dai han Dao Gam

// Ve duong Chikou Span
Plot(C,"",colorLightGrey,styleThick|styleThick,Null,Null,-delay); // Duong Delayed, Lagging, OR Chikou span

// Ve duong Senkou Span A va Senkou Span B
Plot(Span1,"",colorGreen,1,0,0,timeKumo); // Duong Senkou span A
Plot(Span2,"",colorViolet,1,0,0,timeKumo); // Duong Senkou span B

//Ve May Kumo, chon mau May Kumo va day tien ve phia truoc 26 phien
PlotOHLC(Span1,Span2,Span1,Span2,"",IIf(Span1>Span2,colorLime,colorLightOrange),styleCloud|4096,0,0,timeKumo); 

// Ve Ribbon - Xac dinh xu huong
XacDinhXuHuong = (TL >= SL) AND (C>=DG); //Tenkan Sen nam tren Kijun Sen va Gia nam tren duong ho tro dai han Dao gam
Color = IIf(XacDinhXuHuong, colorGreen, colorRed ); 
Plot( 1, "", Color, styleArea | styleOwnScale | styleNoLabel, -0.1, 50 );  

}
 





_SECTION_END();

//***************************************************************
// END Ichimoku Kinko Hyo 
//***************************************************************





//******************************************************************************
// CandleStick Pattern Recognition (first part) - Nhan dang cac mo hinh Nen Nhat
//******************************************************************************

// The bullish kicker candlestick pattern is a two-day reversal pattern that is often used to alert investors of impending market strength. - See more at: http://backtestwizard.com/amibroker-afl-bullish-kicker-candlestick-pattern/#sthash.WyxEewJL.dpuf
BullishKicker = Ref(O,-1) > Ref(C,-1) AND O >= Ref(H,-1) AND C > O AND L > Ref(H,-1) ;

VolAvg = MA( V, 14 );
VolumeIdx = V / VolAvg;
AvgRange = Sum( abs(O-C),15 )/15;

/* Candle Codes */
White = IIf((C>O) AND ((C-O)>=0.8*(H-L)),1,0) AND (C-O)>AvgRange;
Black = IIf((C<O) AND ((O-C)>=0.8*(H-L)),1,0) AND (O-C)>AvgRange;
Doji  = IIf(abs(O-C)<=0.1*(H-L),1,0);

/* Dark Cloud Cover [Bear] */
DCC = IIf(Ref(White, -1) AND Black AND C<=Ref(((H+L)/2),-1) AND O>Ref(C,-1), 1,0);

/* Piercing Line [Bull] */
PL = IIf(Ref(Black, -1) AND White AND C>=Ref(((H+L)/2),-1) AND O<Ref(C,-1), 1,0);

/* Evening Doji Star [Bear] */
EDS = IIf(Ref(White, -2) AND Ref(Doji, -1) AND Black AND C<=Ref(((H+L)/2),-2), 1,0);

/* Morning Doji Star [Bull] */
MDS = IIf(Ref(Black, -2) AND Ref(Doji, -1) AND White AND C>=Ref(((H+L)/2),-2), 1,0);

/* Hammer [Bull] */
HAM = IIf( (H-L > 1.5*AvgRange) AND (C > (H+L)/2)  AND (O > C) AND (VolumeIdx > 2), 1, 0);

/* Bearish Engulfing */
BRE = IIf(Black AND Ref(White, -1) AND (C < Ref(O, -1))  AND (O > Ref(C, -1)),1,0);

/* Bullish Engulfing */
BLE = IIf(White AND Ref(Black, -1) AND (C > Ref(O,-1))  AND (O < Ref(C,-1)),1,0);

//Showing Candle Stick Pattern Signal on chart - Hien thi cac dau hieu cua Mo hinh Nen Nhat

//PlotShapes( IIf( BullishKicker , shapeUpTriangle, shapeNone ), colorBlue, 0, L, Offset = -40 );
//PlotShapes( IIf( DCC, shapeDownTriangle, shapeNone ), colorRed, 0, L, Offset = -60 );

//r=CdDoji( threshold = 0.05 );
//s=CdHammer( rangefactor= 1.1 );
//t=CdBearishEngulfing( bodyfactor = 0.4, rangefactor = 0.5);
//PlotShapes(r*shapeSmallCircle,colorRed,Layer=0,yposition=H,Offset=12); 
//PlotShapes(s*shapeCircle,colorYellow,Layer=0,yposition=H,Offset=12); 
//PlotShapes(t*shapeHollowSmallCircle,colorLime,Layer=0,yposition=H,Offset=12); 
//u=CdBullishEngulfing( bodyfactor = 0.4, rangefactor = 0.5);
//PlotShapes(u*shapeHollowCircle,colorBlue,Layer=0,yposition=H,Offset=15); 

//for(i=0;i<BarCount-1;i++) 
//{
//	if(r[i]==True)PlotText("Doji", i, H[i], colorRed, bkcolor = colorDefault); 
//	if(s[i]==True)PlotText("Hammer", i, H[i], colorYellow, bkcolor = colorDefault); 
//	if(t[i]==True)PlotText("BearishEngulf", i, H[i], colorLime, bkcolor = colorDefault); 
//	if(u[i]==True)PlotText("BullishEngulf", i, H[i], colorBlue, bkcolor = colorDefault); 
//}



// Candlestick Pattern Exploration - Bo loc cac mo hinh Nen Nhat


WhiteBody = C > O;
BigWhite = (Close - Open)/Open > 0.015 AND (Close - Open) * 2 > High - Low;
BlackBody = C < O;
BigBlack = (Open - Close)/Open > 0.015 AND (Open - Close) * 2 > High - Low;
Big = abs((Close - Open)/Open) > 0.014;
LongUpperShadow = H - Max(O,C) > (H - L)*0.67;
LongLowerShadow = Min(O,C) - L > (H - L)*0.67;
rng = abs((C-O)/O);
lowerShadow = Min(O,C) - L;
uppershadow = H - Max(O,C);
body = abs(O-C);
rngx = abs(H - L);
rngy = H-L;
shaven = lowerShadow < rngy*0.1;
ShavenBottom = L == Min(O,C);
ShavenHead = H == Max(O,C);
prevSize = abs(Ref(O,-1)-Ref(C,-1));
currentSize = abs(O-C);
fwh = Ref(H,-4);
fwl = Ref(L,-4); 
isPrevLargeWhite = Ref(big,-1) AND Ref(whitebody,-1);
SmallRealBody = rng < 0.003 AND rng >0;	
Diff = abs((prevSize - currentSize) / IIf(currentSize == 0, 0.0000001, currentSize));
DownTrend = (H < Ref(H,-1) AND L < Ref(L,-1));
UpTrend = (H > Ref(H,-1) AND L > Ref(L,-1));
isPrevUpTrend = Ref(uptrend,-1);
RealBodyGapUp = Min(O,C) > Max(Ref(O,-1),Ref(C,-1));
RealBodyGapDown = Max(O,C) < Min(Ref(O,-1),Ref(C,-1));
FallingWindow = Ref(downtrend,-1) AND GapDown();
RisingWindow = Ref(uptrend,-1) AND GapUp();
isfalling = bigblack AND fallingwindow;
isrising = bigwhite AND risingwindow;
rwh = Ref(H,-4);
rwl = Ref(L,-4);
isFallingBlack = Ref(fallingwindow,-1) AND Ref(blackbody,-1);
horw = Ref(H,-2); 
windowOpen = C < horw;
opensInside = O < Ref(O,-1) AND O > Ref(C,-1);
similarSize = diff <= 0.25;
GapUpFromWhite = realBodyGapUp AND isPrevLargeWhite AND isPrevUptrend;
isPrevLargeBlack = Ref(big,-1) AND Ref(blackbody,-1);
isPrevDownTrend = Ref(downtrend,-1);
GapDownFromBlack = realBodyGapDown AND isPrevLargeBlack AND isPrevDowntrend;
isRisingWhite = Ref(risingwindow,-1) AND Ref(whitebody,-1);
lorw = Ref(L,-2);
windowOpenx = C > lorw;
Doji = C == O AND V > 0;
LongLeggedDoji = doji AND (H - L)/L > 0.01;
StarUp = smallRealBody AND gapUpFromWhite;
DojiStarUp = doji AND gapUpFromWhite;
DojiStarDown = doji AND gapDownFromBlack;
StarDown = smallRealBody AND gapDownFromBlack;
isPrevDownTrendx = Ref(downtrend,-3);
firstDoji = Ref(doji,-2); 
secDojiLower = Ref(doji,-1) AND Ref(realBodyGapDown,-1);
isPrevUpTrendx = Ref(uptrend,-3);
secDojiHigher = Ref(doji,-1) AND Ref(realBodyGapUp,-1);
BeltHold = shavenbottom AND shavenhead AND big;
Engulfing = Max(O,C) > Ref(Max(O,C),-1) AND Min(O,C) < Ref(Min(O,C),-1);
UmbrellaLine = uppershadow < rngx*0.1 AND lowershadow > body*2; 
//====================================================================================================

//----------------------------------------
// Bearish
//----------------------------------------

// Kicker
KBR = Ref(O,-1) < Ref(C,-1) AND O <= Ref(O,-1) AND C <= O;

//Evening Doji Star
EveningDojiStar = Ref(dojiStarUp,-1) AND blackbody AND big AND C < Ref((O + C)/2,-2);
/*
A large white candlestick followed by a doji that gaps up from the
previous candles real body. This is followed by a third candlestick that is black and has a
close lower than the half way point of the first candlesticks real body. Must be preceeded by an uptrend.
*/

// Evening Star
EveningStar = Ref(starUp,-1) AND blackbody AND big AND C < Ref((O + C)/2,-2);
/*
A large white candlestick followed by a small real body of either colour that gaps up from the
previous candles real body. This is followed by a third candlestick that is black and has a
close lower than the half way point of the first candlesticks real body. Must be preceeded by an uptrend.
*/

// Grave Stone Doji
GraveStoneDoji = longleggeddoji AND L == C AND Ref(uptrend,-1);
/*
A doji with no lower shadow and an extremenly long upper shadow. Must be preceeded by an uptrend.
*/

//Bear 3 Formation
Bear3Formation = bigblack AND C < Ref(C,-4) AND 
Ref(H,-1) <= fwh AND Ref(L,-1) >= fwl AND
Ref(H,-2) <= fwh AND Ref(L,-2) >= fwl AND 
Ref(H,-3) <= fwh AND Ref(L,-3) >= fwl AND
Ref(isfalling, -4);
/*A strong black candle in a falling window, followed by three
 candles that fall within the high/low range of the strong black candle, followed
 by another strong black candle that closes below the close of the first black candle. 
 This is a bearish confirmation.*/

//Bearish Abandoned Baby
BearishAbandonedBaby = EveningDojiStar AND Ref(GapUp(),-1) AND GapDown();
/*
An evening doji star where there is a gap between the lower shadow of the doji and
the upper shadows of the prior and next candle.
*/

//Bearish Belt Hold
BearishBeltHold = belthold AND blackbody AND Ref(uptrend,-1);
/*
A large black candle with a shaven head and bottom preceeded by an uptrend.
*/

//Bearish Counter Attack
BearishCounterAttack = Ref(big AND whitebody,-1) AND O > Ref(H,-1) AND C == Ref(C,-1) AND big AND blackbody AND Ref(uptrend,-1);
/*
A large white candle followed by a black candle which opens sharply higher but closes
at the prior black candles close. Must be preceeded by an uptrend.
*/

// Bearish Harami Cross
BearishHaramiCross = doji AND Ref(C,-1) > O AND Ref(O,-1) < O AND Ref(big AND whitebody,-1) AND Ref(uptrend,-1);
/*
A doji preceded by and contained within the real body of a big white 
candlestick in an uptrend
*/

// Bearish Harami
BearishHarami = Ref(big AND whitebody,-1) AND smallRealBody AND Min(O,C) > Ref(O,-1) AND Max(O,C) < Ref(C,-1) AND Ref(uptrend,-1);
/*
A small candlestick preceded by and whose real body is contained 
within, the real body of a big white candlestick in an uptrend
*/

// Bearish Separating Line
BearishSeparatingLine = Ref(whitebody AND big,-1) AND blackbody AND big AND O == Ref(O,-1) AND Ref(downtrend,-1); 
/*
A white candlestick followed by a black candlestick with the same opening price. Continues
 the previous downtrend.
*/

// Dark Cloud Cover
DarkCloudCover = Ref(bigwhite,-1) AND blackbody AND O > Ref(H,-1) AND C <= Ref((O+C)/2,-1) AND C > Ref(O,-1) AND Ref(uptrend,-1);
/*
A strong white candle in an uptrend followed by a black candle that opens above the high of the 
white candle and closes at least 50 percent into the white candles real body. Note that if the black candle completely
engulfs the white candles real body then this is not Dark Cloud Cover but a Bearish Engulfing Pattern.
*/


// Engulfing Bear
EngulfingBear = Ref(whitebody,-1) AND blackbody AND engulfing AND Ref(uptrend,-1);
/*
This bar is black and its real body engulfs the previous bars white real body. Must be preceeded by
an uptrend.
*/

//Hamging Man
HangingMan = umbrellaline AND uptrend AND Ref(uptrend,-1);
/*
The same as a hammer except must be preceeded by an uptrend.
*/

//Shooting Star
ShootingStar = smallRealBody AND shaven AND realBodyGapUp AND longuppershadow AND Ref(uptrend,-1);
/*
A small body that closes near the bottom of its range and 
has a long upper shadow. There must be a real body gap up from the previous sessions candle. This
pattern occurs only after an uptrend.
*/

//Three Black Crows
ThreeBlackCrows = (big AND blackbody) AND Ref(big AND blackbody, -1) AND Ref(big AND blackbody, -2) AND O < Ref(O,-1) AND Ref(O,-1) < Ref(O,-2) AND Ref(uptrend,-4);
/*
The last three candlesticks are large and black. Each opens within or lower than the 
 previous candles real body.Must be preceeded by an uptrend.
*/

// Tri-Star Bottom
TriStarBottom = firstDoji AND secDojiLower AND doji AND realBodyGapUp AND isPrevDownTrendx;
/*
A doji followed by a lower doji which is followed by another doji that is higher than the
second doji. Must be preceeded by a downtrend.
*/

//Tweezer Tops
TweezerTops = H == Ref(H,-1) AND Ref(big AND whitebody,-1) AND Ref(uptrend,-2);
/* A large candle followed by a candle with the same high. Must be preceeded by an uptrend. */

// Upside Gap Two Crows
UpsideGapTwoCrows = Ref(big AND whitebody,-2) AND Ref(realBodyGapUp,-1) AND Ref(smallRealBody,-1) AND Ref(blackbody,-1) AND engulfing AND blackbody AND C > Ref((O+C)/2,-2) AND Ref(uptrend,-2);
/* A strong white candle followed by a small black candle which gaps above the previous 
candles real body, followed by a black candle which engulfs the previous black candle. Preceeded by an uptrend. */

//----------------------------------------
// Bullish
//----------------------------------------

// Kicker
KBL = Ref(O,-1) > Ref(C,-1) AND O >= Ref(O,-1) AND C > O; 

// Morning Star
MorningStar = Ref(starDown,-1) AND whitebody AND big AND C > Ref((O + C)/2,-2);
/*
A large black candlestick followed by a small real body of either colour,
 that gaps below the previous black candles real body, with a third white candlestick, that has a close 
 higher than the half way point of the first black candlestick. Must be preceeded by a downtrend.
*/

// Morning Doji Star
MorningDojiStar = Ref(dojiStarDown,-1) AND whitebody AND big AND C > Ref((O + C)/2,-2);
/*
A large black candlestick followed by a doji that gaps below its real body, with a third
 white candlestick, that has a close at least half of the way up the black candlestick. Must be preceeded by a
 downtrend.
*/

// Bull 3 Formation
Bull3Formation = bigwhite AND C > Ref(C,-4) AND 
Ref(H,-1) <= rwh AND Ref(L,-1) >= rwl AND
Ref(H,-2) <= rwh AND Ref(L,-2) >= rwl AND 
Ref(H,-3) <= rwh AND Ref(L,-3) >= rwl AND
Ref(isrising, -4);
/*
A strong white candle in a rising window, followed by three 
 candles that fall within the high/low range of the strong white candle, followed
 by another strong white candle that closes above the close of the first white candle. 
 This is confirmation of the Bullish trend."
*/

// Bullish Abandoned Baby
BullishAbandonedBaby = morningdojistar AND Ref(GapDown(),-1) AND GapUp();
/*
A morning doji star where there is a gap between the lower shadow of the doji and
the prior and next candle.
*/
// Bullish Belt Hold
BullishBeltHold = belthold AND whitebody AND Ref(downtrend,-1);
/*
A large white candle with no upper or lower shadow preceeded by a downtrend.
*/

// Bullish Counter Attack
BullishCounterAttack = Ref(big AND blackbody,-1) AND O < Ref(H,-1) AND C == Ref(C,-1) AND big AND whitebody AND Ref(downtrend,-1);
/*
A large black candle followed by a white candle which opens sharply lower but closes at the 
prior white candles close. Must be preceeded by a downtrend
*/

// Bullish Harami Cross
BullishHaramiCross = doji AND Ref(O,-1) > O AND Ref(C,-1) < O AND Ref(big AND blackbody,-1) AND Ref(downtrend,-1);
/*
A doji preceded by and contained within the real body of a big 
black candlestick in a downtrend.
*/

// Bullish Harami
BullishHarami = Ref(big AND blackbody,-1) AND smallRealBody AND Min(O,C) > Ref(C,-1) AND Max(O,C) < Ref(O,-1) AND Ref(downtrend,-1);
/*
A small candlestick, preceded by, and whose body is contained within a big black 
candlestick in a downtrend
*/

// Bullish Separating Line
BullishSeparatingLine = Ref(blackbody AND big,-1) AND whitebody AND big AND O == Ref(O,-1) AND Ref(uptrend,-1);
/*
A black candlestick followed by a white candlestick with the same opening price. Continues
 the previous uptrend.
*/

//Dragonfly Doji
DragonflyDoji = longleggeddoji AND H==C AND Ref(downtrend,-1);
/*A doji with no upper shadow AND a long lower shadow preceeded by a downtrend.*/

// Engulfing Bull
EngulfingBull = Ref(blackbody,-1) AND whitebody AND engulfing AND Ref(downtrend,-1);
/*
This bar is white and its real body engulfs the previous bars black real body. Must be
preceeded by a downtrend.
*/

// Hammer
Hammer = umbrellaline AND Ref(downtrend,-1);
/*
The upper shadow is less than ten percent of the range
 and the lower shadow is more than two times the size of the body. Must be preceeded by a downtrend.
*/

//Inverted Hammer
InvertedHammer = smallRealBody AND shaven AND realBodyGapDown AND longuppershadow AND Ref(downtrend,-1);
/*
An upside down Hammer that appears after a downtrend
*/

//Piercing Line
PiercingLine = Ref(bigblack,-1) AND whitebody AND O < Ref(L,-1) AND C >= Ref((O+C)/2,-1) AND C < Ref(O,-1) AND Ref(downtrend,-1);
/*
A stong black candle followed by a white candle that opens below the low of
the prior black candle but closes more than halfway into the black candles real body. Preceeded by a downtrend. Note that if the
white candle engulfs the prior black candles real body then this is a Bullish Engulfing Pattern not a Piercing Pattern
*/

// SeperatingLines
SeperatingLines = O == Ref(O,-1) AND (blackbody AND Ref(whitebody,-1) OR whitebody AND Ref(blackbody,-1));
/*
a black candlestick is followed by a white candlestick, or a white with a black,and they have the same opening prices.
*/

//Three White Soldiers
ThreeWhiteSoldiers = (whitebody AND big) AND Ref(whitebody AND big,-1) AND Ref(whitebody AND big,-2) AND O > Ref(O,-1) AND Ref(O,-1) > Ref(O,-2);
/*
The last three candlesticks are large and white. Each opens within or higher than the 
 previous candles real body.
*/

// Tri-Star Top
TriStarTop = firstDoji AND secDojiHigher AND doji AND realBodyGapDown AND isPrevUpTrendx;
/*
A doji followed by a higher doji which is followed by another doji that is lower than the
second doji. Must be preceeded by an uptrend.
*/

// Tweezer Bottoms
TweezerBottoms = L == Ref(L,-1) AND Ref(big AND blackbody,-1) AND Ref(downtrend,-2);
/* A large candle followed by a candle with the same Low. Must be preceeded by a downtrend. */


//----------------------------------------
// Continuation
//----------------------------------------

// Downward Gapping Tasuki
DownwardGappingTasuki = isFallingBlack AND whitebody AND opensInside AND C > Ref(O,-1) AND windowOpen AND similarSize;
/* A black candle that gaps down followed by a similarly sized white candle that opens Inside the black candles real body AND closes above it. */

//Upward Gapping Tasuki
UpwardGappingTasuki = isRisingWhite AND blackbody AND opensInside AND C < Ref(O,-1) AND  windowOpenx AND similarSize;
/* A white candle that gaps up followed by a similarly sized black candle that opens Inside the white candles real body AND closes below it; */

//Inverted Black Hammer
InvertedBlackHammer = blackbody AND InvertedHammer;

revert1 = InvertedHammer ;



//***************************************************************
//END mo hinh Nen Nhat
//***************************************************************







//====================================================================================|
//                      12. Fibonacci Internal & External Retracements                             |
//====================================================================================|
/* Fibonacci Internal & External Retracements */
// This is a Modified Version that shows Fibonacci 00% & 100% instead of WRONG Sup & Res


_SECTION_BEGIN("12. Fibonacci Internal + External Retracements");
	fibs = ParamToggle("1. Hien thi duong ngang Fibonacci ","OFF|ON",0);
	text = ParamToggle("2. Hien thi thong so","OFF|ON",0);
	pctH = Param ("Pivot Hi %", 0.325,0.001,2.0,0.002);
	HiLB = Param ("Hi LookBack",1,1,BarCount-1,1);
	pctL = Param ("Pivot Lo %", 0.325,0.001,2.0,0.002);
	LoLB = Param ("Lo LookBack",1,1,BarCount-1,1);
	Back = Param ("Extend Left = 2",1,1,500,1);
	Fwd  = Param("Plot Forward", 0, 0, 500, 1);
	hts  = Param ("Text Shift", -33.5,-50,50,0.10);
	style =ParamStyle("Line Style",styleLine,styleNoLabel);
x = BarIndex();
pRp  = PeakBars( H, pctH, 1) == 0;
yRp0 = SelectedValue(ValueWhen( pRp, H, HiLB));
xRp0 = SelectedValue(ValueWhen( pRp, x, HiLB));
pSp  = TroughBars( L, pctL, 1) == 0;
ySp0 = SelectedValue(ValueWhen( pSp, L, LoLB));
xSp0 = SelectedValue(ValueWhen( pSp, x, LoLB));
Delta = yRp0 - ySp0;

function fib(ret)
{
retval = (Delta * ret);
Fibval = IIf(ret < 1.0 
AND xSp0 < xRp0, yRp0 - retval, IIf(ret < 1.0 
AND xSp0 > xRp0, ySp0 + retval,IIf(ret > 1.0 
AND xSp0 < xRp0, yRp0 - retval, IIf(ret > 1.0 
AND xSp0 > xRp0, ySp0 + retval, Null)))); 
return FibVal;
}

x0 = Min(xSp0,xRp0)-Back;
x1 = (BarCount -1);
//////////////////////////////////////////////////////////////////
r236 = fib(0.236);	r236I = LastValue (r236,1);
r382 = fib(0.382);	r382I = LastValue (r382,1);
r050 = fib(0.50);		r050I = LastValue (r050,1);
r618 = fib(0.618);	r618I = LastValue (r618,1);
r786 = fib(0.786);	r786I = LastValue (r786,1);
e127 = fib(1.27);		e127I = LastValue (e127,1);
e162 = fib(1.62);		e162I = LastValue (e162,1);
e200 = fib(2.00);		e200I = LastValue (e200,1);
e262 = fib(2.62);		e262I = LastValue (e262,1);
e424 = fib(4.24);		e424I = LastValue (e424,1);
//////////////////////////////////////////////////////////////////
p00 = IIf(xSp0 > xRp0,ySp0,yRp0); 	p00I = LastValue (p00,1);
p100 = IIf(xSp0 < xRp0,ySp0,yRp0); 	p100I = LastValue (p100,1);
color00 =IIf(xSp0 > xRp0,colorLime,colorRed);
color100 =IIf(xSp0 < xRp0,colorLime,colorRed);
//////////////////////////////////////////////////////////////////
numbars = LastValue(Cum(Status("barvisible")));
fraction= IIf(StrRight(Name(),3) == "", 3.2, 3.2);
//////////////////////////////////////////////////////////////////
if(fibs==1)
{
Plot(LineArray(xRp0-Fwd,yRp0,x1,yRp0,Back),"PR",32,8|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(xSp0-Fwd,ySp0,x1,ySp0,Back),"PS",27,8|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,r236,x1,r236,Back),"",45,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,r382,x1,r382,Back),"",44,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,r050,x1,r050,Back),"",41,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,r618,x1,r618,Back),"",43,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,r786,x1,r786,Back),"",42,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,e127,x1,e127,Back),"e127",47,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,e162,x1,e162,Back),"e162",47,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,e200,x1,e200,Back),"p200",47,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,e262,x1,e262,Back),"p262",47,style|styleNoRescale,Null,
Null,Fwd);
Plot(LineArray(x0-Fwd,e424,x1,e424,Back),"p424",25,style|styleNoRescale,Null,
Null,Fwd);
}
//////////////////////////////////////////////////////////////////
if(text==1)
{ 
PlotText(" 0% = " + WriteVal(p00,fraction),
	LastValue(BarIndex())-(numbars/hts), p00I  + 0.05, color00);
PlotText("23% = " + WriteVal(r236,fraction),
LastValue(BarIndex())-(numbars/hts), r236I + 0.05, 45);
PlotText("38% = " + WriteVal(r382,fraction),
LastValue(BarIndex())-(numbars/hts), r382I + 0.05, 44);
PlotText("50% = " + WriteVal(r050,fraction),
LastValue(BarIndex())-(numbars/hts), r050I + 0.05, 41);
PlotText("62% = " + WriteVal(r618,fraction),
LastValue(BarIndex())-(numbars/hts), r618I + 0.05, 43);
PlotText("78% = " + WriteVal(r786,fraction),
LastValue(BarIndex())-(numbars/hts), r786I + 0.05, 42);
PlotText("100% = " + WriteVal(p100,fraction),
LastValue(BarIndex())-(numbars/hts),p100I + 0.05, color100);
PlotText("127% = " + WriteVal(e127,fraction),
LastValue(BarIndex())-(numbars/hts),e127I + 0.05, 47);
PlotText("162% = " + WriteVal(e162,fraction),
LastValue(BarIndex())-(numbars/hts),e162I + 0.05, 47);
PlotText("200% = " + WriteVal(e200,fraction),
LastValue(BarIndex())-(numbars/hts),e200I + 0.05, 47);
PlotText("262% = " + WriteVal(e262,fraction),
LastValue(BarIndex())-(numbars/hts),e262I + 0.05, 47);
PlotText("424% = " + WriteVal(e424,fraction),
LastValue(BarIndex())-(numbars/hts),e424I + 0.05, 25);
}
_SECTION_END();

// END Fibonacci Internal & External Retracements





//==========================================================================|
//                    13. Volume Volume Buy and Sell                                                |
//==========================================================================|


_SECTION_BEGIN("13. Volume Buy and Sell ");

//Chon ky MAVolume
Volumeperiod       = Param     (" - MAvolume Periods ", 30,  1, 500, 1); 
maVolume             = MA(V,Volumeperiod);                               //Tinh MA Volume theo ky da chon
PmaVolume            = V/maVolume*100;                                   //% Volume so voi Volume trung binh 

//Tinh toan Buy or Sell Volume 
BuyVolume   = IIf( (H==L), 0, V*(C-L)/(H-L) ); //Buy  Volume
SellVolume  = IIf( (H==L), 0, V*(H-C)/(H-L) ); //Sell Volume
BuyVolumep  = 100*BuyVolume/(BuyVolume+SellVolume) ;                //% Buy  Volume so voi tong Volume
SellVolumep = 100*SellVolume/(BuyVolume+SellVolume) ;                //% Sell Volume so voi tong Volume


//***************************************** 
//Ve duong Volume
//------------------------------------------------------------------------------------------

                                                                      
switch ( ParamList( "* Hien thi Volume", "OFF|Volume Histogram|Volume Buy and Sell", 0 ) )
{

//Volume OFF
//************************************************ 
case "OFF":

break;


//Volume Histogram
//************************************************
case "Volume Histogram":

//Chon ky MAVolume
Volumeperiod       = Param     (" - MAvolume Periods ", 30,  1, 500, 1); 
maVolumecolor      = ParamColor(" - MAvolume Color", colorOrange);
Volumeheight        = Param     (" - Volume Height", 5, 1, 100, 1.0) ; // Chieu cao Volume
MAVolumeheight      = Param     (" - MA Volume Height", 25, 1, 100, 1.0) ; // Chieu cao Sell Volume

VolumeUpcolor       = ParamColor(" - VolumeUp Color",      colorGreen );
VolumeDown          = ParamColor(" - VolumeDown Color",    colorDarkRed ) ;
VolumeSideway       = ParamColor(" - VolumeSideway Color", colorYellow );

Volumecolor       = IIf(C>Ref(C,-1), VolumeUpcolor,IIf(C<Ref(C,-1),VolumeDown,VolumeSideway));

//Ve tong Volume dac ruot
PlotOHLC(V,0,V,0, "" ,Volumecolor , styleCandle| styleNoTitle |  styleHistogram | styleOwnScale | styleThick | styleNoLabel,  Volumeheight );

//Ve line MA Volume 
Plot(maVolume,"MA Volume", maVolumecolor, styleLine| styleNoTitle | styleOwnScale | styleThick | styleNoLabel,  MAVolumeheight );

break;


//Volume Buy anh Sell
//************************************************ 
case "Volume Buy and Sell":

//Chon ky MAVolume
Volumeperiod       = Param     (" - MAvolume Periods ", 30,  1, 500, 1); 
maVolumecolor      = ParamColor(" - MAvolume Color", colorOrange);
Volumeheight        = Param     (" - Volume Height", 5, 1, 100, 1.0) ; // Chieu cao Volume
MAVolumeheight      = Param     (" - MA Volume Height", 18, 1, 100, 1.0) ; // Chieu cao Sell Volume
SellVolumeheight    = Param     (" - Sell Volume Height", 9, 1, 100, 1.0) ; // Chieu cao Sell Volume

TotalVolumeUp       = ParamColor(" - Total VolumeUp Color",      colorBlue );
TotalVolumeDown     = ParamColor(" - Total VolumeDown Color",    colorRed ) ;
TotalVolumeSideway  = ParamColor(" - Total VolumeSideway Color", colorYellow );

//Ve mau Total Volume theo dien bien Gia
TotalVolumeColor    = IIf(C>Ref(C,-1), TotalVolumeUp,IIf(C<Ref(C,-1),TotalVolumeDown,TotalVolumeSideway));

//***************************************** 

// Ve them duong Buy Volume mau Xanh
//Plot(BV,"Buy Volume",      ParamColor(" - Buy Volume Color",  colorGold ), styleHistogram | styleThick |styleNoTitle|styleNoLabel ) ;

// Ve duong Sell Volume dac ruot mau Do
PlotOHLC(SellVolume,SellVolume,0,0, "Sell Volume" , ParamColor(" - Sell Volume Color",  colorRed ), styleCandle|  styleOwnScale | styleThick | styleNoLabel,  SellVolumeheight );

//***************************************** 
//Ve tong Volume rong ruot
PlotOHLC(0, V, 0, V, "" , TotalVolumeColor, styleCandle|  styleOwnScale | styleThick | styleNoLabel,  Volumeheight );

//Ve tong Volume dac ruot
//PlotOHLC(V,0,V,0, "" , VolumeColor, styleCandle| styleNoTitle |  styleHistogram | styleThick | styleNoLabel );

// Ve tong Volume loai bo Sell Volume
//PlotOHLC(SV,Volume,SV,Volume,"BuyVolume",VolumeColor,styleCandle|styleNoTitle|styleNoLabel );
 
//***************************************** 
//Ve line MA Volume 
Plot(maVolume,"MA Volume", maVolumecolor, styleLine| styleNoTitle | styleOwnScale | styleThick | styleNoLabel,  MAVolumeheight );

//Ve may MA Volume 
PlotOHLC( maVolume, maVolume, maVolume, maVolume, "MA Volume", ParamColor(" - Volume Cloud Color",  colorViolet ), styleGradient| styleOwnScale | styleThick | styleNoLabel,  MAVolumeheight );
 
break;


}

 _SECTION_END();

// END Volume tren duong gia





//==========================================================================|
//                    14. VAP - Volume At Price                               |
//==========================================================================|


_SECTION_BEGIN("14. VAP - Volume At Price");

VAPline  = Param("VAP Lines - So luong thanh VAP", 150, 1, 1000, 1 );
VAPwidth = Param("VAP Width - Chieu dai VAP", 10, 1, 100, 1 );
VAPcolor = ParamColor("VAP Color", colorLightOrange);
VAPLR    = ParamToggle("Chon ben Trai | Phai", "Left|Right" ) ;


PlotVAP  = ParamToggle( "* VAP - Volume At Price ",  "OFF|ON", 0 ); 

//Ve VAP - Volume At Price
if (PlotVAP >0)
{
 PlotVAPOverlay(VAPline ,VAPwidth,VAPcolor , VAPLR );
 
}
_SECTION_END();

//        END  12. VAP - Volume At Price   
   
 
 
          
//==========================================================================|
//                    15. Volume At Price Anna Coulling                                 |
//==========================================================================|


_SECTION_BEGIN("15. Volume At Price Anna Coulling");
/*
Author: Anderson Wilson, Beppe, Steve Walsh
based on PriceVolDistribution demo written by Tomasz Janeczko

Volume-by-Price is an indicator that shows the amount of volume for a particular price range,
The Volume-by-Price bars are horizontal and shown on the left side of the chart to correspond
with these price ranges. Bar colors indicate Bull (SeaGreen) / Bear (Custom16) / Total (Grey40) volume
Use double click to define range.
*/



Qvap       = Param( "So luong thanh VAP", 15, 1, 200, 1 );
pRecHeight = Param( "Rectangle Height - Kich thuoc hop chu nhat", 0.90, 0.10, 1, 0.01 );
SelectsizeFont = Param( "Chon Font Size", 9, 1, 30, 1 );
SelectFont = GfxSelectFont( "Arial", SelectsizeFont ); 

//
bi = BarIndex();
fvb = BeginValue( bi );
lvb = EndValue( bi );

if (VAPanna = ParamToggle( "* Hien thi Volume At Price Anna Coulling",  "OFF|ON", 0 ))
{


if( fvb == 0 && lvb == LastValue( bi ) )
{
    fvb = FirstVisibleValue( bi );
    lvb = LastVisibleValue( bi );
}

fvb = Max( 0, fvb );
lvb = Max( 0, lvb );


BullBearZone = ( High - Low ) / 3;
bullbar = C > ( High - BullBearZone );
bearbar = C < ( Low + BullBearZone );

mx  = PriceVolDistribution( H, L, V, Qvap, True, fvb, lvb );
mx1 = PriceVolDistribution( H, L, IIf( bullbar, V, 0 ), Qvap, True, fvb, lvb );
mx2 = PriceVolDistribution( H, L, IIf( bearbar, V, 0 ), Qvap, True, fvb, lvb );

bins  = MxGetSize( mx, 0 );
bins1 = MxGetSize( mx1, 0 );
bins2 = MxGetSize( mx2, 0 );

GfxSetOverlayMode( 1 );
GfxSetCoordsMode( 1 );

if( bins > 1 && bins == bins1 && bins == bins2 )
{

    MaxVolume = mx[ 0 ][ 1 ];

    // find max volume
    for( i = 1; i < bins; i++ )
    {
        if( mx[ i ][ 1 ] > MaxVolume )
            MaxVolume = mx[ i ][ 1 ]; // Volume for that bin 1...

        //printf( "mx=%g", MaxVolume / 100000 );
    }

    // rectangle height
    RecHeight = ( mx[ 1 ][ 0 ] - mx[ 0 ][ 0 ] ) / 2 * pRecHeight;
    SelectFont; // Change the text size here

    for( i = 0; i < bins; i++ )
    {
        // mx1 = Bull
        price = mx1[ i ][ 0 ]; // price level
        absVolume = mx1[ i ][ 1 ];
        VolAcum = absVolume;
        relvolume = absVolume / MaxVolume;
        relbar = relvolume * ( lvb - fvb + 1 );
        // upper left corner of the rectangle.
        x1 = fvb;
        y1 = price + RecHeight;
        // lower right corner of the rectangle.
        x2 = fvb + relbar;
        y2 = price - RecHeight;
        bullColor = ColorBlend( colorSeaGreen, GetChartBkColor(), 0.2 );
        GfxFillSolidRect( x1, y1, x2, y2, bullColor );
        GfxSetBkColor( bullColor );
        GfxSetTextColor( colorBrightGreen );
        GfxTextOut( NumToStr( round( relvolume * 100 ), 2.0 ) + "%", x1, y1 );

        // mx2 = Bear
        absVolume = mx2[ i ][ 1 ];
        VolAcum += absVolume;
        relvolume = absVolume / MaxVolume;
        relbar2 = relvolume * ( lvb - fvb + 1 );
        x1 = x2;
        x2 = x1 + relbar2;
        bearColor = ColorBlend( colorCustom16, GetChartBkColor(), 0.2 );
        GfxFillSolidRect( x1, y1, x2, y2, bearColor );
        GfxSetBkColor( bearColor );
        GfxSetTextColor( colorRed );
        GfxTextOut( NumToStr( round( relvolume * 100 ), 2.0 ) + "%", x1, y1 );

        // mx = All Bars
        absVolume = mx[ i ][ 1 ];
        relvolume = ( absVolume - VolAcum ) / MaxVolume;
        relbar3 = relvolume * ( lvb - fvb + 1 );
        x1 = x2;
        x2 = x1 + relbar3;
        midColor = ColorBlend( colorGrey40, GetChartBkColor(), 0.2 );
        GfxFillSolidRect( x1, y1, x2, y2, midColor );
        GfxSetBkColor( midColor );
        GfxSetTextColor( colorBlack );
        GfxTextOut( NumToStr( round( relvolume * 100 ), 2.0 ) + "%", x1, y1 );
    }
}


}

_SECTION_END();
//END   Volume At Price Anna Coulling 





//==========================================================================|
//                    16. Volume Lines Module                                   |
//==========================================================================|
// AFL Karthikmarar
// HIGH VOLUME LINES AFL VERSION 1.00
// Provids upto total 20 lines. Number of lines Adjustable from Parameter window

_SECTION_BEGIN("16. High Volume Lines");

j        = Param("So luong thanh High Volume Lines",5,1,20,1);
k        = Param("He so Volume factor",2,1.5,3,0.5);
hvlColor = ParamColor( "HVL Colorr", colorOrange );
vr=ParamToggle("* Hien thi High volume lines","OFF|ON" ,0);
y =Cum(1);
Hk1=V>k*volAvg;
//High volume detection
hx1=LastValue(ValueWhen(hk1,y,1));
hx2=LastValue(ValueWhen(hk1,y,2));
hx3=LastValue(ValueWhen(hk1,y,3));
hx4=LastValue(ValueWhen(hk1,y,4));
hx5=LastValue(ValueWhen(hk1,y,5));
hx6=LastValue(ValueWhen(hk1,y,6));
hx7=LastValue(ValueWhen(hk1,y,7));
hx8=LastValue(ValueWhen(hk1,y,8));
hx9=LastValue(ValueWhen(hk1,y,9));
hx10=LastValue(ValueWhen(hk1,y,10));
hx11=LastValue(ValueWhen(hk1,y,11));
hx12=LastValue(ValueWhen(hk1,y,12));
hx13=LastValue(ValueWhen(hk1,y,13));
hx14=LastValue(ValueWhen(hk1,y,14));
hx15=LastValue(ValueWhen(hk1,y,15));
hx16=LastValue(ValueWhen(hk1,y,16));
hx17=LastValue(ValueWhen(hk1,y,17));
hx18=LastValue(ValueWhen(hk1,y,18));
hx19=LastValue(ValueWhen(hk1,y,19));
hx20=LastValue(ValueWhen(hk1,y,20));
//values when High volume occured
XV1 =LastValue(ValueWhen(hk1,H,1));
XV2 =LastValue(ValueWhen(hk1,H,2));
XV3 =LastValue(ValueWhen(hk1,H,3));
XV4 =LastValue(ValueWhen(hk1,H,4));
XV5 =LastValue(ValueWhen(hk1,H,5));
XV6 =LastValue(ValueWhen(hk1,H,6));
XV7 =LastValue(ValueWhen(hk1,H,7));
XV8 =LastValue(ValueWhen(hk1,H,8));
XV9 =LastValue(ValueWhen(hk1,H,9));
XV10 =LastValue(ValueWhen(hk1,H,10));
XV11 =LastValue(ValueWhen(hk1,C,11));
XV12 =LastValue(ValueWhen(hk1,C,12));
XV13 =LastValue(ValueWhen(hk1,C,113));
XV14 =LastValue(ValueWhen(hk1,C,14));
XV15 =LastValue(ValueWhen(hk1,C,15));
XV16 =LastValue(ValueWhen(hk1,C,16));
XV17 =LastValue(ValueWhen(hk1,C,17));
XV18 =LastValue(ValueWhen(hk1,C,18));
XV19 =LastValue(ValueWhen(hk1,C,19));
XV20 =LastValue(ValueWhen(hk1,C,20));
LastBar = Cum(1) == LastValue(Cum(1));

//plot High Volume lines - Ve duong High Volume
Plot(IIf(y>hx1 AND j>=1 AND Vr,xv1,Null),"v1",hvlColor);
Plot(IIf(y>hx2 AND j>=2 AND Vr,xv2,Null),"v2",hvlColor);
Plot(IIf(y>hx3 AND j>=3 AND Vr,xv3,Null),"v3",hvlColor);
Plot(IIf(y>hx4 AND j>=4 AND Vr,xv4,Null),"v4",hvlColor);
Plot(IIf(y>hx5 AND j>=5 AND Vr,xv5,Null),"v5",hvlColor);
Plot(IIf(y>hx6 AND j>=6 AND Vr,xv6,Null),"v6",hvlColor);
Plot(IIf(y>hx7 AND j>=7 AND Vr,xv7,Null),"v7",hvlColor);
Plot(IIf(y>hx8 AND j>=8 AND Vr,xv8,Null),"v8",hvlColor);
Plot(IIf(y>hx9 AND j>=9 AND Vr,xv9,Null),"v9",hvlColor);
Plot(IIf(y>hx10 AND j>=10 AND Vr,xv10,Null),"v10",hvlColor);
Plot(IIf(y>hx11 AND j>=11 AND Vr,xv11,Null),"v11",hvlColor);
Plot(IIf(y>hx12 AND j>=12 AND Vr,xv12,Null),"v12",hvlColor);
Plot(IIf(y>hx13 AND j>=13 AND Vr,xv13,Null),"v13",hvlColor);
Plot(IIf(y>hx14 AND j>=14 AND Vr,xv14,Null),"v14",hvlColor);
Plot(IIf(y>hx15 AND j>=15 AND Vr,xv15,Null),"v15",hvlColor);
Plot(IIf(y>hx16 AND j>=16 AND Vr,xv16,Null),"v16",hvlColor);
Plot(IIf(y>hx17 AND j>=17 AND Vr,xv17,Null),"v17",hvlColor);
Plot(IIf(y>hx18 AND j>=18 AND Vr,xv18,Null),"v18",hvlColor);
Plot(IIf(y>hx19 AND j>=19 AND Vr,xv19,Null),"v19",hvlColor);
Plot(IIf(y>hx20 AND j>=20 AND Vr,xv20,Null),"v20",hvlColor);
_SECTION_END();

// END High Volume Lines




//==========================================================================|
//                    17. Hien thi VWAP - Volume Weighted Average Price                                  |
//==========================================================================|


_SECTION_BEGIN("17. VWAP - Volume Weighted Average Price");

Pvwap       = ParamField("Price field",-1);
VwapPeriods = Param("Periods", 15, 2, 300, 1, 10 );
VWAPcolor       = ParamColor( "VWAP Color", colorYellow );
VWAPstyle       = ParamStyle( "VWAP Style" , styleThick); 

if(ParamToggle("1. VWAP tuy chinh","OFF|ON",0) )
{
Plot( WMA( Pvwap, VwapPeriods ), _DEFAULT_NAME(), VWAPcolor, VWAPstyle );


}

//****************************************************************************

Period = ParamList( "Chon Time", "Daily|Weekly|Monthly|Lastthursday|Yearly", 1 );
pwap = ParamToggle("2. VWAP - Daily|Weekly|Monthly|Lastthursday|Yearly","OFF|ON",0);

function Lastthursday()
{
    Daysinmonth = IIf( Month() == 1 OR Month() == 3 OR Month() == 5 OR Month() == 7 OR Month() == 8 OR Month() == 10 OR Month() == 12, 31, 30 );
    Daysinmonthfeb = IIf( Year() % 4 == 0 AND Year() % 100 != 0, 29, 28 );
    Daysinmonthfinal = IIf( Month() == 2, Daysinmonthfeb, Daysinmonth );
    returnvalue = IIf( Daysinmonthfinal - Day() < 7 AND DayOfWeek() == 4, 1, IIf( Daysinmonthfinal - Day() < 8 AND DayOfWeek() == 3 AND Ref( DayOfWeek(), 1 ) != 4 AND Day() != Daysinmonthfinal , 1, 0 ) );
    return returnvalue;
}



if(Period=="Daily" )
{
Bars_so_far_today = 1 + BarsSince( Day() != Ref(Day(), -1));
StartBar = ValueWhen(TimeNum() == 091500, BarIndex());
TodayVolume = Sum(V,Bars_so_far_today);
average = (H+L+C)/3;
IIf (BarIndex() >= StartBar, VWAP = Sum (average * V, Bars_so_far_today  ) / TodayVolume,0);
}

if(Period=="Weekly" OR Interval()==24 * 3600 )
{ 
Bars_so_far_today = 1 + BarsSince(DayOfWeek() < Ref( DayOfWeek(), -1 ));
StartBar = ValueWhen(TimeNum() == 091500, BarIndex());
Vol = TimeFrameGetPrice("V", inWeekly, 0);
TodayVolume = Sum(Vol,Bars_so_far_today);
average = (H+L+C)/3;
IIf (BarIndex() >= StartBar, VWAP = Sum (average * Vol, Bars_so_far_today  ) / TodayVolume,0);
}

if(Period=="Monthly"  )
{
Bars_so_far_today = 1 + BarsSince(Month() != Ref(Month(), -1));
Vol = TimeFrameGetPrice("V", inMonthly, 0);
StartBar = ValueWhen(TimeNum() == 091500, BarIndex());
TodayVolume = Sum(Vol,Bars_so_far_today);
average = (H+L+C)/3;
IIf (BarIndex() >= StartBar, VWAP = Sum (average * Vol, Bars_so_far_today  ) / TodayVolume,0);
}

Plot (IIf(pwap, VWAP,Null), "Vwap",VWAPcolor);


_SECTION_END();

//END VWAP





//==========================================================================|
//         18. Bands   - Do luong suc manh Cung Cau + Xu huong                               |
//==========================================================================|


_SECTION_BEGIN("18. Bands - Thanh suc manh Cung Cau + Xu huong");
//------------------------Strength band------------------------

RSIPeriod =  Param("Time RSI", 14, 2, 100, 1);
Lb      = Param("LookBack Period",60,40,120,1);

strband = ParamToggle("1. Plot Strength Bands - Thanh suc manh","OFF|ON",0 );
trband  = ParamToggle("2. Plot Trend Bands - Thanh xu huong","OFF|ON",0 );

//-----------------Strength band----------------------

mySig1 = RSI(RSIPeriod);
Adev = StDev(mySig1, 3*RSIPeriod);
jh = HHV(mySig1,Lb);
jl = LLV(mySig1,Lb);
jc = (WMA((jh-jl),RSIPeriod)*0.60)+WMA(jl,RSIPeriod);
Hiline = jh-jc*0.2;
Loline = jl+jc*.2;
midline = (jh-jl)/2;

R =  ( 4 * mySig1 + 3 * Ref(mysig1,-1) + 2 * Ref(mysig1,-2) + Ref(mysig1,-3) ) / 10;;
rsicolor = IIf(R>HiLine,colorLime,IIf(R<loLine,colorOrange,colorWhite));
Plot( IIf(strband==1,1.5,0),"Ribbon",rsicolor,styleOwnScale|styleArea|styleNoLabel, 0, 100 );// Strength Band
Plot( IIf(trband==1,1.6,0),"",colorBlack,styleOwnScale|styleArea|styleNoLabel, 0, 100 );// Strength Band

Rx =IIf(R>HiLine,1,IIf(R<loLine,0,2));

//----------------------Trend Bands-----------------------
Lttrendcolor  = IIf(upmajor==1 ,colorLime,IIf( upmajor== -1,colorRed,colorGold));
imdtrendcolor = IIf(upimd==1,colorLime,IIf(dnimd==1,colorRed,colorGold));
mnrtrendcolor  = IIf(upminor==1,colorLime,IIf(dnminor == 1,colorRed,colorGold));
Plot( IIf(trband==1,3.0,0),"", Lttrendcolor,styleOwnScale|styleArea|styleNoLabel, 0, 100 );// lt term trend Band
Plot( IIf(trband==1,3.1,0),"",colorBlack ,styleOwnScale|styleArea|styleNoLabel, 0, 100 );
Plot( IIf(trband==1,4.5,0),"Ribbon",mnrtrendcolor,styleOwnScale|styleArea|styleNoLabel, 0, 100 );// mid term trend Band
Plot( IIf(trband==1,4.6,0),"", colorBlack,styleOwnScale|styleArea|styleNoLabel, 0, 100 );
Plot( IIf(trband==1,6.0,0),"Ribbon",  imdtrendcolor,styleOwnScale|styleArea|styleNoLabel, 0, 100 );// lt term trend Band
_SECTION_END();

//END  18. Bands   - Do luong suc manh Cung Cau + Xu huong       






//==========================================================================|
//                    19. Bollinger Bands                                  |
//==========================================================================|


_SECTION_BEGIN("19. Bollinger Bands");


P = ParamField("Price field",-1);
Periods = Param("Periods", 20, 2, 300, 1 );
Width = Param("Width", 2, 0, 10, 0.05 );
Color = ParamColor("Color", colorDarkOliveGreen);
Style = ParamStyle("Style",styleNoLabel) ;



if (bBollingerBands = ParamToggle( "* Hien thi Bollinger Bands",  "OFF|ON", 0 ))
{

// Hien thi Bollinger Band cloud
Plot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style |styleNoRescale); 
Plot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style |styleNoRescale); 
PlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, colorBlack, 0.9 ), styleCloud | styleThick|styleNoLabel|styleNoRescale, Null, Null, Null, -1 );


}


/*

// Hien thi tin hieu Mua Ban theo Bollinger Band Signals
Sell=Cross(P,BBandTop( P, Periods, Width ));
Buy=Cross(P,BBandBot( P, Periods, Width ));
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorBlue, 0, L, Offset=-25);
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorLightBlue, 0,L, Offset=-35);
PlotShapes(IIf(Buy, shapeUpArrow, shapeNone),colorWhite, 0,L, Offset=-30);
PlotShapes(IIf(Sell, shapeSquare, shapeNone),colorRed, 0, H, Offset=25);
PlotShapes(IIf(Sell, shapeSquare, shapeNone),colorPaleGreen, 0,H, Offset=35);
PlotShapes(IIf(Sell, shapeDownArrow, shapeNone),colorWhite, 0,H, Offset=-30);
*/


_SECTION_END();
// END Bollinger Bands  




//==========================================================================|
//                     20. Keltner Bands system                                 |
//==========================================================================|


_SECTION_BEGIN("20. Keltner Bands system");

//Keltner Band Code
KMid = MA (Close, 20);  //Middle Line
ATRPeriod = Param("ATRPeriod", 10, 2, 300, 1 ); //ATR Period
KFactor = Param("Width", 2, 0, 10, 0.05 ); //Multiplier
KValue = ATR(ATRPeriod) * KFactor; 
KTop = KMid + KValue;   //Upper Band
KBottom = KMid - KValue;    //Lower Ban
 
  
  
if (Keltner = ParamToggle( "* Hien thi Keltner Bands system",  "OFF|ON", 0 ))
{

printf("\nKTop : " + KTop );  
printf("\nKBottom : " + KBottom );  
printf("\nKMid : " + KMid );  
 
Plot(KTop,"KTop",colorBlue,styleLine|styleNoRescale);
Plot(KMid,"KMid",colorGold,styleLine|styleNoRescale);
Plot(KBottom,"KBottom",colorRed,styleLine|styleNoRescale);
 
 
Buy=Cross(High,KTop);
Short=Cross(KBottom,Low);
Sell=Cross(KMid,Low);
Cover=Cross(High,KMid);
 
BuyPrice=KTop;
SellPrice=KMid;
ShortPrice=KBottom;
CoverPrice=KMid;
 
Buy = ExRem(Buy,Sell);
Sell = ExRem(Sell,Buy);
Short=ExRem(Short,Cover);
Cover=ExRem(Cover,Short);
 
 
printf("\nBuy : " + Buy );  
printf("\nSell : " + Sell );  
printf("\nShort : " + Short );  
printf("\nCover : " + Cover );  
 
/* Plot Buy and Sell Signal Arrows */
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorBlue, 0, L, Offset=-25);
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorLightBlue, 0,L, Offset=-35);
PlotShapes(IIf(Buy, shapeUpArrow, shapeNone),colorWhite, 0,L, Offset=-30);
PlotShapes(IIf(Short, shapeSquare, shapeNone),colorRed, 0, H, Offset=25);
PlotShapes(IIf(Short, shapeSquare, shapeNone),colorPaleGreen, 0,H, Offset=35);
PlotShapes(IIf(Short, shapeDownArrow, shapeNone),colorWhite, 0,H, Offset=-30);
PlotShapes(IIf(Sell, shapeStar, shapeNone),colorGold, 0, L, Offset=-15);
PlotShapes(IIf(Cover, shapeStar, shapeNone),colorGold, 0,L, Offset=-15);
 

}


_SECTION_END();

// END Keltner Bands system 


//==========================================================================|
//                     21. Center of Gravity indicator    |
//==========================================================================|
// Trung tam cua Trong luc
// 
_SECTION_BEGIN("21. Center of Gravity - Trung tam cua trong luc");

sx=Null;b=Null;ai=Null;x=Null;
reg=x1=x2=x3=z1=z2=z3=Null;	
rega=x1a=x2a=x3a=z1a=z2a=z3a=Null;	
	
bi=BarIndex();	
eb=LastValue(bi);	
order=Param("n-th Order",3,1,20,1);	
bars=Param("Chon time qua khu",260,50,1000,1);
sv=ParamToggle("* Chon che do hien thi theo Click chuot","OFF|ON",1);
alt=ParamToggle("Chon kieu gia tri","Fibonacci|Standard",0);
ecart=1.61803399;
 
 
if (Gravity = ParamToggle( "* Hien thi Center of Gravity",  "OFF|ON", 0 ))
{

  
if(sv)
{
	eb=SelectedValue(bi);
	bb=Max(0,eb-bars);
}
else
{
	bb=Max(0,eb-bars);
}
fin=eb;
nn=order+1;
sx[1]=bars+1;

if(fin>bars)
{
for(mi=1;mi<=2*nn-2;mi++)
{
	suml=0;
	for(n=0;n<=bars;n++)
	{
		suml=suml+n^mi;
	}
	sx[mi+1]=suml;
}
for(mi=1;mi<=nn;mi++)
{
	suml=0;
	for(n=0;n<=bars;n++)
	{
		if (mi==1)
			suml=suml+Close[fin-n];
		else
			suml=suml+Close[fin-n]*n^(mi-1);
			b[mi]=suml;
	}
}
for(jj=1;jj<=nn;jj++)
{
	for(ii=1;ii<=nn;ii++)
	{
		kk=ii+jj-1;
		ai[(ii-1)*nn+jj]=sx[kk];
	}
}
for(kk=1;kk<=nn-1;kk++)
{
	ll=0;
	mm=0;
	for(ii=kk;ii<=nn;ii++)
	{
		if(abs(ai[(ii-1)*nn+kk])>mm)
		{
			mm=abs(ai[(ii-1)*nn+kk]);
			ll=ii;
		}
	}
    if(ll==0) break;
	if(ll!=kk)
	{
		for(jj=1;jj<=nn;jj++)
		{
			tt=ai[(kk-1)*nn+jj];
			ai[(kk-1)*nn+jj]=ai[(ll-1)*nn+jj];
			ai[(ll-1)*nn+jj]=tt;
		}
		tt=b[kk];
		b[kk]=b[ll];
		b[ll]=tt;
	}
	for(ii=kk+1;ii<=nn;ii++)
	{
		qq=ai[(ii-1)*nn+kk]/ai[(kk-1)*nn+kk];
		for(jj=1;jj<=nn;jj++)
		{
			if(jj==kk)
				ai[(ii-1)*nn+jj]=0;
			else
				ai[(ii-1)*nn+jj]=ai[(ii-1)*nn+jj]-qq*ai[(kk-1)*nn+jj];
		}
		b[ii]=b[ii]-qq*b[kk];
	}
}
x[nn]=b[nn]/ai[nn*nn];
for(kk=1;kk<=nn-1;kk++)
{
	tt=0;
	ii=nn-kk;
	for(jj=1;jj<=nn-ii;jj++)
	{
		tt=tt+ai[(ii-1)*nn+ii+jj]*x[ii+jj];
		if(ai[(ii-1)*nn+ii]!=0)
			x[ii]=(b[ii]-tt)/ai[(ii-1)*nn+ii];
	}
}
for(n=0;n<=bars;n++)
{
	suml=0;
	for(kk=1;kk<=order;kk++)
	{
		suml=suml+x[kk+1]*n^kk;
	}
	reg[fin-n]=x[1]+suml;
}
}

if(alt)
{
dev=StDev(Close-reg,bars);
sd=dev[fin];
x1a=reg+sd*1;//68%
x2a=reg+sd*2;//95%
x3a=reg+sd*3;//99.83%
z1a=reg-sd*1;
z2a=reg-sd*2;
z3a=reg-sd*3;

Plot(reg,"reg",colorBlue,1|styleNoRescale);
Plot(x3a,"x3a",ColorRGB(255,0,0),styleThick|styleNoRescale);
Plot(x2a,"x2a",ColorRGB(255,100,100),styleDashed|styleNoRescale);
Plot(x1a,"x1a",ColorRGB(255,200,200),styleDashed|styleNoRescale);
Plot(z3a,"z3a",ColorRGB(0,255,0),styleThick|styleNoRescale);
Plot(z2a,"z2a",ColorRGB(100,255,100),styleDashed|styleNoRescale);
Plot(z1a,"z1a",ColorRGB(200,255,200),styleDashed|styleNoRescale);
PlotOHLC(x3a,x3a,x1a,x1a,"",ColorRGB(30,0,0),styleCloud|styleNoLabel|styleNoRescale,0,0,0,-1); 
PlotOHLC(z1a,z1a,z3a,z3a,"",ColorRGB(0,30,0),styleCloud|styleNoLabel|styleNoRescale,0,0,0,-1); 
}
else
{
dev=StDev(Close,bars);
sd=ecart*dev[fin];
x1=reg+sd/(1.382*1.618);
x2=reg+sd/1.382;
x3=reg+sd;
z1=reg-sd/(1.382*1.618);
z2=reg-sd/1.382;
z3=reg-sd;

Plot(reg,"reg",colorBlue,1|styleNoRescale);
Plot(x3,"x3",ColorRGB(255,0,0),styleThick|styleNoRescale);
Plot(x2,"x2",ColorRGB(255,100,100),styleDashed|styleNoRescale);
Plot(x1,"x1",ColorRGB(255,200,200),styleDashed|styleNoRescale);
Plot(z3,"z3",ColorRGB(0,255,0),styleThick|styleNoRescale);
Plot(z2,"z2",ColorRGB(100,255,100),styleDashed|styleNoRescale);
Plot(z1,"z1",ColorRGB(200,255,200),styleDashed|styleNoRescale);
PlotOHLC(x3,x3,x2,x2,"",ColorRGB(30,0,0),styleCloud|styleNoLabel|styleNoRescale,0,0,0,-1); 
PlotOHLC(z2,z2,z3,z3,"",ColorRGB(0,30,0),styleCloud|styleNoLabel|styleNoRescale,0,0,0,-1); 
}

}


_SECTION_END();
//END Center of Gravity indicator








//==========================================================================|
//                    22. Turtle trading system                                  |
//==========================================================================|


_SECTION_BEGIN("22. Turtle trading system - He thong giao dich Con Rua");

/*
Formula Name: Turtle trading system
Author/Uploader: DrZingaro
Date Added: 2009-01-12
Origin: Turtle trading experimemnt Chandelier exit based on Chuck Lebeau's work
Keywords: Trend trading
Level: Basic
Flags: System
*/
//=============================SETUP================ ======================

pds = Param(" - Chon Time theo doi kenh Turtle", 20, 1,260,1);
tur20  = Param(" - EMA ngan han", 20, 1,200,1);  
tur40  = Param(" - EMA trung han", 40, 1,200,1);  
MAFAST = EMA( Close, tur20 );
MASLOW = EMA( Close, tur40 );

DonchianUpper = HHV( Ref( H, -1 ), pds ); // Highest high value of highs in last 20 periods
DonchianLower = LLV( Ref( L, -1 ), pds ); // Lowest low value of low in last 20 periods
DonchianMiddle = ( DonchianUpper + DonchianLower ) / 2;

UpTrend = C > ( LLV( L, pds ) + 2 * ATR( 10 ) ) AND EMA( Close, tur20 ) > EMA( Close, tur40 );
DnTrend = C < ( HHV( H, pds ) - 2 * ATR( 10 ) ) AND EMA( Close, tur20 ) < EMA( Close, tur40 );
Color = IIf( UpTrend, colorBlue, IIf( DnTrend, colorOrange, colorCustom11 ) );


//=============================TRIGGERS AND ENTRIES=======================
Buy = High > Ref( HHV( High, pds ), -1 ) AND MAFAST > MASLOW; // Enters long trade (Vao lenh Mua)

Short = Low < Ref( LLV( Low, pds ), -1 ) AND MAFAST < MASLOW; // Enters short trade (Vao lenh Ban khong)

Dbar = Param(" - Chon so thanh Bar theo doi diem Mua - Ban", 50, 1,260,1);
SetBarsRequired( Dbar, Dbar );

Multiple = Param( "So luong muc ATRs ", 3, 0.5, 10, 0.1 ); // How many ATRs to be allowed below the highest high since latest "buy" bar
ATRPeriods = Param( "So ky cho ATR", 20, 1, 100, 1 ); // How many periods to use for the ATR



if (Turtle = ParamToggle( "* Hien thi Turtle trading system",  "OFF|ON", 0 ))
{


// Plots a 20 period Donchian channel

Plot( DonchianUpper, "Donchian Upper", ParamColor( "DonchianUpper Color", colorBlue ), ParamStyle( "DonchianUpper Style", styleLine|styleNoRescale ) );
Plot( DonchianMiddle, "Donchian Middle", ParamColor( "DonchianMiddle Color", colorBrightGreen ), ParamStyle( "DonchianMiddle Style", styleNoLine|styleNoRescale ) );
Plot( DonchianLower, "Donchian Lower", ParamColor( "DonchianLower Color", colorRed ), ParamStyle( "DonchianLower Style", styleLine |styleNoRescale) );




//=============================EXITS================ ======================



stopArray = Null;
atrArray = ATR( ATRPeriods );
HHArray = Null;
LLArray = Null;
exitArray = Null;
trendDirection = 0;

for ( i = 0; i < BarCount; i++ )
{
    if ( Short[i] )
    {
        // we just triggered a short trade. Set up starting values
        stopArray[i] = Low[i] + ( Multiple * atrArray[i] );
        LLArray[i] = Low[i]; // initialize the lowest low array
        trendDirection = 0 - 1; // going short. Base bar.
    }

    if ( Buy[i] )
    {
        // we just triggered a long trade. Set up starting values
        stopArray[i] = High[i] - ( Multiple * atrArray[i] );
        HHArray[i] = High[i]; // initialize the highest high array
        trendDirection = 1; // going long. Base bar flag is now set.
    }

    exitArray[i] = 0;

    if ( trendDirection > 0 )
    {
        // keep track of the highest high, highest close, highest low, etc..
        if ( trendDirection > 1 )
        {
            // We are in the trade (2nd day or later)
            if ( Low[i] < stopArray[i-1] )
            {
                //stop got hit. Reset the trade.
                trendDirection = 0; // OK. wait until we trigger another trade.
                exitArray[i] = 1;
            }
            else
            {
                // keep track of the HHV since trade was entered.
                if ( High[i] > HHArray[i-1] )
                    HHArray[i] = High[i];
                else
                    HHArray[i] = HHArray[i-1];

                // Compute the stop based on the HHV.
                stopArray[i] = HHArray[i] - ( Multiple * atrArray[i] );
            }
        }

        trendDirection = trendDirection + 1;
    }

    if ( trendDirection < 0 )
    {
        // keep track of the lowest low, lowest close, lowest high, etc..
        if ( trendDirection < 0 - 1 )
        {
            // We are in the trade (2nd day or later)
            if ( High[i] > stopArray[i-1] )
            {
                // our stop got hit. Reset the trade.
                trendDirection = 0;
                exitArray[i] = 0 - 1;
            }
            else
            {
                // keep track of the LLV since trade was entered.
                if ( Low[i] < LLArray[i-1] )
                    LLArray[i] = Low[i];
                else
                    LLArray[i] = LLArray[i-1];

		// Compute the stop based on the LLV.
                stopArray[i] = LLArray[i] + ( Multiple * atrArray[i] );
            }
        }

        trendDirection = trendDirection - 1;
    }

    if ( trendDirection == 0 )
    {
        stopArray[i] = 0;
        LLArray[i] = 0;
        HHArray[i] = 0;
    }
}

Sell = Cover = exitarray;

Buy = ExRem( Buy, Sell );
Sell = ExRem( Sell, Buy );
Short = ExRem( Short, Cover );
Cover = ExRem( Cover, Short );

PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorBlue, 0, L, Offset=-25);
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorLightBlue, 0,L, Offset=-35);
PlotShapes(IIf(Buy, shapeUpArrow, shapeNone),colorWhite, 0,L, Offset=-30);
PlotShapes(IIf(Short, shapeSquare, shapeNone),colorRed, 0, H, Offset=25);
PlotShapes(IIf(Short, shapeSquare, shapeNone),colorPaleGreen, 0,H, Offset=35);
PlotShapes(IIf(Short, shapeDownArrow, shapeNone),colorWhite, 0,H, Offset=-30);
PlotShapes( abs( exitArray )*shapeHollowCircle, colorYellow, 0, ValueWhen( stopArray, stopArray, 1 ), 0 );
Plot( stopArray, "Diem Stoploss", ParamColor( "Diem Stoploss Color:", colorYellow ), ParamStyle( "Diem Stoploss Style", styleDashed|styleNoRescale ) );


//PlotShapes(shapeCircle * Sell, colorRed);
//PlotShapes(shapeCircle * Cover, colorBlue);



}


_SECTION_END();
// END Turtle trading system





 
//==========================================================================|
//                    23. Psar - Parabolic Stop And Reverse                           |
//==========================================================================|


_SECTION_BEGIN("23. Psar - Parabolic Stop And Reverse");

acc = Param("Acceleration", 0.02, 0, 1, 0.001 );
accm = Param("Max. acceleration", 0.2, 0, 1, 0.001 );

if (psar = ParamToggle( "* Hien thi Psar ",  "OFF|ON", 0 ))
{

Plot( SAR( acc, accm ), _DEFAULT_NAME(),  ParamColor( "Psar Color", colorBlue ), ParamStyle("Psar Style", styleDots | styleNoLine, maskDefault | styleDots | styleNoLine |styleNoRescale) |styleNoRescale);

}


_SECTION_END();

//END Psar - Parabolic Stop And Reverse


 
//==========================================================================|
//                    24. Zig Zag Indicator                           |
//==========================================================================|


_SECTION_BEGIN("24. Zig Zag Indicator ");

P = ParamField( "Price field" );
change = Param("% change",5,0.1,25,0.1);

if (zigzag = ParamToggle( "* Hien thi Zig Zag Indicator ",  "OFF|ON", 0 ))
{

Plot( Zig(P, change), _DEFAULT_NAME(), ParamColor( "Color", colorBlue ), ParamStyle("Style") );
}

_SECTION_END();

// END Zig Zag Indicator  




//==========================================================================|
//                    25. GAP Indicator                           |
//==========================================================================|


_SECTION_BEGIN("25. GAP Indicator ");


Gup = L>Ref(H,-1);  
Gdn = H<Ref(L,-1);  
Gap = Gup OR Gdn;  
LinLen = Param("Chon do dai duong Gap",15,1,100,1);  
ShowLine = BarsSince(Gup OR Gdn) < LinLen;  
TextPos = Showline < Ref(ShowLine,-1);  
GapUpHi = IIf( ShowLine, ValueWhen(Gup,Ref(H,-1)),Null);  
GapUpLo = IIf( ShowLine, ValueWhen(Gup,L), Null); // OK  
GapDnHi = IIf( ShowLine, ValueWhen(GDn,Ref(L,-1)), Null); // OK  
GapDnLo = IIf( ShowLine, ValueWhen(GDn,H), Null);  
GapLineHi = IIf( ShowLine, ValueWhen(Gap,IIf( Gup, L, IIf( GDn, Ref(L,-1), Null))), Null);  
GapLineLo = IIf( ShowLine, ValueWhen(Gap,IIf( Gdn, H, IIf( Gup, Ref(H,-1), Null))), Null); 

if (gapindicator = ParamToggle( "* Hien thi GAP Indicator ",  "OFF|ON", 0 ))
{

 
Plot(GapLineHi,"",5,styleStaircase|styleNoRescale);  
Plot(GapLineLo,"",4,styleStaircase|styleNoRescale);  
FirstVisibleBar = Status( "FirstVisibleBar" );  
Lastvisiblebar = Status("LastVisibleBar");  
for( b = Max(LinLen,Firstvisiblebar); b <= Lastvisiblebar AND b < BarCount; b++)  
{  
if( Gap[b-LinLen+1] )  
{  
PlotText(NumToStr(GapLineHi[b],1.2),b,GapLineHi[b],5);  
PlotText("\n"+NumToStr(GapLineLo[b],1.2),b,GapLineLo[b],4);  
}  
}



}

_SECTION_END();

// END GAP Indicator 



//====================================================================================|
//                       26. Tin hieu luot song ngan hanT+4 ngay                               |
//====================================================================================|
// 



_SECTION_BEGIN("26. Tin hieu luot song ngan han T+4 ngay ");

// 4-Day-Range Switch 
prevt4=AMA2(C,1,0);
dt4=IIf(C>Ref(Max(Max(H,Ref(H,-3)),Max(Ref(H,-1),Ref(H,-2))),-1),Min(Min(L,Ref(L,-3)),Min(Ref(L,-1),Ref(L,-2))),
IIf(C<Ref(Min(Min(L,Ref(L,-3)),Min(Ref(L,-1),Ref(L,-2))),-1),Max(Max(H,Ref(H,-3)),Max(Ref(H,-1),Ref(H,-2))),PREVT4));
at4=Cross(Close,dt4);
bt4=Cross(dt4,Close);
state=IIf(BarsSince(at4)<BarsSince(bt4),1,0);
Buyt4=state>Ref(state,-1);
Sellt4=state<Ref(state,-1);
Noaction=state==Ref(state,-1);
col=IIf(state == 1 ,51,IIf(state ==0,4,1));



 
if (ParamToggle("* Tin hieu luot song ngan han T+4 ngay", "OFF|ON" , 0  ))
{

PlotShapes( IIf( Buyt4 , shapeUpArrow + shapeDigit4 , shapeNone ), colorBlue, 0, L, Offset =50 );
PlotShapes( IIf( Buyt4 , shapeUpArrow , shapeNone ), colorBlue, 0, L, Offset =-35 );

PlotShapes( IIf( Sellt4 , shapeDownArrow + shapeDigit3 , shapeNone ), colorYellow, 0, H , Offset=50 );
PlotShapes( IIf( Sellt4 , shapeDownArrow , shapeNone ), colorYellow, 0, H , Offset=-35 );

/*
PlotShapes(IIf(Buyt4, shapeUpArrow, shapeNone),colorViolet, 0,L, Offset=-30);
PlotShapes(IIf(Sellt4, shapeDownArrow, shapeNone),colorRed, 0,H, Offset=-30);
*/

/*
PlotShapes( shapeUpArrow * Buy ,colorBlue,0,L);
PlotShapes( shapeDownArrow *Sell ,colorYellow,0,H);
*/

/*
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorBlue, 0, L, Offset=-25);
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorLightBlue, 0,L, Offset=-35);
PlotShapes(IIf(Buy, shapeUpArrow, shapeNone),colorWhite, 0,L, Offset=-30);
PlotShapes(IIf(Sell, shapeSquare, shapeNone),colorRed, 0, H, Offset=25);
PlotShapes(IIf(Sell, shapeSquare, shapeNone),colorPaleGreen, 0,H, Offset=35);
PlotShapes(IIf(Sell, shapeDownArrow, shapeNone),colorWhite, 0,H, Offset=-30);
*/

}
 

_SECTION_END();
// END Tin hieu Buy4 Sell4  










//====================================================================================|
//                       27. Tin hieu Buy4 Sell4                                 |
//====================================================================================|
//  Mua khi gia vuot dinh 4 ngay, Ban khi gia pha day 4 ngay  (Dung cho Trend ngan han)



_SECTION_BEGIN("27. Tin hieu Buy4 Sell4 (Mua ngan han - Ban ngan han)");

//Buy 4 Sell 4
mua =   
C >= Ref(H,-1)
AND C >= Ref(H,-2)
AND C >= Ref(H,-3)
AND C >= Ref(H,-4);
ban =  
C <= Ref(L,-1)
AND C <= Ref(L,-2)
AND C <= Ref(L,-3)
AND C <= Ref(L,-4)
OR ( HHV(C,3)>1.1*C) ;
 
Buyt42 = ExRem(mua, ban);
Sellt42 = ExRem(ban, mua);

 
if (ParamToggle("* Tin hieu Buy4 Sell4 (Song ngan han)", "OFF|ON" ,0  ))
{

PlotShapes( IIf( Buyt42 , shapeUpArrow + shapeDigit4 , shapeNone ), colorBrightGreen, 0, L, Offset =50 );
PlotShapes( IIf( Buyt42 , shapeUpArrow , shapeNone ), colorBrightGreen, 0, L, Offset =-35 );

PlotShapes( IIf( Sellt42 , shapeDownArrow + shapeDigit3 , shapeNone ), colorRed, 0, H , Offset=50 );
PlotShapes( IIf( Sellt42 , shapeDownArrow , shapeNone ), colorRed, 0, H , Offset=-35 );


/*
PlotShapes(IIf(Buyt42, shapeUpArrow, shapeNone),colorBlue, 0,L, Offset=-30);
PlotShapes(IIf(Sellt42, shapeDownArrow, shapeNone),colorYellow, 0,H, Offset=-30);
*/

}
 

_SECTION_END();
// END Tin hieu Buy4 Sell4  





//====================================================================================|
//                       28. Tin hieu Buy4 Sell8                               |
//====================================================================================|
//  Mua khi gia vuot dinh 4 ngay, Ban khi gia pha day 8 ngay  (Danh cho Trend dai han)


_SECTION_BEGIN("28. Tin hieu Buy4 Sell8 (Mua ngan han - Ban dai han) ");

//Buy 4 Sell 8
mua =   
C >= Ref(H,-1)
AND C >= Ref(H,-2)
AND C >= Ref(H,-3)
AND C >= Ref(H,-4);

ban = 
C <= Ref(L,-1)
AND C <= Ref(L,-2)
AND C <= Ref(L,-3) 
AND C <= Ref(L,-4) 
AND C <= Ref(L,-5) 
AND C <= Ref(L,-6) 
AND C <= Ref(L,-7)
AND C <= Ref(L,-8) ;
 
Buy42 = ExRem(mua, ban);
Sell8 = ExRem(ban, mua);

 
if (ParamToggle("* Tin hieu Buy4 Sell8 ", "OFF|ON" ,0  ))
{

PlotShapes( IIf( Buy42 , shapeUpArrow + shapeDigit4 , shapeNone ), colorBrightGreen, 0, L, Offset =50 );
PlotShapes( IIf( Buy42 , shapeUpArrow , shapeNone ), colorBrightGreen, 0, L, Offset =-35 );

PlotShapes( IIf( Sell8 , shapeDownArrow + shapeDigit7 , shapeNone ), colorRed, 0, H , Offset=50 );
PlotShapes( IIf( Sell8 , shapeDownArrow , shapeNone ), colorRed, 0, H , Offset=-35 );


/*
PlotShapes(IIf(Buy42, shapeUpArrow, shapeNone),colorBlue, 0,L, Offset=-30);
PlotShapes(IIf(Sell8, shapeDownArrow, shapeNone),colorYellow, 0,H, Offset=-30);
*/

}
 
_SECTION_END();

// END Tin hieu Buy4 Sell8  




//====================================================================================|
//                       29. Tin hieu Buy8 Sell8                               |
//====================================================================================|
//  Mua khi gia vuot dinh 4 ngay, Ban khi gia pha day 8 ngay  (Danh cho Trend dai han)




_SECTION_BEGIN("29. Tin hieu Buy8 Sell8 (Mua dai han - Ban dai han)");

//Buy 8 Sell 8
mua =   
C >= Ref(H,-1)
AND C >= Ref(H,-2)
AND C >= Ref(H,-3)
AND C >= Ref(H,-4)
AND C >= Ref(H,-5)
AND C >= Ref(H,-6)
AND C >= Ref(H,-7)
AND C >= Ref(H,-8);

ban = 
C <= Ref(L,-1)
AND C <= Ref(L,-2)
AND C <= Ref(L,-3) 
AND C <= Ref(L,-4) 
AND C <= Ref(L,-5) 
AND C <= Ref(L,-6) 
AND C <= Ref(L,-7)
AND C <= Ref(L,-8) ;
 
Buy8 = ExRem(mua, ban);
Sell8 = ExRem(ban, mua);

 
if (ParamToggle("* Tin hieu Buy8 Sell8 - Song dai han", "OFF|ON" ,0  ))
{


PlotShapes( IIf( Buy8 , shapeUpArrow + shapeDigit8 , shapeNone ), colorBrightGreen, 0, L, Offset =50 );
PlotShapes( IIf( Buy8 , shapeUpArrow , shapeNone ), colorBrightGreen, 0, L, Offset =-35 );

PlotShapes( IIf( Sell8 , shapeDownArrow + shapeDigit7 , shapeNone ), colorRed, 0, H , Offset=50 );
PlotShapes( IIf( Sell8 , shapeDownArrow , shapeNone ), colorRed, 0, H , Offset=-35 );



/*
PlotShapes(IIf(Buy8, shapeUpArrow, shapeNone),colorBlue, 0,L, Offset=-30);
PlotShapes(IIf(Sell8, shapeDownArrow, shapeNone),colorYellow, 0,H, Offset=-30);
*/


}
 
_SECTION_END();

// END Tin hieu Buy8 Sell8  



//====================================================================================|
//                       30. Tin hieu MUA - Ban theo ATR                                 |
//====================================================================================|



_SECTION_BEGIN("30. Tin hieu MUA - Ban theo ATR");

// get start date 
Start = Cross( DateNum(), ParamDate("Chon ngay bat dau", "2018-01-01" ) ); 
Started = Flip( Start, 0 ); 
 
StopMode = ParamToggle("Stop Mode", "Fixed|Chandelier" ); 
StopLevel = Param("Fixed perc %", 14, 0.1, 50, 0.1)/100; 
StopATRFactor = Param("Chandelier ATR multiple", 4, 0.5, 10, 0.1 ); 
StopATRPeriod = Param("Chandelier ATR period", 14, 3, 50 ); 

 
if (ParamToggle("* Tin hieu MUA - Ban theo ATR", "OFF|ON" ,0  ))
{


 
// calculate support and resistance levels 
if( StopMode == 0 ) // fixed percent trailing stop 
{ 
 sup = C * ( 1 - stoplevel ); 
 res = C * ( 1 + stoplevel ); 
} 
else // Chandelier ATR-based stop 
{ 
 sup = C - StopATRFactor * ATR( StopATRPeriod ); 
 res = C + StopATRFactor * ATR( StopATRPeriod ); 
} 
 
// calculate trailing stop line 
trailARRAY = Null; 
trailstop = 0; 
for( i = 1; i < BarCount; i++ ) 
{ 
if( Started[ i ] == 0 ) continue; 
 
if( C[ i ] > trailstop AND C[ i - 1 ] > trailstop ) 
   trailstop = Max( trailstop, sup[ i ] ); 
else
if( C[ i ] < trailstop AND C[ i - 1 ] < trailstop ) 
   trailstop = Min( trailstop, res[ i ] ); 
else
   trailstop = IIf( C[ i ] > trailstop, sup[ i ], res[ i ] );       
 
trailARRAY[ i ] = trailstop; 
} 
 
// generate buy/sell signals based on crossover with trail stop line 
Buy = Start OR Cross( C, trailArray ); 
Sell = Cross( trailArray, C ); 
 
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorBlue, 0, L, Offset=-25);
PlotShapes(IIf(Buy, shapeSquare, shapeNone),colorLightBlue, 0,L, Offset=-35);
PlotShapes(IIf(Buy, shapeUpArrow, shapeNone),colorWhite, 0,L, Offset=-30);

PlotShapes(IIf(Sell, shapeSquare, shapeNone),colorRed, 0, H, Offset=25);
PlotShapes(IIf(Sell, shapeSquare, shapeNone),colorPaleGreen, 0,H, Offset=35);
PlotShapes(IIf(Sell, shapeDownArrow, shapeNone),colorWhite, 0,H, Offset=-30);

/*
PlotText( "ATR", colorBlack, colorBrightGreen ), 0,L, Offset=-30);
	PlotText( "ATR", i , L[ i ]-dist[i], colorBlack, colorBrightGreen ) ; 
 */
 

Plot( trailARRAY,"trailing stop level", colorBlue , styleLine|styleNoRescale );

}
 



_SECTION_END();

// END Diem MUA - Ban theo ATR



   
   



//==========================================================================|
//                    Chay bo loc VSA                              |
//==========================================================================|

_SECTION_BEGIN("Exploration VSA");



Filter=  (upThrustBar OR upThrustCond2 OR upThrustCond3 OR strengthDown OR strengthDown0 OR strengthDown1 OR strengthDown2 OR effortUp OR effortDown OR stopVolume OR PseudoUpThrust OR pseudoUtCond
         OR trendChange OR lowVolTest OR lowVolTest1 OR topRevBar OR lowVolTest2 OR buyCond OR noDemandBarUt OR noDemandBarDt OR effortUpfail) 
        
         
AND V>10000          
AND C*V >= 100000 AND C*V < 4000000000 AND MA(V,20) >= 100000 
AND Ref(C,-5)*Ref(V,-5) >= 1000000 AND Ref(C,-10)*Ref(V,-10) >= 1000000 
AND Ref(V,-5) >= 50000 AND Ref(V,-10) >= 50000 ;

tcolor = IIf(strengthDown OR strengthDown1 OR buyCond, 42, IIf(buycond , colorPaleGreen, IIf(strengthDown2, colorPaleGreen,  
        IIf(upThrustBar OR upThrustCond1 OR sellcond, 33, IIf(upThrustCond2 OR upThrustCond3, 25, IIf(effortUp, colorLime, IIf(effortDown,colorRed, IIf(PseudoUpThrust,33,
        IIf(pseudoUtCond OR noDemandBarUt,colorOrange, IIf(strengthDown0 OR noSupplyBar OR lowVolTest OR lowVolTest1 OR lowVolTest2,42, IIf(stopVolume OR revUpThrust,42, IIf(upThrustCond1,colorOrange,
        IIf(trendChange,33,colorPaleBlue))))))))))))); 

AddTextColumn(
WriteIf (upThrustBar, "Dau hieu cua Diem Yeu. ",
WriteIf (upThrustCond1	, "Su xac nhan cua Diem Yeu. ",
WriteIf (upThrustCond2	 AND NOT upThrustCond1	, "Su xac nhan cua Diem Yeu.",
WriteIf (upThrustCond3	, "Su xac nhan cua Diem Yeu",
WriteIf (strengthDown1, "Suc manh dang tro lai. ",
WriteIf (strengthDown0 AND NOT strengthDown, "Suc manh dang tro lai. ",
WriteIf (strengthDown AND NOT strengthDown1, "Suc manh dang tro lai. ",
WriteIf (lowVolTest , "Test for supply - Kiem dinh nguon cung. ",
WriteIf (lowVolTest2 , "Su xac nhan cua Diem Manh. ",
WriteIf (buyCond, "Su thay doi tich cuc ",
WriteIf (Sellcond, "Su thay doi tieu cuc ",
WriteIf (PseudoUpThrust, "Dau hieu cua Diem Yeu. ",
WriteIf (topRevBar, "Top Reversal - Dao chieu o dinh (Nhan chim giam). Dau hieu cua Diem Yeu. ",
WriteIf (pseudoUtCond, "Su xac nhan cua Diem Yeu. ",
WriteIf (lowVolTest1, "Dau hieu cua Diem Manh. ",
WriteIf (strengthDown2, "Boc lo Suc Manh. ",
WriteIf (noSupplyBar, "Boc lo Suc Manh. ",
WriteIf (trendChange, "Boc lo Diem Yeu. ",
WriteIf (noDemandBarUt, "Dau hieu cua Diem Yeu. ",
WriteIf (noDemandBarDT, "Dau hieu cua Diem Yeu. ",
WriteIf (stopVolume, "Su ket thuc cua xu huong giam dang rat gan",
WriteIf (revUpThrust, "Su ket thuc cua xu huong giam dang rat gan ",
WriteIf (effortUp, "Dau hieu Tang gia ",
WriteIf (effortDown	, "Dau hieu Giam gia ",
WriteIf (effortDownfail	, "Dau hieu Tang gia ",
WriteIf (effortUpfail, "Dau hieu Giam gia ","")))))))))))))))))))))))))), "Dau hieu" , 1, colorDefault, tcolor,110);

AddTextColumn(
WriteIf (upThrustBar, " Thanh gia Upthrust. ",
WriteIf (upThrustCond1, " Thanh gia giam sau mot thanh Upthrust. ",
WriteIf (upThrustCond2 AND NOT upThrustCond1, " Mot thanh gia giam voi khoi luong cao di sau thanh Upthrust.",
WriteIf (upThrustCond3, "Day la thanh Upthrust voi khoi luong sieu cao.",
WriteIf (strengthDown1, "Suc manh dang quay lai sau mot xu huong giam (Co Cau dang bat day). ",
WriteIf (strengthDown0 AND NOT strengthDown, "Suc manh dang quay lai sau mot xu huong giam (Co Cau dang bat day). ",
WriteIf (strengthDown AND NOT strengthDown1, "Suc manh dang quay lai sau mot xu huong giam (Co Cau dang bat day). ",
WriteIf (lowVolTest , "Test for supply - Kiem dinh nguon cung. ",
WriteIf (lowVolTest2, "Thanh gia tang sau khi Test cung thanh cong, Diem Manh duoc xac nhan ",
WriteIf (buyCond, "Co the ket thuc xu huong GIAM va bat dau xu huong TANG",
WriteIf (Sellcond, "Co the ket thuc xu huong TANG va bat dau xu huong GIAM",
WriteIf (PseudoUpThrust, "Psuedo UpThrust - Upthrust gia tao (Co khoi luong thap hon 2 thanh gia truoc do). ",
WriteIf (topRevBar, "Dao chieu o dinh. Hay than trong. Xac suat ket thuc da tang hien tai rat cao",
WriteIf (pseudoUtCond, "Mot thanh gia giam voi muc dong cua o phia duoi thap theo sau thanh Pseudo Upthrust - Upthrust gia tao. ",
WriteIf (lowVolTest1, "Test for supply - Kiem dinh nguon cung trong xu huong tang. ",
WriteIf (strengthDown2, "Thanh tang gia voi khoi luong cao, co muc gia dong cua o phia tren cao. ",
WriteIf (trendChange, "Giam gia voi khoi luong cao sau mot xu huong tang. ",
WriteIf (noDemandBarUt, "No Demand  - Khong co cau trong xu huong tang. Dau hieu cua Diem Yeu. ",
WriteIf (noDemandBarDt, "No Demand - Khong co cau. Xu huong tang som ket thuc. ",
WriteIf (stopVolume, "Stopping volume - Khoi luong dung. ",
WriteIf (noSupplyBar, "No Supply - Khong co nguon cung. Dau hieu cua Diem Manh",
WriteIf (revUpThrust, "Thanh UpThrust dao nguoc. ",
WriteIf (effortUp, "No luc day gia TANG. ",
WriteIf (effortDown	, "No luc day gia GIAM.  ",
WriteIf (effortUpfail, "No luc day gia GIAM that bai. ",
WriteIf (effortUpfail, "No luc day gia TANG that bai. ","")))))))))))))))))))))))))), "Tinh trang" , 1, colorDefault, tcolor,250);
 _SECTION_END ();
 
 //END Chay bo loc VSA

//==========================================================================|
// Chay bo loc cac chi bao BollingerBand, MAs, MACD, Aroon, Stochastic, RSI, MFI                        |
//==========================================================================|

//www.stockbangladesh.com
_SECTION_BEGIN("All in One Explorer - Manish");
i=0;
//52 Week High Low
High52 = HHV(High,250);
Low52 = LLV(Low,250);

//Bollinger Band
BB1=C>BBandTop(C,20,2) AND Ref(C,-1)<Ref(BBandTop(C,20,2),-1);
BB2=C<BBandBot(C,20,2) AND Ref(C,-1)>Ref(BBandBot(C,20,2),-1);
BBStatus=WriteIf(BB1,"Above Top",WriteIf(BB2,"Below Bottom",WriteIf(IsNull(MA(C,20)),"N/A","Neutral")));
BBColor=IIf(BB1,colorRed,IIf(BB2,colorGreen,colorLightGrey));
IIf(BB2,i+1,i);

//Moving Average (Short, Mid & Long Term)
MAShort = C>MA(C,15);
IIf(MAShort,i+1,i);
MAMid = C>MA(C,45);
IIf(MAMid,i+1,i);
MALong = C>MA(C,100);
IIf(MALong,i+1,i);
ShortStatus = WriteIf(MAShort,"Bullish",WriteIf(IsNull(MA(C,15)) ,"N/A","Bearish"));
ShortColor = IIf(MAShort,colorGreen,colorRed);
MidStatus = WriteIf(MAMid,"Bullish",WriteIf(IsNull(MA(C,45))," N/A","Bearish"));
MidColor = IIf(MAMid,colorGreen,colorRed);
LongStatus = WriteIf(MALong,"Bullish",WriteIf(IsNull(MA(C,100)) ,"N/A","Bearish"));
LongColor = IIf(MALong,colorGreen,colorRed);

//MACD
MACDBull=MACD(12,26)>Signal(12,26,9);
IIf(MACDBull,i+1,i);
MACDStatus=WriteIf(MACDBull,"Bullish",WriteIf(IsNull(MACD(12,26)),"N/A","Bearish"));
MACDColor=IIf(MACDBull,colorGreen,colorRed);

//Aroon
Period=14;
LLVBarsSince=LLVBars(L,Period)+1;
HHVBarsSince=HHVBars(H,Period)+1;
AroonDown=100*(Period-LLVBarsSince)/(Period-1);
AroonUp=100*(Period-HHVBarsSince)/(Period-1);
AroonOsc=AroonUp-AroonDown;
Aroon=AroonOsc>0;
IIf(Aroon,i+1,i);
AroonStatus=WriteIf(Aroon,"Bullish",WriteIf(IsNull (RSI(14)),"N/A","Bearish"));
AroonColor=IIf(Aroon,colorGreen,IIf(IsNull(RSI(14) ),colorLightGrey,colorRed));

//Stochastic
StochKBull=StochK(14,3)>StochD(14,3,3);
IIf(StochKBull,i+1,i);
StochKStatus=WriteIf(StochKBull,"Bullish",WriteIf( IsNull(StochK(14,3)),"N/A","Bearish"));
StochKColor=IIf(StochKBull,colorGreen,colorRed);

//RSI
R1=RSI(14)>30 AND Ref(RSI(14),-1)<30 AND Ref(RSI(14),-2)<30;
R2=RSI(14)<70 AND Ref(RSI(14),-1)>70 AND Ref(RSI(14),-2)>70;
IIf(R1,i+1,i);
RSIStatus=WriteIf(R1,"Improving",WriteIf(R2,"Decli ning",WriteIf(IsNull(RSI(14)),"N/A","Neutral")));
RSIColor=IIf(R1,colorGreen,IIf(R2,colorRed,colorLightGrey));
//www.pipschart.com
//MFI
M1=MFI(14)>80;
M2=MFI(14)<20;
IIf(M2,i+1,i);
MFIStatus=WriteIf(M1,"Overbought",WriteIf(M2,"Over sold",WriteIf(IsNull(MFI(14)),"N/A","Neutral")));
MFIColor=IIf(M1,colorRed,IIf(M2,colorGreen,colorLightGrey));


 TrendScore =
 IIf(BB2,1,0)+
 IIf(MAShort,1,0)+
 IIf(MAMid,1,0) + 
 IIf(MALong,1,0)+
 IIf(MACDBull,1,0) +
 IIf(Aroon,1,0) +
 IIf(StochKBull,1,0)+
 IIf(R1,1,0) +
 IIf(M2,1,0) ;





/*
TrendScore =

IIf(C>=Ref(C,-11),1,-1)+
IIf(C>=Ref(C,-12),1,-1)+
IIf(C>=Ref(C,-13),1,-1)+
IIf(C>=Ref(C,-14),1,-1)+
IIf(C>=Ref(C,-15),1,-1)+
IIf(C>=Ref(C,-16),1,-1)+
IIf(C>=Ref(C,-17),1,-1)+
IIf(C>=Ref(C,-18),1,-1)+
IIf(C>=Ref(C,-19),1,-1)+
IIf(C>=Ref(C,-20),1,-1);
*/





//AddColumn(High52,"52 Week High");
//AddColumn(Low52,"52 Week Low");
AddColumn(C,"Close",1,IIf(C>Ref(C,-1),colorGreen,colorRed));
AddColumn(V,"Volume",1,IIf(V>Ref(V,-1),colorGreen,colorRed));
AddTextColumn(BBStatus,"BBand",1,colorWhite,BBColor);
AddTextColumn(ShortStatus,"Short MA(15)",1,colorWhite,ShortColor);
AddTextColumn(MidStatus,"Mid MA(45)",1,colorWhite,MidColor);
AddTextColumn(LongStatus,"Long MA(100)",1,colorWhite,LongColor);
AddTextColumn(MACDStatus,"MACD",1,colorWhite,MACDColor);
AddTextColumn(AroonStatus,"Aroon",1,colorWhite,AroonColor);
AddTextColumn(StochKStatus,"Stochastic",1,colorWhite,StochKColor);
AddTextColumn(RSIStatus,"RSI(14)",1,colorWhite,RSIColor);
AddTextColumn(MFIStatus,"MFI(14)",1,colorWhite,MFIColor);
AddColumn(TrendScore,"Score");
_SECTION_END();

// END  Chay bo loc cac chi bao BollingerBand, MAs, MACD, Aroon, Stochastic, RSI, MFI   






//|============================================================================================|
//|                                       TITLE - TIEU DE                                      |
//|============================================================================================|




_N(Title = EncodeColor(colorSeaGreen)+ " - VSA + VPA Analysis V5.1 (Edit by binhnt.tamviet@gmail.com)"
        +("\n")+ 
        EncodeColor(colorGold)+ " - " + FullName() + " ("+Name()+") - " + "(" + Interval(2) +")" + EncodeColor(colorOrange) + "  - " + Date() 
 
 

//====================================================================================|
//                       Hien thi thong tin Gia va Khoi luong                            |
//====================================================================================|

+("\n")+ EncodeColor(colorLime)+"-------------------------------------------------------------------" +("\n")+ // Xuong dong

EncodeColor(colorBlue) + "   - Volume:       "+ 

WriteIf(V>MA(V,30)*1.5,EncodeColor(colorViolet)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) + "%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")" ,
WriteIf(V<MA(V,30)*1.5 AND V>=MA(V,30)*1.1  ,EncodeColor(colorGreen)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) +"%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")",
WriteIf(V<MA(V,30)*1.1 AND V>MA(V,30)*0.9  ,EncodeColor(colorYellow)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) + "%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")",
WriteIf(V<=MA(V,30)*0.9 AND V>=MA(V,30)*0.5,EncodeColor(colorRed)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) + "%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")" ,
WriteIf(V<MA(V,30)*0.5,EncodeColor(colorTurquoise)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) +"%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")","")))))+


EncodeColor(colorBlue)+("   -   Danh gia: ")+
WriteIf(V>MA(V,30)*2,EncodeColor(colorViolet)+" SIEU CAO",WriteIf(V>MA(V,30)*1.3,EncodeColor(colorGreen)+" CAO",
WriteIf(V>MA(V,30),EncodeColor(colorGreen)+" CAO HON TRUNG BINH",
WriteIf(V<MA(V,30) AND V>MA(V,30)*0.7,EncodeColor(colorRed)+" THAP HON TRUNG BINH",
WriteIf(V<MA(V,30)*0.7 AND V>MA(V,30)*0.3,EncodeColor(colorRed)+" THAP",WriteIf(V<MA(V,30)*0.3,EncodeColor(colorTurquoise)+" RAT THAP",""))))))+

(EncodeColor(colorBlue)+"\n   - Bien dong gia (Spread): ")+

WriteIf(spread >avgSpread*1.5,EncodeColor(colorViolet)+" RONG",
WriteIf(spread <avgSpread*1.5 AND spread>avgSpread ,EncodeColor(colorGreen)+" TREN TRUNG BINH",
WriteIf(spread < avgSpread AND spread >= AvgSpread*0.7,EncodeColor(colorYellow)+"HEP HON TRUNG BINH",
WriteIf(spread < AvgSpread*0.7 AND spread >= AvgSpread*0.3,EncodeColor(colorRed)+" HEP",
WriteIf(spread < AvgSpread*0.3,EncodeColor(colorTurquoise)+" RAT HEP","")))))+

(EncodeColor(colorBlue)+"      -   Vi tri gia dong cua:  ")+
WriteIf(ClosePos==5,EncodeColor(colorViolet)+" CAO NHAT",
WriteIf(ClosePos==4,EncodeColor(colorGreen)+" PHAN TREN",
WriteIf(ClosePos==3,EncodeColor(colorYellow)+" NGAY GIUA",
WriteIf(ClosePos==2,EncodeColor(colorRed)+" PHAN DUOI",
EncodeColor(colorTurquoise)+" THAP NHAT"))))+ 

"\n"+
EncodeColor(colorBlue) + "   - Open: " +EncodeColor(colorYellow) +O+ 
EncodeColor(colorGreen) + "    - High: " +EncodeColor(colorYellow) +H+ 
EncodeColor(colorDarkRed) + "    - Low: " +EncodeColor(colorYellow) +L+ 
EncodeColor(colorSeaGreen) + "    - Close: " +

WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)>=6,EncodeColor(colorViolet)  +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",
WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)<=-6,EncodeColor(colorTurquoise) +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",
WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)>0 AND Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)<=6,EncodeColor(colorCustom9) +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",
WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)<0 AND Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)>=-6,EncodeColor(colorRed) +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",EncodeColor(colorYellow)  +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)"))))


+






EncodeColor(colorLime)+("\n   - ")+
WriteIf(upimd==1,EncodeColor(colorGreen) +" Xu huong ngan han: TANG - UP",
WriteIf(dnimd==1,EncodeColor(colorRed)   +" Xu huong ngan han: GIAM - DOWN",
                 EncodeColor(colorYellow)+" Xu huong ngan han: Khong ro rang"))+
                 

EncodeColor(colorLime)+("\n   - ")+
WriteIf(upminor==1,EncodeColor(colorGreen) +" Xu huong trung han: TANG - UP",
WriteIf(dnminor==1,EncodeColor(colorRed)   +" Xu huong trung han: GIAM - DOWN",
                   EncodeColor(colorYellow)+" Xu huong trung han: Khong ro rang"))+
WriteIf(upmajoroff,  EncodeColor(colorSeaGreen)+"  (Xu huong TANG trung han truoc do co the ket thuc)",
WriteIf(dnmajoroff,  EncodeColor(colorSeaGreen)+"  (Xu huong GIAM trung han truoc do co the ket thuc)","" ))+


EncodeColor(colorLime)+("\n   - ")+
WriteIf(upmajor==1,  EncodeColor(colorGreen) +" Xu huong dai han:     TANG - UP",
WriteIf(upmajor== -1,EncodeColor(colorRed)   +" Xu huong dai han:     GIAM - DOWN",
                     EncodeColor(colorYellow)+" Xu huong dai han:     Khong ro rang"))+
WriteIf(upminoroff,EncodeColor(colorSeaGreen)+"  (Xu huong TANG dai han truoc do co the ket thuc)",
WriteIf(dnminoroff,EncodeColor(colorSeaGreen)+"  (Xu huong GIAM dai han truoc do co the ket thuc)","" ))+







//====================================================================================|
//                       Hien thi tin hieu mua Ichimoku Kinko Hyo                             |
//====================================================================================|

WriteIf(Muaichi,EncodeColor(colorLime)+"\n ------------------------------------------------------------------- \n " +
    
    EncodeColor(colorBlue) + "  - Ichimoku Kinko Hyo","")+

	EncodeColor(colorBlue) + WriteIf(TinHieu1, "\n" + "   - Tin hieu Mua so 1: " + 
	EncodeColor(colorCustom9) + "  Vuot may Kumo va duong Kijun Sen tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu2, "\n" + "   - Tin hieu Mua so 2: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Tenkan Sen vuot len Kijun Sen +  Gia vuot len Tenkan Sen tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu3, "\n" + "   - Tin hieu Mua so 3: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Vuot len may Sen + Tenkan Sen vuot len Kijun Sen tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu4, "\n" + "   - Tin hieu Mua so 4: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Senkou Span A vuot len Senkou Span B tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu5, "\n" + "   - Tin hieu Mua so 5: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Gia vuot len Tenkan Sen + Chikou Span vuot len duong Gia tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(VuotMay, "\n"  + "   - Vuot may Sen:" + 
	EncodeColor(colorCustom9) + "  Tin hieu Mua Manh!!!", "") + 
	
	EncodeColor(colorBlue) + WriteIf(VuotMaySenKumo, "\n"  + "   - Vuot ca may Sen va may Kumo:" + 
	EncodeColor(colorCustom9) + "  Tin hieu Mua rat Manh!!!", "") + 
	
	EncodeColor(colorYellow) + WriteIf(HopBich, "\n"  + "   - Chu y: Co tin hieu giao cat giua Tenkan Sen va Kijun Sen:" + 
	EncodeColor(colorLime) + "  Gia van trong xu the Tang, Co the gia tang them vi the Mua (Long): " +TL+ "", "")
	
	                         
		

 //|============================================================================================|
//|                                       Hien thi Tin hieu canh bao  VSA                                   |
//|============================================================================================|

  /*
strength	= sc OR tbc2a OR tbc2 or effortDownfail OR 	strengthDown OR strengthDown1 OR strengthDown2 OR 
              strengthDown0 OR bullBar OR effortUp OR upBar  OR revUpThrust ;

weakness	= bc or upThrustBartrue OR upThrustCond1 OR upThrustCond2 OR upThrustCond3 OR PseudoUpThrust OR pseudoUtCond   
             OR tbc4 or effortUpfail or Sellcond OR  upThrustBar OR  effortDown  OR bearBar OR downBar ;

vsachange = trendChange OR lowVolTest or lowVolTest1 or lowVolTest2 or buyCond  OR noSupplyBar or stopVolume or noDemandBarDt OR noDemandBarUt 
           or topRevBar OR Fom1 OR tbc3 OR tbc5  ;

*/ 


//1. Tin hieu canh bao xuat hien Diem Yeu

 +WriteIf(weakness OR strength OR vsachange,EncodeColor(colorLime)+"\n ------------------------------------------------------------------- \n " 
                                         +EncodeColor(colorBlue) +"   - Canh bao VSA:  ","")+

EncodeColor(colorRed)+

WriteIf (bc,"\n +Buying Climax - Cao trao Mua tiem nang. ","")+
WriteIf (upThrustBartrue, "\n +Day la mot thanh Upthrust thuc su. Dau hieu Diem Yeu kha chac chan. ","")+
WriteIf (upThrustBar OR upThrustCond1 OR upThrustCond2 OR upThrustCond3, "\n  +Day la mot thanh Upthrust. Mot dau hieu cua Diem Yeu. ","")+
WriteIf (PseudoUpThrust, "\n +Psuedo UpThrust - Upthrust gia tao (co khoi luong thap hon 2 thanh truoc no). Dau hieu cua Diem Yeu. ","")+
WriteIf (pseudoUtCond AND NOT PseudoUpThrust, "\n +Mot thanh gia giam co gia dong cua o muc thap, di sau mot thanh Pseudo Upthrust. Xac nhan cua Diem Yeu. ","")+
WriteIf (effortUpfail, "\n +No luc tang gia that bai (Effort to Move up has failed). Tin hieu giam gia. ","")+
WriteIf (Sellcond, "\n +Xu huong TANG co kha nang se KET THUC va som bat dau mot xu huong GIAM. ","")+
WriteIf (effortDown, "\n  +No luc day gia GIAM (Effort to Fall). Dau hieu cua Diem Yeu.  ","")+
WriteIf (tbc4, "\n +Hai thanh gia dao chieu giam gia (Nhan chim giam) voi khoi luong cao hon. Dau hieu cua Diem Yeu", "")+

//2. Tin hieu canh bao xuat hien Diem Manh


EncodeColor(colorCustom9)+

WriteIf (sc, "\n +Sell Climax - Cao trao BAN. Dau hieu cua Diem Manh."
            +"\n Neu co Khoi luong cao se ho tro cho Diem Manh nay. ","")+
WriteIf (tbc2a , "\n +Hai thanh gia giong voi 2 thanh dao chieu tang voi Khoi luong cao hon. Dau hieu cua Diem Manh. ", "")+
WriteIf (tbc2 AND NOT tbc2a, "\n +Hai thanh gia dao chieu tang (Nhan chim tang) voi Khoi luong cao hon. Dau hieu cua Diem Manh. ", "")+
WriteIf (effortDownfail, "\n +No luc day gia xuong that bai (Effort to Move Down has failed). Dau hieu cua Diem Manh.  ","")+
WriteIf (strengthDown OR strengthDown0 OR strengthDown1 OR strengthDown2 , "\n +Diem Manh xuat hien tro lai sau mot xu huong giam. Neu co Khoi luong cao se ho tro cho Diem Manh nay. ","")+
WriteIf (effortUp, "\n +Mot no luc day gia tang (Effort to Rise) . Dau hieu cua Diem Manh.  ","")+
WriteIf (revUpThrust, "\n +Thanh gia Upthrust dao nguoc. Dau hieu cua Diem Manh. ","")+


//3. Tin hieu canh bao dau hieu dao chieu xu huong truoc do 


EncodeColor(colorYellow)+

WriteIf (trendChange, "\n +Mot thanh gia GIAM voi Khoi luong cao sau mot dot tang gia. Dau hieu cua Diem Yeu. ","")+
WriteIf (topRevBar, "\n +Top Reversal - Dao chieu giam o dinh. Dau hieu cua Diem Yeu. ","")+
WriteIf (noDemandBarDt OR  noDemandBarUt, "\n +No Demand - Khong co Cau. Xu huong tang co the thay doi.  ","")+
WriteIf (Fom1, "\n +Khoi luong CAO nhung gia lai khong di chuyen nhieu. Co the dang gap Vung Khang cu/Ho tro manh - vung Cung/Cau manh me. ","")+
WriteIf (tbc3 AND NOT Fom1 , "\n +Hai thanh gia dao chieu nhau (Nhan chim) voi Khoi luong thap. ", "")+
WriteIf (tbc5 AND NOT tbc3, "\n +Hai thanh gia giong voi 2 thanh dao chieu nhau (Nhan chim) voi Khoi luong thap. ", "")+
WriteIf (buyCond, "\n +Xu huong GIAM co kha nang se KET THUC va som BAT DAU mot xu huong TANG.  ","")+
WriteIf (lowVolTest or lowVolTest1 OR lowVolTest2, "\n +Test for supply - Kiem dinh nguon cung thanh cong. Dau hieu cua Diem Manh. ","")+
WriteIf (noSupplyBar, "\n +No Supply - Khong co nguon cung. Dau hieu cua Diem Manh. ","")+
WriteIf (stopVolume, "\n +Stopping volume - Khoi luong dung giam. Bao hieu xu huong giam sap ket thuc. ","")
	

);



//|============================================================================================|
//|                  END TITLE - TIEU DE                                      |
//|============================================================================================|


//|============================================================================================|
//|                          Phan TITLE - TIEU DE 2 (Them dien giai VSA)                   |
//|============================================================================================|



_SECTION_BEGIN("Hien thi them phan dien giai VSA");


if (SelectedVSA = ParamToggle( "*. Hien thi them phan dien giai VSA",  "OFF|ON", 0 ))
{



_N(Title = EncodeColor(colorSeaGreen)+ " - VSA + VPA Analysis V5.1 (Edit by binhnt.tamviet@gmail.com)"
        +("\n")+ 
        EncodeColor(colorGold)+ " - " + FullName() + " ("+Name()+") - " + "(" + Interval(2) +")" + EncodeColor(colorOrange) + "  - " + Date() 
 
 

//====================================================================================|
//                       Hien thi thong tin Gia va Khoi luong                            |
//====================================================================================|

+("\n")+ EncodeColor(colorLime)+"-------------------------------------------------------------------" +("\n")+ // Xuong dong

EncodeColor(colorBlue) + "   - Volume:       "+ 

WriteIf(V>MA(V,30)*1.5,EncodeColor(colorViolet)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) + "%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")" ,
WriteIf(V<MA(V,30)*1.5 AND V>=MA(V,30)*1.1  ,EncodeColor(colorGreen)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) +"%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")",
WriteIf(V<MA(V,30)*1.1 AND V>MA(V,30)*0.9  ,EncodeColor(colorYellow)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) + "%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")",
WriteIf(V<=MA(V,30)*0.9 AND V>=MA(V,30)*0.5,EncodeColor(colorRed)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) + "%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")" ,
WriteIf(V<MA(V,30)*0.5,EncodeColor(colorTurquoise)+ WriteVal(V,1.0)+ "  =  " + WriteVal(V/MA(V,30)*100,1.0) +"%  (MA30 = "+ WriteVal(MA(V,30),1.0) + ")","")))))



+"     "+
EncodeColor(colorBlue) + "    - Open: " +EncodeColor(colorYellow) +O+ 
EncodeColor(colorGreen) + "    - High: " +EncodeColor(colorYellow) +H+ 
EncodeColor(colorDarkRed) + "    - Low: " +EncodeColor(colorYellow) +L+ 
EncodeColor(colorSeaGreen) + "    - Close: " +

WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)>=6,EncodeColor(colorViolet)  +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",
WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)<=-6,EncodeColor(colorTurquoise) +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",
WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)>0 AND Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)<=6,EncodeColor(colorCustom9) +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",
WriteIf(Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)<0 AND Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)>=-6,EncodeColor(colorRed) +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)",EncodeColor(colorYellow)  +C+ "  =  "+Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)+"  ("+Prec((Prec(C-TimeFrameGetPrice("C",inDaily,-1),2)/TimeFrameGetPrice("C",inDaily,-1))*100,2)+"%)"))))


+
EncodeColor(colorBlue)+("\n   - Khoi luong: ")+
WriteIf(V>MA(V,30)*2,EncodeColor(colorViolet)+" SIEU CAO",WriteIf(V>MA(V,30)*1.3,EncodeColor(colorGreen)+" CAO",
WriteIf(V>MA(V,30),EncodeColor(colorGreen)+" CAO HON TRUNG BINH",
WriteIf(V<MA(V,30) AND V>MA(V,30)*0.7,EncodeColor(colorRed)+" THAP HON TRUNG BINH",
WriteIf(V<MA(V,30)*0.7 AND V>MA(V,30)*0.3,EncodeColor(colorRed)+" THAP",WriteIf(V<MA(V,30)*0.3,EncodeColor(colorTurquoise)+" RAT THAP",""))))))+

(EncodeColor(colorBlue)+"      -   Bien dong gia (Spread): ")+

WriteIf(spread >avgSpread*1.5,EncodeColor(colorViolet)+" RONG",
WriteIf(spread <avgSpread*1.5 AND spread>avgSpread ,EncodeColor(colorGreen)+" TREN TRUNG BINH",
WriteIf(spread < avgSpread AND spread >= AvgSpread*0.7,EncodeColor(colorYellow)+"HEP HON TRUNG BINH",
WriteIf(spread < AvgSpread*0.7 AND spread >= AvgSpread*0.3,EncodeColor(colorRed)+" HEP",
WriteIf(spread < AvgSpread*0.3,EncodeColor(colorTurquoise)+" RAT HEP","")))))+

(EncodeColor(colorBlue)+"      -   Vi tri gia dong cua:  ")+
WriteIf(ClosePos==5,EncodeColor(colorViolet)+" CAO NHAT",
WriteIf(ClosePos==4,EncodeColor(colorGreen)+" PHAN TREN",
WriteIf(ClosePos==3,EncodeColor(colorYellow)+" NGAY GIUA",
WriteIf(ClosePos==2,EncodeColor(colorRed)+" PHAN DUOI",
EncodeColor(colorTurquoise)+" THAP NHAT"))))+ 



EncodeColor(colorLime)+("\n   - ")+
WriteIf(upimd==1,EncodeColor(colorGreen) +" Xu huong ngan han: TANG - UP",
WriteIf(dnimd==1,EncodeColor(colorRed)   +" Xu huong ngan han: GIAM - DOWN",
                 EncodeColor(colorYellow)+" Xu huong ngan han: Khong ro rang"))+
                 

EncodeColor(colorLime)+("\n   - ")+
WriteIf(upminor==1,EncodeColor(colorGreen) +" Xu huong trung han: TANG - UP",
WriteIf(dnminor==1,EncodeColor(colorRed)   +" Xu huong trung han: GIAM - DOWN",
                   EncodeColor(colorYellow)+" Xu huong trung han: Khong ro rang"))+
WriteIf(upmajoroff,  EncodeColor(colorSeaGreen)+"  (Xu huong TANG trung han truoc do co the ket thuc)",
WriteIf(dnmajoroff,  EncodeColor(colorSeaGreen)+"  (Xu huong GIAM trung han truoc do co the ket thuc)","" ))+


EncodeColor(colorLime)+("\n   - ")+
WriteIf(upmajor==1,  EncodeColor(colorGreen) +" Xu huong dai han:     TANG - UP",
WriteIf(upmajor== -1,EncodeColor(colorRed)   +" Xu huong dai han:     GIAM - DOWN",
                     EncodeColor(colorYellow)+" Xu huong dai han:     Khong ro rang"))+
WriteIf(upminoroff,EncodeColor(colorSeaGreen)+"  (Xu huong TANG dai han truoc do co the ket thuc)",
WriteIf(dnminoroff,EncodeColor(colorSeaGreen)+"  (Xu huong GIAM dai han truoc do co the ket thuc)","" ))+







//====================================================================================|
//                       Hien thi tin hieu mua Ichimoku Kinko Hyo                             |
//====================================================================================|

WriteIf(Muaichi,EncodeColor(colorLime)+"\n ------------------------------------------------------------------- \n " +
    
    EncodeColor(colorBlue) + "  - Ichimoku Kinko Hyo","")+

	EncodeColor(colorBlue) + WriteIf(TinHieu1, "\n" + "   - Tin hieu Mua so 1: " + 
	EncodeColor(colorCustom9) + "  Vuot may Kumo va duong Kijun Sen tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu2, "\n" + "   - Tin hieu Mua so 2: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Tenkan Sen vuot len Kijun Sen +  Gia vuot len Tenkan Sen tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu3, "\n" + "   - Tin hieu Mua so 3: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Vuot len may Sen + Tenkan Sen vuot len Kijun Sen tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu4, "\n" + "   - Tin hieu Mua so 4: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Senkou Span A vuot len Senkou Span B tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(TinHieu5, "\n" + "   - Tin hieu Mua so 5: " + 
	EncodeColor(colorCustom9) + "  Nam tren may Kumo + Gia vuot len Tenkan Sen + Chikou Span vuot len duong Gia tai: " +C+ "", "") + 
	
	EncodeColor(colorBlue) + WriteIf(VuotMay, "\n"  + "   - Vuot may Sen:" + 
	EncodeColor(colorCustom9) + "  Tin hieu Mua Manh!!!", "") + 
	
	EncodeColor(colorBlue) + WriteIf(VuotMaySenKumo, "\n"  + "   - Vuot ca may Sen va may Kumo:" + 
	EncodeColor(colorCustom9) + "  Tin hieu Mua rat Manh!!!", "") + 
	
	EncodeColor(colorYellow) + WriteIf(HopBich, "\n"  + "   - Chu y: Co tin hieu giao cat giua Tenkan Sen va Kijun Sen:" + 
	EncodeColor(colorLime) + "  Gia van trong xu the Tang, Co the gia tang them vi the Mua (Long): " +TL+ "", "")
	
	                         
		

 //|============================================================================================|
//|                                       Hien thi Tin hieu canh bao  VSA                                   |
//|============================================================================================|

  /*
strength	= sc OR tbc2a OR tbc2 or effortDownfail OR 	strengthDown OR strengthDown1 OR strengthDown2 OR 
              strengthDown0 OR bullBar OR effortUp OR upBar  OR revUpThrust ;

weakness	= bc or upThrustBartrue OR upThrustCond1 OR upThrustCond2 OR upThrustCond3 OR PseudoUpThrust OR pseudoUtCond   
             OR tbc4 or effortUpfail or Sellcond OR  upThrustBar OR  effortDown  OR bearBar OR downBar ;

vsachange = trendChange OR lowVolTest or lowVolTest1 or lowVolTest2 or buyCond  OR noSupplyBar or stopVolume or noDemandBarDt OR noDemandBarUt 
           or topRevBar OR Fom1 OR tbc3 OR tbc5  ;

*/ 


//1. Tin hieu canh bao xuat hien Diem Yeu

 +WriteIf(weakness OR strength OR vsachange,EncodeColor(colorLime)+"\n ------------------------------------------------------------------- \n " 
                                         +EncodeColor(colorBlue) +"   - Canh bao VSA:  ","")+

EncodeColor(colorRed)+

WriteIf (bc,"\n +Buying Climax - Cao trao Mua tiem nang. ","")+
WriteIf (upThrustBartrue, "\n +Day la mot thanh Upthrust thuc su. Dau hieu Diem Yeu kha chac chan. ","")+
WriteIf (upThrustBar OR upThrustCond1 OR upThrustCond2 OR upThrustCond3, "\n  +Day la mot thanh Upthrust. Mot dau hieu cua Diem Yeu. ","")+
WriteIf (PseudoUpThrust, "\n +Psuedo UpThrust - Upthrust gia tao (co khoi luong thap hon 2 thanh truoc no). Dau hieu cua Diem Yeu. ","")+
WriteIf (pseudoUtCond AND NOT PseudoUpThrust, "\n +Mot thanh gia giam co gia dong cua o muc thap, di sau mot thanh Pseudo Upthrust. Xac nhan cua Diem Yeu. ","")+
WriteIf (effortUpfail, "\n +No luc tang gia that bai (Effort to Move up has failed). Tin hieu giam gia. ","")+
WriteIf (Sellcond, "\n +Xu huong TANG co kha nang se KET THUC va som bat dau mot xu huong GIAM. ","")+
WriteIf (effortDown, "\n  +No luc day gia GIAM (Effort to Fall). Dau hieu cua Diem Yeu.  ","")+
WriteIf (tbc4, "\n +Hai thanh gia dao chieu giam gia (Nhan chim giam) voi khoi luong cao hon. Dau hieu cua Diem Yeu", "")+

//2. Tin hieu canh bao xuat hien Diem Manh


EncodeColor(colorCustom9)+

WriteIf (sc, "\n +Sell Climax - Cao trao BAN. Dau hieu cua Diem Manh."
            +"\n Neu co Khoi luong cao se ho tro cho Diem Manh nay. ","")+
WriteIf (tbc2a , "\n +Hai thanh gia giong voi 2 thanh dao chieu tang voi Khoi luong cao hon. Dau hieu cua Diem Manh. ", "")+
WriteIf (tbc2 AND NOT tbc2a, "\n +Hai thanh gia dao chieu tang (Nhan chim tang) voi Khoi luong cao hon. Dau hieu cua Diem Manh. ", "")+
WriteIf (effortDownfail, "\n +No luc day gia xuong that bai (Effort to Move Down has failed). Dau hieu cua Diem Manh.  ","")+
WriteIf (strengthDown OR strengthDown0 OR strengthDown1 OR strengthDown2 , "\n +Diem Manh xuat hien tro lai sau mot xu huong giam. Neu co Khoi luong cao se ho tro cho Diem Manh nay. ","")+
WriteIf (effortUp, "\n +Mot no luc day gia tang (Effort to Rise) . Dau hieu cua Diem Manh.  ","")+
WriteIf (revUpThrust, "\n +Thanh gia Upthrust dao nguoc. Dau hieu cua Diem Manh. ","")+


//3. Tin hieu canh bao dau hieu dao chieu xu huong truoc do 


EncodeColor(colorYellow)+

WriteIf (trendChange, "\n +Mot thanh gia GIAM voi Khoi luong cao sau mot dot tang gia. Dau hieu cua Diem Yeu. ","")+
WriteIf (topRevBar, "\n +Top Reversal - Dao chieu giam o dinh. Dau hieu cua Diem Yeu. ","")+
WriteIf (noDemandBarDt OR  noDemandBarUt, "\n +No Demand - Khong co Cau. Xu huong tang co the thay doi.  ","")+
WriteIf (Fom1, "\n +Khoi luong CAO nhung gia lai khong di chuyen nhieu. Co the dang gap Vung Khang cu/Ho tro manh - vung Cung/Cau manh me. ","")+
WriteIf (tbc3 AND NOT Fom1 , "\n +Hai thanh gia dao chieu nhau (Nhan chim) voi Khoi luong thap. ", "")+
WriteIf (tbc5 AND NOT tbc3, "\n +Hai thanh gia giong voi 2 thanh dao chieu nhau (Nhan chim) voi Khoi luong thap. ", "")+
WriteIf (buyCond, "\n +Xu huong GIAM co kha nang se KET THUC va som BAT DAU mot xu huong TANG.  ","")+
WriteIf (lowVolTest or lowVolTest1 OR lowVolTest2, "\n +Test for supply - Kiem dinh nguon cung thanh cong. Dau hieu cua Diem Manh. ","")+
WriteIf (noSupplyBar, "\n +No Supply - Khong co nguon cung. Dau hieu cua Diem Manh. ","")+
WriteIf (stopVolume, "\n +Stopping volume - Khoi luong dung giam. Bao hieu xu huong giam sap ket thuc. ","")



//====================================================================================|
//                       Hien thi Phan dien giai VSA                                       |
//====================================================================================|


 +WriteIf(weakness OR strength OR vsachange,EncodeColor(colorLime)+"\n ------------------------------------------------------------------- \n " 
                 +EncodeColor(colorBlue) +"  - Dien giai VSA:","")+

//1. Dien giai VSA Canh bao Xu huong giam
EncodeColor(colorRed) +

WriteIf(upThrustBartrue , "\n +Upthrust Bar- xuat hien de quet Stoploss (mua dung lo) cua nha dau tu nho le"+
    "\n +Smartmoney co gang danh lua nho le cang nhieu cang tot. " +  
	"\n +Chung thuong xuat hien sau dau hieu Diem Yeu trong nen gia."+
	"\n +Smart money biet rang thi truong dang yeu di (giam gia). " +
	"\n +Vi the, Ho gia vo day gia len de quet stoploss cac lenh Ban khong (Short Sell). " +
	"\n +Lam cho cac Trader hoang loan, buoc phai cat lo lenh Short sell (Cover - mua lai so hang da ban) " +
	"\n +Hoac danh lua nha dau tu phai mua len trong khi thi truong dang yeu di."+
	"\n +Tao ra thanh khoan de Smart Money ban xuong.","")+ 

WriteIf(upThrustBar OR upThrustCond1 OR upThrustCond2 OR upThrustCond3 AND NOT upThrustBartrue , "\n +Upthrust Bar. Dau hieu cua Diem Yeu. "+
     "\n +Luu y: Thanh Upthrust Bar la thanh nen co bien dong cao " +
	"\n +Thanh gia giam nay thuong xuat hien ngay sau bat ky thanh Upthrust nao truoc do. "+
	"\n +Dau hieu cua Diem Yeu."+ 
	"\n +Smartmoney dang khien nho le bi kep hang ngay tren dinh. "+
	"\n +Voi su xuat hien cua thanh Upthrust." +
	"\n +Ban can phai can trong den lenh Mua va lenh Stoploss cua minh."+ 
	"\n +Sau nhieu phien Upthrust lien tiep, ban can tim kiem cac dau hieu cua viec kiem dinh lai 'test.","")+ 	

WriteIf(PseudoUpThrust,"\n +PseudoUpThrust - Day la Upthrust gia tao. "+
    "\n +No thuong xuat hien sau mot thanh gia tang co khoi luong tren trung binh. " +
	"\n +Trong kha giong thanh upthrust nhung co gia dong cua gan muc thap. "+
	"\n +Nhung khoi luong thuong thap hon muc trung binh. "+
	"\n +Day la dau hieu cua Diem Yeu. Neu kem khoi luong cao thi Diem Yeu cang manh hon" + 
	"\n +Smart Money dang co gang bay nho le vao cac vi the xau. ","")+	

WriteIf(pseudoUtCond AND NOT PseudoUpThrust, "\n +PseudoUpThrust - Mot thanh gia giam sau thanh Upthrust gia tao."+
    "\n +Day la su xac nhan Diem Yeu. Neu khoi luong cao hon muc trung binh thi Diem Yeu cang manh hon. ","")+	
	
WriteIf(tbc4, "\n +Dau hieu cua Diem Yeu","")+
 
WriteIf(bc, "\n +Buying Climax - Cao trao Mua tiem nang."+
            "\n +Chu y: No co the la dau hieu cua Diem Yeu neu o cuoi mot xu huong tang da keo dai truoc do"+
            "\n +Neu xuat hien o vung khang cu thi day la luc Mua hap thu cua phien Breakout. La Diem Manh.","") +
      
WriteIf(effortUpfail, "\n +No luc tang gia that bai. Dau hieu cua Diem Yeu. ","") + 
    
WriteIf(Sellcond, "\n +Tin hieu Ban. ","") + 
  
WriteIf(effortDown, "\n +No luc day gia GIAM. Dau hieu cua Diem Yeu. "
                    + "\n +Mot thanh gia cho thay su no luc day gia giam. "
                    + "\n +No thuong duoc nhin thay o dau chu ky giam gia.","") + 
                  

//2. Dien giai VSA Canh bao Xu huong tang

	
EncodeColor(colorCustom9) +

WriteIf(sc,"\n +Selling Climax - Cao trao BAN tiem nang. "
                   +"\n +Chu y: Hay xem xet tung tinh huong de danh gia chinh xac cay nen nay"
                   +"\n +Neu no xuat hien o cuoi xu huong Giam keo dai truoc do thi day la dau hieu Diem Manh"
                   +"\n +Neu no xuat hien khi pha vo vung ho tro thi day la dau hieu Suy Yeu ","")+

WriteIf(tbc2a OR tbc2 ,"\n +Hai thanh gia dao chieu nhau. Dau hieu cua Diem Manh ","")+
                            
            
WriteIf(effortDownfail,"\n +No luc Giam gia that bai. Dau hieu cua Diem Manh ","")+ 
                                      
WriteIf(strengthDown OR strengthDown0 OR strengthDown1 OR strengthDown2, "\n +Strength Bar - Thanh gia tang manh. Thi truong dang trong xu huong giam truoc do. " 
	+"\n +Neu xuat hien mot thanh gia tang voi khoi luong cao hon."
	+"\n +Co muc gia dong cua gan muc cao nhat, bao hieu Cau dang manh tro lai. "
	+"\n +Xu huong giam co the som dung lai va dao chieu tang. "
	+"\n +La dau hieu cho thay thi truong dang manh hon. ","")+

                   
WriteIf(effortUp ,"\n +No luc day Gia TANG. Dau hieu cua Diem Manh. "
                   + "\n +Mot thanh gia cho thay su no luc day gia tang."
                   +"\n +Day la dau hieu bat dau cua thi truong con Bo. " 
	               + "\n +Nhung dau hieu nay thuong duoc nhin thay o dau chu ky tang gia."
	               + "\n +Cho thay Smart money dang rat no luc de day gia tang len muc cao nhat","") + 
	                                      
WriteIf(revUpThrust ,"\n +Thanh Upthrust dao nguoc. Dau hieu cua Diem Manh. ","")+
            
                   
                   
//3.  Dien giai VSA Canh bao dau hieu dao chieu xu huong

                 
EncodeColor(colorYellow) +

WriteIf(trendChange,"\n   - Chu y: Co tin hieu Dao chieu xu huong." 
                                              + "\n +Trong xu huong tang gia truoc do. Thanh gia hien tai la mot thanh gia giam voi khoi luong cao."
                                              +"\n +Dau hieu cua Diem Yeu, co the ket thuc qua trinh tang gia","")+

WriteIf(lowVolTest OR lowVolTest1 OR lowVolTest2 ,"\n +Test of supply - Tin hieu test Cung thanh cong."
                                                 + "\n +Thanh gia truoc do cho thay su kiem dinh nguon cung thanh cong khi luc ban co Volume thap . "
                                                 + "\n +Thanh gia hien tai la mot thanh tang gia voi khoi luong cao. Day la su xac nhan cua Diem Manh","")+


WriteIf(buyCond,"\n +Tin hieu Mua - Thanh gia truoc do da cho thay Suc manh dang quay tro lai."
               + "\n +Day la thanh gia xac nhan cho Diem Manh. ","")+

WriteIf(noSupplyBar,"\n   - Chu y: Co tin hieu Dao chieu xu huong." 
                    + "\n +Thanh gia khong co nguon cung - No Supply. Cho biet nguon cung ban ra da can kiet."
                    + "\n +Smart money dang chuan bi day gia len. Tot nhat nen cho su xac nhan o cac thanh gia tiep theo ","")+


WriteIf(stopVolume,"\n   - Chu y: Co tin hieu Dao chieu xu huong." 
                   + "\n +Stopping Volume - Khoi luong dung."
                   +"\n +Trong xu huong giam xuat hien mot thanh giam gia co muc gia dong cua o gan dinh tren, kem khoi luong cao. " 
	               + "\n +No cho biet Smartmoney dang co gang hap thu nguon cung ban ra. "
	               +"\n +Day la dau hieu cho thay nguoi Mua dang quay tro lai. " 
	               + "\n +Chung ta co the mong doi mot su dao chieu tang gia tro lai. ","")+



WriteIf(noDemandBarUt OR  noDemandBarDt,"\n   - Chu y: Co tin hieu Dao chieu xu huong." 
                     + "\n +No Demand - Khong co nhu cau. "
                     +"\n +Thanh gia tang co muc gia dong cua o giua hoac muc thap, khoi luong thap hon 2 thanh gia truoc do"
                     +"\n +Day la dau hieu cua Diem Yeu tiem nang. " 
	                 + "\n   - Luu y:  \n Neu thi truong van con manh, ban se nhin thay dau hieu cua Diem Manh sau do."
	                 +"\n +Thuong duoc bieu hien bang viec gia giam voi khoi luong thap"
	                 +"\n +Di kem chenh lech gia nho, co muc gia dong cua o phan tren cay nen .","")+


WriteIf(topRevBar,"\n   - Chu y: Co tin hieu Dao chieu xu huong." 
                     + "\n +Tin hieu dao chieu o Dinh xu huong tang (Nen nhan chim). ","")+
              	 

WriteIf(Fom1 OR tbc3 OR tbc5 ,"\n   - Chu y: Co tin hieu Dao chieu xu huong." ,"")
                 


);


}


_SECTION_END();


//|============================================================================================|
//|                  END TITLE - TIEU DE 2 (Them dien giai VSA)                                    |
//|============================================================================================|
listnum = 12; // we use watchlist 10 for storing results
// erase the watchlist when we process very first symbol
if ( Status( "stocknum" ) == 0 )
{
// retrieve watchlist members
oldlist = CategoryGetSymbols( categoryWatchlist, listnum );
// iterate through the list and remove tickers
for ( i = 0; ( sym = StrExtract( oldlist, i ) ) != ""; i++ )
{
CategoryRemoveSymbol( sym, categoryWatchlist, listnum );
}
}
// check how many times Filter variable was true in the tested range
// if non-zero value detected, add current symbol to a watchlist
if ( LastValue( Cum( Filter AND Status( "barinrange" ) ) ) )
CategoryAddSymbol( "", categoryWatchlist, listnum );
